/*
 * USANPN-Visualization-Tool
 * Version: 1.0.0 - 2020-11-18
 */

angular.module("npn-viz-tool.vis-activity",["npn-viz-tool.vis","npn-viz-tool.filter","npn-viz-tool.filters","npn-viz-tool.settings","ui.bootstrap"]).factory("ActivityCurve",["$log","$filter","FilterService",function(p,e,c){var r=e("doy"),t=e("number"),n=e("speciesTitle"),a=function(e){return t(e,2)},e=[{id:"num_yes_records",sampleSize:"status_records_sample_size",label:"Total Yes Records",description:'The total number of reported "yes" (presence) records for the species and phenophase within the selected time period.'},{id:"proportion_yes_records",sampleSize:"status_records_sample_size",label:"Proportion Yes Records",description:'The number of "yes" (presence) records divided by the total number of records (presence and absence) for the species and phenophase within the selected time period.',valueFormat:a,proportion:!0}],d={Plantae:e.concat([{id:"proportion_individuals_with_yes_record",sampleSize:"individuals_sample_size",label:"Proportion Individuals with Yes Records",description:'The proportion of observed plant individuals of the species that have at least one "yes" record for the phenophase within the selected time period.',valueFormat:a,proportion:!0}]),Animalia:e.concat([{id:"proportion_sites_with_yes_record",sampleSize:"sites_sample_size",label:"Proportion Sites with Yes Records",description:'The proportion of observed sites that have at least one "yes" record for the species and phenophase within the selected time period.',valueFormat:a,proportion:!0},{id:"total_numanimals_in-phase",sampleSize:"in-phase_site_visits_sample_size",label:"Total Animals In Phase",description:"The sum of reported animal abundance for each site visit for the species and phenophase within the selected time period."},{id:"mean_numanimals_in-phase",sampleSize:"in-phase_per_hr_sites_sample_size",label:"Mean Animals In Phase",description:"The mean of reported animal abundance at each site visit for the species and phenophase within the selected time period.",valueFormat:a},{id:"mean_numanimals_in-phase_per_hr",sampleSize:"in-phase_per_hr_sites_sample_size",label:"Animals In Phase per Hour",description:'The mean of reported animal abundance corrected by the time spent searching for animals at each site visit for the species and phenophase within the selected time period. Site visits with a search method of "Incidental" or where no search time or method were reported are excluded.',valueFormat:a},{id:"mean_numanimals_in-phase_per_hr_per_acre",sampleSize:"phase_per_hr_per_acre_sites_sample_size",label:"Animals In Phase per Hour per Acre",description:'The mean of reported animal abundance corrected by the time spent searching and search area for animals at each site visit for the species and phenophase within the selected time period. Sites with no size reported and site visits with a search method other than "Area Search" or where no search time were reported are excluded.',valueFormat:a}])},a=function(e){var t,n,r,a,i,o,s=this;function l(){delete s.$data,delete s.$metricData}s.id=e,Object.defineProperty(this,"validPhenophases",{get:function(){return i}}),Object.defineProperty(this,"validMetrics",{get:function(){return o}}),Object.defineProperty(this,"year",{enumerable:!0,get:function(){return n},set:function(e){l(),n=e,t&&c.getFilter().getPhenophasesForSpecies(t.species_id,!0,[n]).then(function(e){i=e,s.phenophase=i.length?i[0]:void 0})}}),Object.defineProperty(this,"phenophase",{enumerable:!0,get:function(){return r},set:function(e){l(),r=e}}),Object.defineProperty(this,"metric",{enumerable:!0,get:function(){return a},set:function(e){l(),a=e}}),Object.defineProperty(this,"species",{enumerable:!0,get:function(){return t},set:function(e){l(),o=(t=e)&&t.kingdom&&d[t.kingdom]||[],s.metric&&-1===o.indexOf(s.metric)&&delete s.metric,o.length&&!s.metric&&(s.metric=o[0]),i=void 0,t&&c.getFilter().getPhenophasesForSpecies(t.species_id,!0,[n]).then(function(e){i=e,s.phenophase=i.length?i[0]:void 0})}})};return a.prototype.axisLabel=function(){return this.metric?this.metric.label:"?"},a.prototype.doyDataValue=function(){var e,t,n,r=this,a=r.data();if(r.doyFocus&&a)for(n=0;n<a.length;n++)if(t=a[n],r.doyFocus>=t.start_doy&&r.doyFocus<=t.end_doy)return e=(r.metric.valueFormat||angular.identity)(t[r.metric.id]),-9999!==t[r.metric.sampleSize]&&(e+=" N:"+t[r.metric.sampleSize]),e},a.prototype.legendLabel=function(e){var t=this.doyDataValue();return this.year+": "+n(this.species)+" - "+this.phenophase.phenophase_name+(e?" ("+this.metric.label+")":"")+(void 0!==t?" ["+t+"]":"")},a.prototype.metricId=function(){return this.metric?this.metric.id:void 0},a.prototype.data=function(e){if(arguments.length)return delete this.$data,delete this.$metricData,e&&(e.forEach(function(e){e.start_doy=r(e.start_date),e.end_doy=r(e.end_date)}),e.sort(function(e,t){return e.start_doy-t.start_doy}),this.$data=e),this;var t=this,n=t.$data;return n&&t.metric&&(t.$metricData?n=t.$metricData:(t.metric.sampleSize||p.warn("Metric does not define a sampleSize property, cannot filter out invalid data points."),(n=n.filter(function(e){return(!t.metric.sampleSize||-9999!==e[t.metric.sampleSize])&&-9999!==e[t.metric.id]})).length!==t.$data.length&&p.debug("filtered out "+(t.$data.length-n.length)+"/"+t.$data.length+" of -9999 records for metric ",t.metric),t.$metricData=n)),n},a.prototype.color=function(e){return arguments.length?(this.$color=e,this):this.$color},a.prototype.axisOrient=function(e){return arguments.length?(this.$orient=e,this):this.$orient},a.prototype.axis=function(){var e=this.y(),t=e.ticks(),n=d3.svg.axis().scale(e);return t.length&&(t[t.length-1]=e.domain()[1],n.tickValues(t)),n.orient(this.axisOrient()||"left")},a.prototype.x=function(e){return arguments.length?(this.$$x=e,this):this.$$x},a.prototype.y=function(e){return arguments.length?(this.$$y=e,this):this.$$y},a.prototype.isValid=function(){return this.species&&this.phenophase&&this.year&&this.metric},a.prototype.plotted=function(){return this.isValid()&&this.data()},a.prototype.shouldRevisualize=function(){return this.isValid()&&!this.data()},a.prototype.domain=function(){var t=this,e=t.data();if(e&&t.metric)return 0<(e=d3.extent(e,function(e){return e[t.metric.id]}))[0]?e[0]=0:e[0]<0&&p.warn("negative domain start for metric",e,t.metric),e},a.prototype.draw=function(n){var r,t,e,a,i,o=this,s=o.data(),l=[[]];if(n.selectAll("path.curve.curve-"+o.id).remove(),n.selectAll("circle.curve-point.curve-point-"+o.id).remove(),s&&s.length){for(e=0;e<s.length;e++)a=s[e],i=e+1<s.length?s[e+1]:void 0,l[l.length-1].push(a),i&&i.start_doy!==a.end_doy+1&&l.push([]);r=o.x(),t=o.y();function c(e,t){return r(e.start_doy+Math.round((e.end_doy-e.start_doy)/2))}function d(e){return t(e[o.metric.id])}var u=d3.svg.line().interpolate(o.interpolate||"monotone").x(c).y(d);p.debug("ActivityCurve.draw",o.species,o.phenophase,o.year,o.metric,o.domain(),t.domain()),p.debug("draw.datas",l),l.forEach(function(e,t){1!==e.length&&!o.dataPoints||e.forEach(function(e){n.append("circle").attr("class","curve-point curve-point-"+o.id).attr("r",3).attr("fill",o.color()).attr("cx",c(e)).attr("cy",d(e))}),1<e.length&&n.append("path").attr("class","curve curve-"+o.id).attr("fill","none").attr("stroke",o.color()).attr("stroke-linejoin","round").attr("stroke-linecap","round").attr("stroke-width",1.5).attr("d",u(e))})}},a}]).controller("ActivityCurvesVisCtrl",["$scope","$q","$uibModalInstance","$timeout","$log","$filter","ActivityCurve","FilterService","ChartService",function(a,i,e,t,o,s,n,r,l){function c(){0<a.selection.$updateCount&&!a.selection.shouldRevisualize()&&a.selection.$updateCount++}a.modal=e,a.frequencies=[{value:"months",label:"Monthly"},{value:14,label:"Bi-weekly"},{value:7,label:"Weekly"}],a.selection={$updateCount:0,interpolate:"monotone",dataPoints:!0,curves:[{color:"#0000ff",orient:"left"},{color:"orange",orient:"right"}].map(function(e,t){return new n(t).color(e.color).axisOrient(e.orient)}),frequency:a.frequencies[0],shouldRevisualize:function(){return a.selection.curves.reduce(function(e,t){return e||t.shouldRevisualize()},!1)}},a.$watch(function(){return a.selection.shouldRevisualize()},function(e){e&&a.visualize()}),a.$watch("selection.frequency",function(e){a.selection.curves.forEach(function(e){e.data(null)})}),a.$watch("selection.interpolate",function(t){a.selection.curves.forEach(function(e){t?e.interpolate=t:delete e.interpolate,c()})}),a.$watch("selection.dataPoints",function(t){a.selection.curves.forEach(function(e){e.dataPoints=t}),c()}),a.$watch("selection.curves[0].metric",c),a.$watch("selection.curves[1].metric",c),a.visualize=function(){var e=a.selection.curves.filter(function(e){return e.data(null).isValid()}).map(function(t){var e,n,r=i.defer(),e={request_src:"npn-vis-activity-curves",start_date:t.year+"-01-01",end_date:(e=t.year,n=new Date,e===n.getFullYear()?s("date")(n,"yyyy-MM-dd"):e+"-12-31"),frequency:a.selection.frequency.value,"species_id[0]":t.species.species_id,"phenophase_id[0]":t.phenophase.phenophase_id};return o.debug("params",e),a.working=!0,l.getMagnitudeData(e,function(e){r.resolve(t.data(e))}),r.promise});i.all(e).then(function(){o.debug("all activity data has arrived"),a.selection.$updateCount++,delete a.working})}}]).directive("activityCurveControl",["$log","FilterService",function(n,e){return{restrict:"E",templateUrl:"js/activity/curve-control.html",scope:{input:"="},link:function(t){t.validYears=function(e){for(var t=(new Date).getFullYear(),n=[];e<=t;)n.push(e++);return n}(2010),t.input.year=t.validYears[t.validYears.length-2],e.getFilter().getSpeciesList().then(function(e){n.debug("speciesList",e),(t.speciesList=e).length&&0===t.input.id&&(t.input.species=t.input.id<e.length?e[t.input.id]:e[0])})}}}]).directive("activityCurvesChart",["$log","$timeout","$filter","ChartService",function(g,r,e,f){function t(e){for(var t=1,n=[];t<=365;)n.push(t),t+=e;return n}var h={7:{rotate:45,values:t(14)},14:{rotate:45,values:t(28)},months:{values:[1,32,60,91,121,152,182,213,244,274,305,335]}},m=new Date(2010,0),v=e("legendDoy");return{restrict:"E",replace:!0,template:'<div class="chart-container"><vis-download ng-if="selection.$updateCount > 0" selector=".chart" filename="npn-activity-curves.png"></vis-download><div><svg class="chart"></svg></div></div>',scope:{selection:"="},link:function(e){function a(){return d3.scale.linear().range([l.height,0]).domain([0,100])}var i,o=e.selection,s=14,l=f.getSizeInfo({top:80,left:80,right:80,bottom:80}),t=d3.time.format("%m/%d"),c=d3.scale.linear().range([0,l.width]).domain([1,365]),d=d3.svg.axis().scale(c).orient("bottom").tickFormat(function(e){e=(e-1)*f.ONE_DAY_MILLIS+m.getTime(),e=new Date(e);return t(e)});function u(){if(!o.curves[1].isValid()||o.curves[0].metricId()===o.curves[1].metricId())return o.curves[0].metric}function n(){function t(e,t){return e&&2===e.length&&(e=[e[0],1.05*e[1]],t&&t.proportion&&1<e[1]&&(e[1]=1)),e}i.selectAll("g .axis").remove();var n,e=u();e?(r=d3.extent(o.curves.reduce(function(e,t){return t.isValid()&&(e=e.concat(t.domain())),e},[])),n=a().domain(t(r,e)),g.debug("ActivityCurves.common domain",r),o.curves.forEach(function(e){e.y(n)})):o.curves.forEach(function(e){e.isValid()&&e.y(a().domain(t(e.domain(),e.metric)))}),i.append("g").attr("class","y axis left").call(o.curves[0].axis()).append("text").attr("class","axis-title").attr("transform","rotate(-90)").attr("y","0").attr("dy","-4em").attr("x",l.height/2*-1).style("text-anchor","middle").text(o.curves[0].axisLabel()),e||i.append("g").attr("class","y axis right").attr("transform","translate("+l.width+")").call(o.curves[1].axis()).append("text").attr("class","axis-title").attr("transform","rotate(-90)").attr("y","0").attr("dy","4em").attr("x",l.height/2*-1).style("text-anchor","middle").text(o.curves[1].axisLabel());var r=h[o.frequency.value];d.tickValues(r.values),i.append("g").attr("class","x axis").attr("transform","translate(0,"+l.height+")").call(d).append("text").attr("y","0").attr("dy","3em").attr("x",l.width/2).attr("class","axis-label").style("text-anchor","middle").text("Date"),r.rotate&&(i.selectAll("g.x.axis g.tick text").style("text-anchor","end").attr("transform","rotate(-"+r.rotate+")"),i.selectAll("g.x.axis .axis-label").attr("dy","4em")),i.selectAll(".axis path").style("fill","none").style("stroke","#000").style("shape-rendering","crispEdges"),i.selectAll(".axis line").style("fill","none").style("stroke","#000").style("shape-rendering","crispEdges"),i.selectAll("text").style("font-family","Arial"),i.selectAll("g .x.axis text").style("font-size",s+"px"),i.selectAll("g .y.axis text").style("font-size",s+"px"),e||(i.selectAll("g.y.axis.left g.tick text").style("fill",o.curves[0].color()),i.selectAll("g.y.axis.left text.axis-title").style("fill",o.curves[0].color()),i.selectAll("g.y.axis.right g.tick text").style("fill",o.curves[1].color()),i.selectAll("g.y.axis.right text.axis-title").style("fill",o.curves[1].color())),o.curves.forEach(function(e){e.draw(i)}),p()}function p(){i.select(".legend").remove();var r=u(),a=i.append("g").attr("class","legend").attr("transform","translate(150,-"+(l.margin.top-10)+")").style("font-size","1em");o.curves.reduce(function(e,t){var n;return t.plotted()&&((n=a.append("g").attr("class","legend-item curve-"+t.id).attr("transform","translate(10,"+((e+1)*s+4*e)+")")).append("circle").attr("r",5).attr("fill",t.color()),n.append("text").style("font-size",s+"px").attr("x",10).attr("y",2.5).text(t.legendLabel(!r)),e++),e},0)}o.curves.forEach(function(e){e.x(c).y(a())}),r(function(){var e=d3.select(".chart").attr("width",l.width+l.margin.left+l.margin.right).attr("height",l.height+l.margin.top+l.margin.bottom);e.append("g").append("rect").attr("width","100%").attr("height","100%").attr("fill","#fff"),(i=e.append("g").attr("transform","translate("+l.margin.left+","+l.margin.top+")")).append("g").attr("class","chart-title").append("text").attr("y","0").attr("dy","-3em").attr("x","0").style("text-anchor","start").style("font-size","18px").text("Activity Curves"),e.append("g").append("text").attr("dx",5).attr("dy",l.height+136).attr("font-size","11px").attr("font-style","italic").attr("text-anchor","right").text("USA National Phenology Network, www.usanpn.org"),n();var t=e.append("g").attr("transform","translate("+l.margin.left+","+l.margin.top+")").style("display","none"),r=t.append("line").attr("class","focus").attr("fill","none").attr("stroke","green").attr("stroke-width",1).attr("x1",0).attr("y1",0).attr("x2",0).attr("y2",l.height),a=t.append("text").attr("class","focus-doy").attr("y",10).attr("x",0).text("hover doy");e.append("rect").attr("class","overlay").attr("transform","translate("+l.margin.left+","+l.margin.top+")").style("fill","none").style("pointer-events","all").attr("x",0).attr("y",0).attr("width",l.width).attr("height",l.height).on("mouseover",function(){o.curves.reduce(function(e,t){return e||t.plotted()},!1)&&t.style("display",null)}).on("mouseout",function(){o.curves.forEach(function(e){delete e.doyFocus}),t.style("display","none"),p()}).on("mousemove",function(){var e=(t=d3.mouse(this))[0],n=(t[1],Math.round(c.invert(e))),t=o.curves.reduce(function(e,t){return!e&&t.plotted()&&(e=t.data().reduce(function(e,t){return e||(n>=t.start_doy&&n<=t.end_doy?t:void 0)},void 0)),e},void 0);r.attr("transform","translate("+e+")"),a.style("text-anchor",n<324?"start":"end").attr("x",e+10*(n<324?1:-1)).text(t?v(t.start_doy)+" - "+v(t.end_doy):v(n)),o.curves.forEach(function(e){e.doyFocus=n}),p()})}),e.$watch("selection.$updateCount",function(e){0<e&&n()})}}}]),angular.module("npn-viz-tool.bounds",["npn-viz-tool.filter","uiGmapgoogle-maps"]).service("RestrictedBoundsService",["$log","$location","uiGmapGoogleMapApi",function(a,e,t){var i=e.search().allowedBounds,n={},e={getRestrictor:function(e,t){return n[e]||(n[e]=new r(e)),n[e].setBounds(t),n[e]}},r=function(e){this.key=e;var r=this;r.center_changed=function(e,t,n){a.debug("["+r.key+"].center_changed"),r.bounds?(i&&!r.rectangle&&(r.rectangle=new google.maps.Rectangle({strokeColor:"#FFF",strokeOpacity:.8,strokeWeight:2,fillColor:"#FFF",fillOpacity:.35,map:e,bounds:r.bounds})),r.bounds.contains(e.getCenter())?r.lastValidCenter=e.getCenter():(a.debug("["+r.key+"] attempted to pan center out of bounds, panning back to ",r.lastValidCenter),e.panTo(r.lastValidCenter))):a.debug("["+r.key+"] no bounds set ignoring.")}};return r.prototype.setBounds=function(e){a.debug("["+this.key+"].setBounds:",e),this.bounds=e,this.lastValidCenter=e?e.getCenter():void 0,this.rectangle&&this.rectangle.setMap(null),this.rectangle=void 0},r.prototype.getBounds=function(){return this.bounds},e}]).directive("boundsManager",["$rootScope","$log","uiGmapGoogleMapApi","FilterService","BoundsFilterArg",function(e,n,r,o,s){return{restrict:"E",template:'<ui-gmap-drawing-manager ng-if="!isFilterEmpty()" options="options" control="control"></ui-gmap-drawing-manager>',controller:["$scope",function(t){function i(){o.getFilter().hasSufficientCriteria()&&e.$broadcast("filter-rerun-phase2",{})}t.isFilterEmpty=o.isFilterEmpty,r.then(function(e){var r=e,a={drawingModes:[r.drawing.OverlayType.RECTANGLE],position:r.ControlPosition.TOP_RIGHT,drawingControl:!1};n.debug("api",e),t.options={drawingControlOptions:a,rectangleOptions:s.RECTANGLE_OPTIONS},t.control={},t.$on("bounds-filter-ready",function(e,t){r.event.addListener(t.filter.arg,"mouseover",function(){t.filter.arg.setOptions(angular.extend({},s.RECTANGLE_OPTIONS,{strokeWeight:2}))}),r.event.addListener(t.filter.arg,"mouseout",function(){t.filter.arg.setOptions(s.RECTANGLE_OPTIONS)}),r.event.addListener(t.filter.arg,"rightclick",function(){o.removeFromFilter(t.filter),i()})}),t.$watch("control.getDrawingManager",function(){var n;t.control.getDrawingManager&&(n=t.control.getDrawingManager(),r.event.addListener(n,"rectanglecomplete",function(e){n.setDrawingMode(null),o.addToFilter(new s(e)),i()}),t.$on("filter-reset",function(e,t){a.drawingControl=!1,n.setOptions(a)}),t.$on("filter-update",function(e,t){a.drawingControl=o.hasSufficientCriteria(),n.setOptions(a)}))})})}]}}]),angular.module("npn-viz-tool.vis-cache",["angular-md5"]).factory("CacheService",["$log","$timeout","md5",function(a,i,t){var o=[];return{keyFromObject:function(e){return t.createHash(JSON.stringify(e))},dump:function(){a.debug("cache",o)},put:function(e,t){if(null!=e){if(null==t)return a.debug("removing cached object '"+e+"'",o[e]),void(o[e]=null);var n=2<arguments.length?arguments[2]:3e5,r=n<0?-1:(new Date).getTime()+n;a.debug("caching (expiry:"+r+") '"+e+"'",t),o[e]={data:t,expiry:r},0<n&&i(function(){a.debug("expiring cached object '"+e+"'",o[e]),o[e]=null},n)}},get:function(e){var t=o[e];return null==t?1<arguments.length?arguments[1]:null:t.expiry<0||t.expiry>(new Date).getTime()?(a.debug("cache entry '"+e+"' is valid returning."),t.data):(a.debug("cache entry '"+e+"' has expired."),delete o[e],1<arguments.length?arguments[1]:null)}}}]),angular.module("npn-viz-tool.vis-calendar",["npn-viz-tool.vis","npn-viz-tool.filter","npn-viz-tool.filters","ui.bootstrap"]).controller("CalendarVisCtrl",["$scope","$uibModalInstance","$http","$timeout","$filter","$log","FilterService","ChartService",function(l,e,t,n,c,d,a,i){a.getFilter().getDateArg();var u,p,r,o=i.getSizeInfo({top:20,right:35,bottom:45,left:35}),s=d3.time.format("%B"),g=d3.scale.ordinal().rangeBands([0,o.width]).domain(d3.range(1,366)),f=d3.svg.axis().scale(g).orient("bottom").tickValues(function(){var e,t=[1],n=1;for(e=1;e<12;e++){var r=new Date(1900,e);r.setTime(r.getTime()-i.ONE_DAY_MILLIS),n+=r.getDate(),t.push(n)}return g.domain().filter(function(e){return-1!==t.indexOf(e)})}()).tickFormat(function(e){var t=new Date(1900,0);return t.setTime(t.getTime()+i.ONE_DAY_MILLIS*e),s(t)}),h=d3.scale.ordinal().rangeBands([o.height,0]).domain(d3.range(0,6)),m=d3.svg.axis().scale(h).orient("right").tickSize(o.width).tickFormat(function(e){return e}).tickFormat(function(e){return p&&p.labels&&e<p.labels.length?p.labels[e]:""});l.validYears=d3.range(1900,(new Date).getFullYear()+1),l.modal=e;e=a.getColorScale();function v(){d.debug("Calling phenophase list update"),l.phenophaseList=[];var e=l.selection.species.species_id,t=l.selection.year;e&&t&&(l.phenophaseList=[],a.getFilter().getPhenophasesForSpecies(e,!0,[t]).then(function(e){d.debug("phenophaseList",e),e.length&&(e.splice(0,0,{phenophase_id:-1,phenophase_name:"All phenophases"}),l.selection.phenophase=e.length?e[0]:void 0),l.phenophaseList=e}))}function y(e){d.debug("addToPlot",e),e&&(-1===e.phenophase_id?(d.debug("add all phenophases..."),function(e){for(;;){var t,n=-1;for(t=0;t<l.toPlot.length;t++)if(l.toPlot[t].species_id===e){n=t;break}if(-1===n)break;l.removeFromPlot(n)}}(e.species_id),l.phenophaseList.filter(function(e){return-1!==e.phenophase_id}).forEach(function(e){y(angular.extend(l.selection.species,e))})):(l.toPlot.push(b(e)),l.selection.color<l.colors.length?l.selection.color++:l.selection.color=0),l.data=p=void 0)}function b(e){e=e||angular.extend({},l.selection.species,l.selection.phenophase);return angular.extend({},e,{color:l.selection.color})}function w(){var e=d3.select(".chart");e.selectAll("g .y.axis line").style("stroke","#777").style("stroke-dasharray","2,2"),e.selectAll(".axis path").style("fill","none").style("stroke","#000").style("shape-rendering","crispEdges"),e.selectAll(".axis line").style("fill","none").style("stroke","#000").style("shape-rendering","crispEdges"),e.selectAll("text").style("font-family","Arial")}function x(e){var t=-1*(h.rangeBand()/2+l.yAxisConfig.labelOffset);e.selectAll("text").attr("x",0).attr("dy",t).attr("style","text-anchor: start; font-size: "+l.yAxisConfig.fontSize+"px;")}function k(e,t,n){return Number((e+t).toFixed(n))}l.colors=e.domain(),l.colorRange=e.range(),l.selection={color:0,year:(new Date).getFullYear(),netagive:!1},l.toPlotYears=[],l.toPlot=[],a.getFilter().getSpeciesList().then(function(e){d.debug("speciesList",e),(l.speciesList=e).length&&(l.selection.species=e[0])}),l.$watch("selection.species",v),l.$watch("selection.year",v),l.canAddToPlot=function(){if(!l.selection.species||!l.selection.phenophase)return!1;if(0===l.toPlot.length)return!0;for(var e=b(),t=0;t<l.toPlot.length;t++)if(angular.equals(l.toPlot[t],e))return!1;return!0},l.addToPlot=function(){y(b())},l.removeFromPlot=function(e){l.toPlot.splice(e,1),l.data=p=void 0},l.addYear=function(){l.selection.year&&(l.toPlotYears.push(l.selection.year),l.toPlotYears.sort(),l.data=p=void 0)},l.canAddYear=function(){return l.toPlotYears.length<2&&l.selection.year&&-1===l.toPlotYears.indexOf(l.selection.year)&&-1!==l.validYears.indexOf(l.selection.year)},l.removeYear=function(e){l.toPlotYears.splice(e,1),l.data=p=void 0},n(function(){var e=d3.select(".chart").attr("width",o.width+o.margin.left+o.margin.right).attr("height",o.height+o.margin.top+o.margin.bottom);e.append("g").append("rect").attr("width","100%").attr("height","100%").attr("fill","#fff"),(r=e.append("g").attr("transform","translate("+o.margin.left+","+o.margin.top+")")).append("g").attr("class","x axis").attr("transform","translate(0,"+o.height+")").call(f),r.append("g").attr("class","y axis").call(m).call(x),r.selectAll("g .x.axis text").attr("style","font-size: 14px"),r.selectAll("g .y.axis path").style("display","none"),e.append("g").append("text").attr("dx",5).attr("dy",o.height+61).attr("font-size","11px").attr("font-style","italic").attr("text-anchor","right").text("USA National Phenology Network, www.usanpn.org"),w()},500),l.yAxisConfig={labelOffset:4,bandPadding:.5,fontSize:14},l.$watch("yAxisConfig.labelOffset",S),l.$watch("yAxisConfig.bandPadding",S),l.$watch("yAxisConfig.fontSize",S),l.incrBandPadding=function(){l.yAxisConfig.bandPadding=k(l.yAxisConfig.bandPadding,.05,2)},l.decrBandPadding=function(){l.yAxisConfig.bandPadding=k(l.yAxisConfig.bandPadding,-.05,2)},l.incrFontSize=function(){l.yAxisConfig.fontSize++},l.decrFontSize=function(){l.yAxisConfig.fontSize--};var _="#aaa";function S(){var e,t,n;p&&(l.working=!0,g.rangeBands([0,o.width],-.1,.5),f.scale(g),r.selectAll("g .x.axis").call(f),h.rangeBands([o.height,0],l.yAxisConfig.bandPadding,.5),p&&p.labels&&h.domain(d3.range(0,p.labels.length)),m.scale(h),r&&r.selectAll("g .y.axis").call(m).call(x),(e=r.selectAll(".doy").data(p.data,function(e){return e.y+"-"+e.x+"-"+e.color})).exit().remove(),e.enter().insert("line",":first-child").attr("class","doy"),t=Math.ceil(g.rangeBand()/2),n=h.rangeBand()/2,e.attr("x1",function(e){return g(e.x)-t}).attr("y1",function(e,t){return h(e.y)+n}).attr("x2",function(e){return g(e.x)+t}).attr("y2",function(e,t){return h(e.y)+n}).attr("doy-point",function(e){return"("+e.x+","+e.y+")"}).attr("stroke",function(e){return e.color===_?_:l.colorRange[e.color]}).attr("stroke-width",h.rangeBand()).append("title").text(function(e){return e.x}),w(),l.working=!1)}function $(){if(u){if(u.error_message)return d.warn("Received error",u),l.error_message=u.error_message,void(l.working=!1);var a={},i={labels:[],data:[]},o=l.toPlot.length*l.toPlotYears.length-1;angular.forEach(u,function(e){a[e.species_id]=e;var t={};angular.forEach(e.phenophases,function(e){t[e.phenophase_id]=e}),e.phenophases=t}),d.debug("speciesMap",a),angular.forEach(l.toPlot,function(t){d.debug("toPlot",t);var n=a[t.species_id],r=n.phenophases[t.phenophase_id];angular.forEach(l.toPlotYears,function(e){r&&r.years&&r.years[e]&&(l.selection.negative&&(d.debug("year negative",o,e,n.common_name,r,r.years[e].negative),s(r.years[e].negative,_)),d.debug("year positive",o,e,n.common_name,r,r.years[e].positive),s(r.years[e].positive,t.color)),i.labels.splice(0,0,c("speciesTitle")(t)+"/"+t.phenophase_name+" ("+e+")"),d.debug("y of "+o+" is for "+i.labels[0]),o--})}),l.data=p=i,d.debug("calendar data",p),S()}function s(e,t){angular.forEach(e,function(e){i.data.push({y:o,x:e,color:t})})}}l.$watch("selection.negative",$),l.visualize=function(){if(p)return S();l.working=!0,d.debug("visualize",l.selection.axis,l.toPlot);a.getFilter().getDateArg();var n={request_src:"npn-vis-calendar"},r={};l.toPlotYears.forEach(function(e,t){n["year["+t+"]"]=e}),angular.forEach(l.toPlot,function(e,t){r[e.species_id+"."+e.phenophase_id]=e.color,n["species_id["+t+"]"]=e.species_id,n["phenophase_id["+t+"]"]=e.phenophase_id}),l.error_message=void 0,i.getObservationDates(n,function(e){u=e,$()})}}]),angular.module("npn-viz-tool.cluster",[]).factory("ClusterService",[function(){return{getDefaultClusterOptions:function(){return{styles:[0,1,2,4,8,16,32,64,128,256].map(function(e){return{n:1e3*e,url:"cluster/m"+e+".png",width:52,height:52,textColor:"#fff"}}),maxZoom:12}}}}]),angular.module("npn-viz-tool.export",["npn-viz-tool.filter"]).directive("exportControl",["$log","$http","$window","FilterService",function(r,a,i,o){return{restrict:"E",template:'<a title="Export" href id="export-control" class="btn btn-default btn-xs" ng-disabled="!getFilteredMarkers().length" ng-click="exportData()"><i class="fa fa-download"></i></a>',controller:["$scope",function(e){e.getFilteredMarkers=o.getFilteredMarkers,e.exportData=function(){var e=o.getFilter(),n=e.getDateArg().toExportParam();n.downloadType="selectable",n.searchSource="visualization-tool",n.endDate=n.endYear+"-12-31",e.getSpeciesArgs().length&&(n.species=[],e.getSpeciesArgs().forEach(function(e){n.species.push(e.getId())})),e.getNetworkArgs().length&&(n.partnerGroups=[],e.getNetworkArgs().forEach(function(e){n.partnerGroups.push(e.getId())})),e.getGeographicArgs().length&&(n.stations=[],o.getFilteredMarkers().forEach(function(e,t){n.stations.push(e.station_id)})),r.debug("export.params",n);var t="",e="",e=t=location.hostname.includes("local")||location.hostname.includes("dev")?"https://data-dev.usanpn.org":"https://data.usanpn.org";a({method:"POST",url:e+"/popservices/pop/search",data:{searchJson:n}}).then(function(e){location.hostname.includes("local")?i.open(t+":8080?search="+e.data.saved_search_hash):(console.log(t+"/observations?search="+e.data.saved_search_hash),i.open(t+"/observations?search="+e.data.saved_search_hash))})}}]}}]),angular.module("npn-viz-tool.filter",["npn-viz-tool.settings","npn-viz-tool.stations","npn-viz-tool.cluster","npn-viz-tool.vis-cache","npn-viz-tool.help","angular-md5","isteven-multi-select"]).factory("FilterArg",[function(){function e(e){this.arg=e}return e.prototype.getArg=function(){return this.arg},e.prototype.$filter=function(e){return!0},e.prototype.$removed=function(){},e}]).factory("DateFilterArg",["FilterArg",function(t){function n(e){e&&(e.start_date&&"number"!=typeof e.start_date&&(e.start_date=parseInt(e.start_date)),e.end_date&&"number"!=typeof e.end_date&&(e.end_date=parseInt(e.end_date))),t.apply(this,arguments)}return n.prototype.getId=function(){return"date"},n.prototype.getStartYear=function(){return this.arg.start_date},n.prototype.getStartDate=function(){return this.arg.start_date+"-01-01"},n.prototype.getEndYear=function(){return this.arg.end_date},n.prototype.getEndDate=function(){return this.arg.end_date+"-12-31"},n.prototype.toExportParam=function(){return{startDate:this.arg.start_date+"-01-01",endDate:this.arg.end_date+"-01-01",startYear:this.arg.start_date,startMonth:"January",startDay:1,endYear:this.arg.end_date,endMonth:"January",endDay:1,rangeType:"Calendar"}},n.prototype.toString=function(){return this.arg.start_date+"-"+this.arg.end_date},n.fromString=function(e){var t=e.indexOf("-");return new n({start_date:e.substring(0,t),end_date:e.substring(t+1)})},n}]).factory("NetworkFilterArg",["$http","$rootScope","$log","$url","FilterArg","SpeciesFilterArg","SettingsService",function(t,n,o,s,r,l,a){function c(e){r.apply(this,arguments),this.counts={station:"?",observation:"?"},this.stations=[],this.ydo=1<arguments.length?arguments[1]:a.getSettingValue("onlyYesData"),o.debug("NetworkFilterArg",this.arg,this.ydo),n.$broadcast("network-filter-ready",{filter:this})}return c.prototype.getId=function(){return parseInt(this.arg.network_id)},c.prototype.getName=function(){return this.arg.network_name},c.prototype.toExportParam=function(){return this.getId()},c.prototype.resetCounts=function(e){this.counts.station=this.counts.observation=e,this.stations=[]},c.prototype.updateCounts=function(e,t,n){var r,a,i=this.getId(),o=0;if(-1!==e.networks.indexOf(i))for(r in-1===this.stations.indexOf(e.station_id)&&(this.stations.push(e.station_id),this.counts.station++),t)(t[r].$match||n)&&(a=l.countObservationsForPhenophase.call(this,t[r]),n&&(e.observationCount+=a),this.counts.observation+=a,o+=a);return o},c.prototype.toString=function(){var e=this.arg.network_id;return this.ydo&&(e+=":1"),e},c.fromString=function(r){var e=r.split(":"),a=1<e.length?e[0]:r,i=2===e.length?"1"===e[1]:void 0;return t.get(s("/npn_portal/networks/getPartnerNetworks.json"),{params:{active_only:!0}}).then(function(e){for(var t=e.data,n=0;t&&n<t.length;n++)if(a==t[n].network_id)return i?new c(t[n],i):new c(t[n]);o.warn("NO NETWORK FOUND WITH ID "+r)})},c}]).factory("SpeciesFilterArg",["$http","$rootScope","$log","$url","FilterArg","SettingsService",function(a,r,i,o,s,l){function c(e,t){s.apply(this,arguments),this.counts={station:"?",observation:"?"},t&&"*"!=t&&(this.phenophaseSelections=t.split(",")),this.ydo=2<arguments.length?arguments[2]:l.getSettingValue("onlyYesData"),i.debug("SpeciesFilterArg:",e,this.phenophaseSelections,this.ydo);var n=this;a.get(o("/npn_portal/phenophases/getPhenophasesForSpecies.json"),{params:{return_all:!0,species_id:n.arg.species_id}}).then(function(e){var e=e.data,t={};n.phenophases=e[0].phenophases.filter(function(e){return!t[e.phenophase_id]&&((t[e.phenophase_id]=e).selected=!n.phenophaseSelections||-1!=n.phenophaseSelections.indexOf(e.phenophase_id),!0)}),n.phenophasesMap={},angular.forEach(n.phenophases,function(e){n.phenophasesMap[e.phenophase_id]=e}),r.$broadcast("species-filter-ready",{filter:n})})}return c.countObservationsForPhenophase=function(e){var t=this||{},n=0;return e.y&&(n+=e.y),t.ydo||(e.n&&(n+=e.n),e.q&&(n+=e.q)),n},c.prototype.getId=function(){return parseInt(this.arg.species_id)},c.prototype.getPhenophaseList=function(){return angular.copy(this.phenophases)},c.prototype.resetCounts=function(e){this.counts.station=this.counts.observation=e,angular.forEach(this.phenophases,function(e){e.count=0})},c.prototype.$filter=function(n){var r=this,a=0;return 0<Object.keys(n).filter(function(e){if(!r.phenophasesMap[e])return i.error("phenophase_id: "+e+" not found for species: "+r.arg.species_id),!1;var t=c.countObservationsForPhenophase.call(r,n[e]);return r.phenophasesMap[e].count+=t,n[e].$match=r.phenophasesMap[e].selected,n[e].$match&&(a+=t),n[e].$match}).length&&r.counts.station++,r.counts.observation+=a,a},c.prototype.toExportParam=function(){var e={species_id:this.getId(),common_name:this.arg.common_name},t=this.phenophases.filter(function(e){return e.selected});return t.length!==this.phenophases.length&&(e.phenophases=t.map(function(e){return parseInt(e.phenophase_id)})),e},c.prototype.toString=function(){var n=this.arg.species_id+":",e=this.phenophases.filter(function(e){return e.selected});return e.length===this.phenophases.length?n+="*":e.forEach(function(e,t){n+=(0<t?",":"")+e.phenophase_id}),this.ydo&&(n+=":1"),n},c.fromString=function(e){var e=e.split(":"),t=e[0],n=e[1],r=3===e.length?"1"===e[2]:void 0;return a.get(o("/npn_portal/species/getSpeciesById.json"),{params:{species_id:t}}).then(function(e){return e.data.species_id=t,r?new c(e.data,n,r):new c(e.data,n)})},c}]).factory("GeoFilterArg",["FilterArg",function(n){function e(e,t){n.apply(this,arguments),this.sourceId=t}return e.prototype.getId=function(){return this.arg.getProperty("NAME")},e.prototype.getSourceId=function(){return this.sourceId},e.prototype.getUid=function(){return this.getSourceId()+"-"+this.getId()},e.prototype.$filter=function(e){return function e(t,n){var r,a,i,o=n.getType();if("Polygon"==o){for(a=n.getArray(),i=0;i<a.length;i++)if(r=new google.maps.Polygon({paths:a[i].getArray()}),google.maps.geometry.poly.containsLocation(t,r)||google.maps.geometry.poly.isLocationOnEdge(t,r))return!0}else if("MultiPolygon"===o||"GeometryCollection"==o)for(a=n.getArray(),i=0;i<a.length;i++)if(e(t,a[i]))return!0;return!1}(new google.maps.LatLng(parseFloat(e.latitude),parseFloat(e.longitude)),this.arg.getGeometry())},e.prototype.toString=function(){return this.sourceId+":"+this.arg.getProperty("NAME")},e}]).factory("BoundsFilterArg",["$rootScope","FilterArg",function(t,n){function r(e){n.apply(this,arguments),t.$broadcast("bounds-filter-ready",{filter:this})}return r.RECTANGLE_OPTIONS={strokeColor:"#fff",strokeWeight:1,fillColor:"#000080",fillOpacity:.25,visible:!0,zIndex:1},r.prototype.getId=function(){return this.arg.getBounds().getCenter().toString()},r.prototype.getUid=function(){return this.getId()},r.prototype.$filter=function(e){return this.arg.getBounds().contains(new google.maps.LatLng(parseFloat(e.latitude),parseFloat(e.longitude)))},r.prototype.$removed=function(){this.arg.setMap(null)},r.prototype.toString=function(){var e=this.arg.getBounds(),t=e.getSouthWest(),e=e.getNorthEast();return t.lat().toFixed(4)+","+t.lng().toFixed(4)+":"+e.lat().toFixed(4)+","+e.lng().toFixed(4)},r.fromString=function(e,t){var n=e.split(":"),e=n[0].split(","),e=new google.maps.LatLng(parseFloat(e[0]),parseFloat(e[1])),n=n[1].split(","),n=new google.maps.LatLng(parseFloat(n[0]),parseFloat(n[1])),e=new google.maps.LatLngBounds(e,n),n=new google.maps.Rectangle(r.RECTANGLE_OPTIONS);return n.setBounds(e),n.setMap(t),new r(n)},r}]).factory("NpnFilter",["$q","$log","$http","$url","$filter","DateFilterArg","SpeciesFilterArg","NetworkFilterArg","GeoFilterArg","BoundsFilterArg","CacheService","Analytics",function(l,a,s,c,i,t,n,r,o,d,u,p){function g(e){var t,n=[];for(t in e)n.push(e[t]);return n}function e(){this.reset()}function f(t){return t&&Object.keys(t).forEach(function(e){t[e].$removed&&t[e].$removed()}),{}}function h(e){var t=[];return e.filter(function(e){return!t[e.phenophase_id]&&(t[e.phenophase_id]=e,!0)})}function m(e){return h(e.reduce(function(e,t){return e.concat(t)},[]))}function v(e,t){var n=l.defer(),t={date:t,species_id:e},r=u.keyFromObject(t),e=u.get(r);return e?n.resolve(e):s.get(c("/npn_portal/phenophases/getPhenophasesForSpecies.json"),{params:t}).then(function(e){e=h(e=e.data[0].phenophases);u.put(r,e),n.resolve(e)},n.reject),n.promise}function y(r,e){var t=l.defer(),e=e.map(function(e){return t=r,e=e,n=l.defer(),l.all([v(t,e+"-12-31"),v(t,e+"-01-01")]).then(function(e){a.debug("getPhenophasesForYear.results",e),n.resolve(m(e))}),n.promise;var t,n});return l.all(e).then(function(e){a.debug("getPhenophasesForYears.results",e),t.resolve(m(e))}),t.promise}return e.prototype.hasDate=function(){return!!this.date},e.prototype.hasCriteria=function(){return!!this.date||(0<Object.keys(this.species).length||0<Object.keys(this.networks).length)},e.prototype.hasSufficientCriteria=function(){return this.date&&(0<Object.keys(this.species).length||0<Object.keys(this.networks).length)},e.prototype.getUpdateCount=function(){return this.updateCount},e.prototype.getDateArg=function(){return this.date},e.prototype.getSpeciesArg=function(e){return this.species[e]},e.prototype.getSpeciesArgs=function(){return g(this.species)},e.prototype.getNetworkArg=function(e){return this.networks[e]},e.prototype.getNetworkArgs=function(){return g(this.networks)},e.prototype.getCriteria=function(){var e=g(this.species);return this.date&&e.append(this.date),e},e.prototype.getGeoArgs=function(){return g(this.geo)},e.prototype.getBoundsArgs=function(){return g(this.bounds)},e.prototype.getGeographicArgs=function(){return this.getBoundsArgs().concat(this.getGeoArgs())},e.prototype.ga=function(t){t=t||"execute";var e=this.getDateArg(),n=i("speciesTitle"),r=this.getBoundsArgs().length;e&&p.trackEvent("filter",t+" date",e.getStartYear()+"-"+e.getEndYear()),this.getSpeciesArgs().forEach(function(e){p.trackEvent("filter",t+" species",n(e.arg,"common-name"))}),this.getNetworkArgs().forEach(function(e){p.trackEvent("filter",t+" network",e.getName())}),this.getGeoArgs().forEach(function(e){p.trackEvent("filter",t+" geo",e.getUid())}),r&&p.trackEvent("filter",t+" bounds",r)},e.prototype.add=function(e){return this.updateCount++,e instanceof t?this.date=e:e instanceof n?this.species[e.getId()]=e:e instanceof r?this.networks[e.getId()]=e:e instanceof o?this.geo[e.getId()]=e:e instanceof d&&(this.bounds[e.getId()]=e),!(e instanceof o)},e.prototype.remove=function(e){return this.updateCount++,e instanceof t?(this.date=void 0,this.species={},this.networks={},this.bounds={}):e instanceof n?delete this.species[e.getId()]:e instanceof r?delete this.networks[e.getId()]:e instanceof o?delete this.geo[e.getId()]:e instanceof d&&delete this.bounds[e.getId()],e.$removed&&e.$removed(),!(e instanceof o||e instanceof d)},e.prototype.reset=function(){this.updateCount=0,this.date=void 0,this.species=f(this.species),this.geo=f(this.geo),this.networks=f(this.networks),this.bounds=f(this.bounds)},e.prototype.getSpeciesList=function(){var t,n,r,a=[],e=this.getSpeciesArgs(),i=this.getNetworkArgs(),o=l.defer();return e.length?(e.forEach(function(e){a.push(e.arg)}),o.resolve(a)):i.length?(t={},n=0,i.forEach(function(e){t["network_id["+n+++"]"]=e.getId()}),r=u.keyFromObject(t),(a=u.get(r))&&a.length?o.resolve(a):s.get(c("/npn_portal/species/getSpeciesFilter.json"),{params:t}).then(function(e){e=e.data;u.put(r,e),o.resolve(e)})):o.resolve(a),o.promise},e.prototype.getPhenophasesForSpecies=function(e,t,n){var r=this.getSpeciesArgs(),a=this.getDateArg(),i=l.defer();if("string"==typeof e&&(e=parseInt(e)),!t&&r.length){for(var o=!1,s=0;s<r.length;s++)if(r[s].getId()===e){i.resolve(r[s].getPhenophaseList()),o=!0;break}o||i.resolve([])}else y(e,n=n||d3.range(a.getStartYear(),a.getEndYear()+1)).then(function(e){i.resolve(e)});return i.promise},e}]).factory("FilterService",["$q","$http","$rootScope","$timeout","$log","$filter","$url","uiGmapGoogleMapApi","md5","NpnFilter","SpeciesFilterArg","SettingsService","Analytics",function(r,a,g,n,f,h,i,e,m,t,o,v,s){var l,c,d=["#1f77b4","#ff7f0e","#2ca02c","#d62728","#222299","#c51b8a","#8c564b","#637939","#843c39","#5254a3","#636363","#bcbd22","#7b4173","#e7ba52","#222299","#f03b20","#1b9e77","#e377c2","#ef8a62","#91cf60","#9467bd"],u=d3.range(0,d.length),p=d3.scale.ordinal().domain(u).range(u.map(function(e){return d3.rgb(d[e]).darker(1).toString()})),y=u.map(function(e){var t=p(e),e=d3.rgb(t).brighter(4).toString();return d3.scale.linear().range([e,t])}),b=new t,w=!1,x={fillColor:"#00ff00",fillOpacity:1,scale:8,strokeColor:"#204d74",strokeWeight:1},k=[];e.then(function(e){x.path=e.SymbolPath.CIRCLE}),g.$on("filter-rerun-phase2",function(e,t){w||n(function(){var e;c&&(F.getFilter().ga("re-execute"),e=S(c,!0),g.$broadcast("filter-marker-updates",{markers:e}))},500)});var _={previousFilterCount:0,previousFilterMap:{},hits:[],misses:[]};function S(e,t){var n=Date.now();g.$broadcast("filter-phase2-start",{count:e.length});function o(t,n,r){var a;i.length&&angular.forEach(i,function(e){a=e.updateCounts(t,n,r),r&&(l+=a)})}var s,l=0,c=0<b.getSpeciesArgs().length,i=b.getNetworkArgs(),d=h("speciesTitle"),u=v.getSettingValue("tagSpeciesTitle"),p=function(e,t){function n(e,t){var n,r=Object.keys(e),a=Object.keys(t);if(r.length!==a.length+1&&f.warn("Issue with usage of _mapdiff, unexpected key lengths",e,t),1===r.length)return e[r[0]];for(n=0;n<r.length;n++)if(!t[r[n]])return e[r[n]];f.warn("Issue with usage of _mapdiff, unfound diff",e,t)}function r(e,t){var n={hits:[],misses:[]};return angular.forEach(e,function(e){(t(e)?n.hits:n.misses).push(e)}),n}var a,i,o,s,l=Date.now(),c=b.getGeographicArgs(),d=c.length,u=d>_.previousFilterCount,p=(a={},angular.forEach(b.getGeographicArgs(),function(e){a[e.getUid()]=e}),a);if(0<d&&_.previousFilterCount===d){if(angular.equals(Object.keys(p),Object.keys(_.previousFilterMap)))return f.debug("refilter but no change in geographic filters"),_.hits;f.warn("refilter but no change in geo filter count")}return 0===(_.previousFilterCount=d)?(_.misses=[],_.hits=[].concat(e)):t&&1!==Object.keys(p).length?u?(i=n(p,_.previousFilterMap),o=r(_.misses,function(e){return i.$filter(e)}),_.hits=_.hits.concat(o.hits),_.misses=o.misses):(s=n(_.previousFilterMap,p),o=r(_.hits,function(e){return s.$filter(e)}),_.hits=o.misses,_.misses=_.misses.concat(o.hits)):(o=r(e,function(e){for(var t=!1,n=0;n<c.length&&!(t=c[n].$filter(e));n++);return t}),_.hits=o.hits,_.misses=o.misses),_.previousFilterMap=p,f.debug("geo time:"+(Date.now()-l)),_.hits}(e,t).filter(function(t){t.markerOpts.icon.fillColor=x.fillColor;var e,n,r,a=0,i={};for(e in t.observationCount=0,t.speciesInfo=void 0,t.species)n=b.getSpeciesArg(e),i[e]=0,n||!c?n&&(r=n.$filter(t.species[e]))?(l+=r,t.observationCount+=r,i[e]++,a++,o(t,t.species[e]),t.speciesInfo||(t.speciesInfo={titles:{},counts:{}}),t.speciesInfo.titles[e]=d(n.arg,u),t.speciesInfo.counts[e]=r):n||(a++,o(t,t.species[e],!0)):f.warn("species found in results but not in filter",t.species[e]);for(e in i.n=0,i)"n"!=e&&0<i[e]&&i.n++;return t.markerOpts.title=t.station_name+" ("+t.observationCount+")",t.speciesInfo&&(t.markerOpts.title+=" ["+Object.keys(t.speciesInfo.titles).map(function(e){return t.speciesInfo.titles[e]}).join(",")+"]"),t.markerOpts.icon.strokeColor=1<i.n?"#00ff00":x.strokeColor,t.markerOpts.zIndex=t.observationCount+2,0<a}).map(function(e){return{latitude:e.latitude,longitude:e.longitude,markerOpts:e.markerOpts,station_id:e.station_id,station_name:e.station_name,observationCount:e.observationCount,speciesInfo:e.speciesInfo}});return c?(s={},p.forEach(function(n){var e=Object.keys(n.speciesInfo.counts),e=e.reduce(function(e,t){return s[t]?(n.speciesInfo.counts[t]<s[t].min&&(s[t].min=n.speciesInfo.counts[t]),n.speciesInfo.counts[t]>s[t].max&&(s[t].max=n.speciesInfo.counts[t])):s[t]={min:n.speciesInfo.counts[t],max:n.speciesInfo.counts[t]},n.speciesInfo.counts[t]>n.speciesInfo.counts[e]?t:e},e[0]),e=b.getSpeciesArg(e);n.markerOpts.icon.fillColorIdx=e.colorIdx}),b.getSpeciesArgs().forEach(function(t){var e,n,r,a,i;s[t.arg.species_id]&&(e=p.filter(function(e){return t.colorIdx===e.markerOpts.icon.fillColorIdx}),n=t.arg.species_id,r=s[n].min,a=s[n].max,f.debug("observationCount variability for "+t.toString()+" ("+t.arg.common_name+") ["+r+"-"+a+"]"),(i=y[t.colorIdx]).domain([r,a]),e.forEach(function(e){e.markerOpts.icon.fillColor=i(e.speciesInfo.counts[n])}))})):(e=d3.min(p,function(e){return e.observationCount}),t=d3.max(p,function(e){return e.observationCount}),f.debug("observationCount variability for network only results ["+e+"-"+t+"]"),y[0].domain([e,t]),p.forEach(function(e){e.markerOpts.icon.fillColorIdx=0,e.markerOpts.icon.fillColor=y[0](e.observationCount)})),p.forEach(function(e){e.$markerKey=m.createHash(JSON.stringify(e))}),g.$broadcast("filter-phase2-end",{station:p.length,observation:l}),f.debug("phase2 time:",Date.now()-n),k=p}function $(){w||g.$broadcast("filter-update",{})}function C(){k=[],g.$broadcast("filter-reset",{})}var F={execute:function(){var t,n=r.defer(),e=function(){if(b.hasCriteria()){var n={},e=b.getDateArg();return e&&(n.start_date=e.getStartDate(),n.end_date=e.getEndDate()),b.getSpeciesArgs().forEach(function(e,t){n["species_id["+t+"]"]=e.getId()}),b.getNetworkArgs().forEach(function(e,t){n["network_id["+t+"]"]=e.getId()}),n}}();return!w&&e&&l!=b.getUpdateCount()?(l=b.getUpdateCount(),t=Date.now(),f.debug("execute",l,e),g.$broadcast("filter-phase1-start",{}),a.get(i("/npn_portal/observations/getAllObservationsForSpecies.json"),{params:e}).then(function(e){e=e.data;angular.forEach(e.station_list,function(e){e.markerOpts={title:e.station_name,icon:angular.extend({},x)}}),g.$broadcast("filter-phase1-end",{count:e.station_list.length}),f.debug("phase1 time:",Date.now()-t),n.resolve(S(c=e.station_list))})):n.resolve(k),n.promise},getFilteredMarkers:function(){return k},pause:function(){f.debug("PAUSE"),w=!0},resume:function(){f.debug("RESUME"),w=!1,$()},getFilter:function(){return b},hasFilterChanged:function(){return l!==b.getUpdateCount()},isFilterEmpty:function(){return!b.hasCriteria()},hasDate:function(){return b.hasDate()},hasSufficientCriteria:function(){return b.hasSufficientCriteria()},addToFilter:function(e){b.add(e)&&(b.getSpeciesArgs().forEach(function(e,t){e.colorIdx=t,e.color=p(t)}),$())},removeFromFilter:function(e){b.remove(e)&&(b.hasCriteria()?$:C)()},resetFilter:function(){b.reset(),l=b.getUpdateCount(),C()},getColorScale:function(){return p},getChoroplethScale:function(e){e=b.getSpeciesArg(e);if(e)return y[e.colorIdx]},getChoroplethScales:function(){return y}};return F}]).directive("npnFilterResults",["$rootScope","$http","$timeout","$filter","$log","FilterService","SettingsService","StationService","ClusterService","Analytics",function(t,e,l,c,n,d,u,p,g,r){return{restrict:"E",template:'<ui-gmap-markers models="results.markers" idKey="\'$markerKey\'" coords="\'self\'" icon="\'icon\'" options="\'markerOpts\'" doCluster="doCluster" clusterOptions="clusterOptions" control="mapControl" events="markerEvents"></ui-gmap-markers>',scope:{},link:function(a){var n=!1;a.results={markers:[]},a.mapControl={},a.doCluster=u.getSettingValue("clusterMarkers");var i=g.getDefaultClusterOptions(),o=c("speciesBadge");function r(e){for(var t=e.reduce(function(e,t){return e+t.observationCount},0),n=512<t?Math.round(t/2):512,r=i.styles.length-1;0<=r;r--)i.styles[r].n=n,n=Math.round(n/2);a.results.markers=e}function s(){d.hasFilterChanged()&&d.hasSufficientCriteria()&&(d.getFilter().ga("execute"),l(function(){a.results.markers=[],l(function(){d.execute().then(function(e){r(e)})},500)},500))}a.clusterOptions=angular.extend(i,{calculator:function(e,t){var n=0,r=(u.getSettingValue("tagBadgeFormat"),{index:1});e.values().forEach(function(e){n+=e.model.observationCount}),r.text=o({station:e.length,observation:n},u.getSettingValue("tagBadgeFormat"));for(var a=0;a<i.styles.length;a++)n>=i.styles[a].n&&(r.index=a+1);return r}}),a.$on("setting-update-tagBadgeFormat",function(e,t){a.mapControl&&a.mapControl.managerDraw&&a.mapControl.managerDraw()}),a.$on("setting-update-clusterMarkers",function(e,t){a.doCluster=t.value}),a.$on("tool-open",function(e,t){n="filter"===t.tool.id}),a.$on("tool-close",function(e,t){"filter"===t.tool.id&&(n=!1,s())}),a.$on("filter-update",function(e,t){n||s()}),a.$on("filter-reset",function(e,t){a.results.markers=[]}),a.$on("filter-marker-updates",function(e,t){r(t.markers)});var e=p.getMarkerEvents();a.markerEvents={click:e.click,mouseover:function(e){t.$broadcast("marker-mouseover",{marker:e})},mouseout:function(e){t.$broadcast("marker-mouseout",{marker:e})}}}}}]).directive("choroplethInfo",["$log","$timeout","FilterService",function(s,n,l){return{restrict:"E",templateUrl:"js/filter/choroplethInfo.html",link:function(a){var i=!1;function o(t){for(var e,n=Math.ceil(t.domain[1]/20),r=[],a=0;a<20;a++)e=n*a+1,r[a]=t.scale(e),t.count>=e&&(t.color=r[a]);return r.forEach(function(e){-1===t.colors.indexOf(e)&&t.colors.push(e)}),t}a.show=!1,a.$on("marker-mouseover",function(e,r){s.debug("mouseover",r),(r.marker.model.speciesInfo||r.marker.model.observationCount)&&(i=!0,n(function(){var n,e;(a.show=i)&&(a.station_name=r.marker.model.station_name,n=l.getChoroplethScales(),r.marker.model.speciesInfo?(e=Object.keys(r.marker.model.speciesInfo.counts),a.data=e.map(function(e){var t=l.getFilter().getSpeciesArg(e);return o({sid:e,count:r.marker.model.speciesInfo.counts[e],title:r.marker.model.speciesInfo.titles[e],arg:t,scale:n[t.colorIdx],domain:n[t.colorIdx].domain(),colors:[]})})):r.marker.model.observationCount&&(e={count:r.marker.model.observationCount,title:"All Records",scale:n[0],domain:n[0].domain(),colors:[]},a.data=[o(e)]),s.debug(a.data))},500))}),a.$on("marker-mouseout",function(e,t){s.debug("mouseout",t),i=!1,a.show&&n(function(){i||(a.show=!1,a.data=void 0)},500)})}}}]).directive("filterTags",["FilterService",function(t){return{restrict:"E",templateUrl:"js/filter/filterTags.html",scope:{},controller:["$scope",function(e){e.getFilter=t.getFilter}]}}]).filter("speciesBadge",function(){return function(e,t){return"observation-count"===t?e.observation:"station-count"===t?e.station:"station-observation-count"===t?e.station+"/"+e.observation:e}}).filter("speciesTitle",["SettingsService",function(n){return function(e,t){t=t||n.getSettingValue("tagSpeciesTitle");if("common-name"!==t)return"scientific-name"===t?e.genus+" "+e.species:e;if(e.common_name){t=e.common_name.toLowerCase();return t.substring(0,1).toUpperCase()+t.substring(1)}return e.common_name}}]).directive("speciesFilterTag",["$rootScope","FilterService","SettingsService","SpeciesFilterArg",function(i,e,o,t){return{restrict:"E",require:"^filterTags",templateUrl:"js/filter/speciesFilterTag.html",scope:{arg:"="},link:function(n){var r,a;n.titleFormat=o.getSettingValue("tagSpeciesTitle"),n.$on("setting-update-tagSpeciesTitle",function(e,t){n.titleFormat=t.value}),n.badgeFormat=o.getSettingValue("tagBadgeFormat"),n.badgeTooltip=o.getSettingValueLabel("tagBadgeFormat"),n.$on("setting-update-tagBadgeFormat",function(e,t){n.badgeFormat=t.value,n.badgeTooltip=o.getSettingValueLabel("tagBadgeFormat")}),n.$on("setting-update-onlyYesData",function(e,t){t.value!==n.arg.ydo&&(n.arg.ydo=t.value,i.$broadcast("filter-rerun-phase2",{}))}),n.$on("filter-phase2-start",function(e,t){n.arg.resetCounts(0)}),n.$on("filter-phase1-start",function(e,t){n.arg.resetCounts("?")}),n.removeFromFilter=e.removeFromFilter,n.status={isopen:!1},n.hasCount=function(e,t){return 0<e.count},n.$watch("status.isopen",function(){if(n.status.isopen)r=n.arg.phenophases.map(function(e){return e.selected}),a=n.arg.ydo;else if(r){for(var e=!1,t=0;t<r.length;t++)if(r[t]!=n.arg.phenophases[t].selected){e=!0;break}(e=e||a!=n.arg.ydo)&&i.$broadcast("filter-rerun-phase2",{})}}),n.selectAll=function(t){angular.forEach(n.arg.phenophases,function(e){e.selected=t})}}}}]).directive("dateFilterTag",["FilterService","SettingsService",function(e,r){return{restrict:"E",require:"^filterTags",templateUrl:"js/filter/dateFilterTag.html",scope:{arg:"="},link:function(n){n.badgeFormat=r.getSettingValue("tagBadgeFormat"),n.badgeTooltip=r.getSettingValueLabel("tagBadgeFormat"),n.$on("setting-update-tagBadgeFormat",function(e,t){n.badgeFormat=t.value,n.badgeTooltip=r.getSettingValueLabel("tagBadgeFormat")}),n.removeFromFilter=e.removeFromFilter,n.counts={station:"?",observation:"?"},n.$on("filter-phase1-start",function(e,t){n.counts.station=n.counts.observation="?"}),n.$on("filter-phase2-start",function(e,t){n.counts.station=n.counts.observation=0}),n.$on("filter-phase2-end",function(e,t){n.counts=t})}}}]).directive("networkFilterTag",["$rootScope","FilterService","SettingsService",function(r,e,a){return{restrict:"E",require:"^filterTags",templateUrl:"js/filter/networkFilterTag.html",scope:{arg:"="},link:function(n){var t;n.status={isopen:!1},n.badgeFormat=a.getSettingValue("tagBadgeFormat"),n.badgeTooltip=a.getSettingValueLabel("tagBadgeFormat"),n.$on("setting-update-tagBadgeFormat",function(e,t){n.badgeFormat=t.value,n.badgeTooltip=a.getSettingValueLabel("tagBadgeFormat")}),n.$on("setting-update-onlyYesData",function(e,t){t.value!==n.arg.ydo&&(n.arg.ydo=t.value,r.$broadcast("filter-rerun-phase2",{}))}),n.removeFromFilter=e.removeFromFilter,n.$on("filter-phase1-start",function(e,t){n.arg.resetCounts("?")}),n.$on("filter-phase2-start",function(e,t){n.arg.resetCounts(0)}),n.$watch("status.isopen",function(e){e?t=n.arg.ydo:void 0!==t&&t!==n.arg.ydo&&r.$broadcast("filter-rerun-phase2",{})})}}}]).directive("filterControl",["$http","$filter","$timeout","$url","FilterService","DateFilterArg","SpeciesFilterArg","NetworkFilterArg","HelpService","SpeciesService",function(s,l,c,d,u,p,g,f,h,m){return{restrict:"E",templateUrl:"js/filter/filterControl.html",controller:["$scope",function(r){r.addDateRangeToFilter=function(){u.addToFilter(new p(r.selected.date))},r.filterHasDate=u.hasDate,r.filterHasSufficientCriteria=u.hasSufficientCriteria;var e=(new Date).getYear()+1900,t=d3.range(1900,e+1);r.thisYear=e,r.validYears=t,r.selected={date:{start_date:e-1,end_date:e},species:[]},r.speciesInput={animals:[],plants:[],networks:[]},r.findSpeciesParamsEmpty=!0,r.$watch("selected.species.length",function(e){e&&h.lookAtMe("#add-species-button")}),r.$watch("speciesInput.networks.length",function(e){e&&h.lookAtMe("#add-networks-button")}),r.networksMaxedOut=function(){return 10<=u.getFilter().getNetworkArgs().length},r.speciesMaxedOut=function(){return 20<=u.getFilter().getSpeciesArgs().length},r.addNetworksToFilter=function(){h.stopLookingAtMe("#add-networks-button"),angular.forEach(r.speciesInput.networks,function(e){r.networksMaxedOut()||u.addToFilter(new f(e))})},r.addSpeciesToFilter=function(){h.stopLookingAtMe("#add-species-button"),angular.forEach(r.selected.species,function(e){r.speciesMaxedOut()||u.addToFilter(new g(e))})};var a,n,i=!0;function o(){var t={},n=0;angular.forEach([].concat(r.speciesInput.animals).concat(r.speciesInput.plants),function(e){t["group_ids["+n+++"]"]=e.species_type_id}),n=0,angular.forEach(r.speciesInput.networks,function(e){t["network_id["+n+++"]"]=e.network_id}),a=t,r.findSpeciesParamsEmpty=0===Object.keys(t).length,i=!0}r.$watch("speciesInput.animals",o),r.$watch("speciesInput.plants",o),r.$watch("speciesInput.networks",o),r.findSpecies=function(){i&&(i=!1,angular.forEach(r.selected.species,function(e){e.selected=!1}),r.selected.species=[],r.findSpeciesParamsEmpty&&n&&n.length?r.speciesList=n:(r.findingSpecies=!0,r.serverResults=s.get(d("/npn_portal/species/getSpeciesFilter.json"),{params:a}).then(function(e){var t=[];angular.forEach(e.data,function(e){e.number_observations=parseInt(e.number_observations),e.display=l("speciesTitle")(e)+" ("+e.number_observations+")",t.push(e)});e=r.speciesList=t.sort(function(e,t){return e.number_observations<t.number_observations?1:e.number_observations>t.number_observations?-1:0});return r.findSpeciesParamsEmpty&&(n=e),c(function(){r.findingSpecies=!1},250),e})))},r.$on("setting-update-tagSpeciesTitle",function(e,t){c(function(){angular.forEach(r.speciesList,function(e){e.display=l("speciesTitle")(e)+" ("+e.number_observations+")"})},250)}),s.get(d("/npn_portal/networks/getPartnerNetworks.json?active_only=true")).then(function(e){e=e.data;angular.forEach(e,function(e){e.network_name=e.network_name.trim()}),r.partners=e}),m.getPlantTypes().then(function(e){r.plantTypes=e}),m.getAnimalTypes().then(function(e){r.animalTypes=e}),r.findSpecies()}]}}]).factory("SpeciesService",["$q","$http","$url",function(n,e,t){function r(e){return function(){var t=n.defer();return e.then(function(e){t.resolve(e.data)}),t.promise}}return{getPlantTypes:r(e.get(t("/npn_portal/species/getPlantTypes.json"))),getAnimalTypes:r(e.get(t("/npn_portal/species/getAnimalTypes.json")))}}]),angular.module("npn-viz-tool.filters",[]).filter("cssClassify",function(){return function(e){return"string"==typeof e?e.trim().toLowerCase().replace(/\s+/g,"-"):e}}).filter("yesNo",function(){return function(e){return e?"Yes":"No"}}).filter("gte",function(){return function(e,t){return t&&angular.isArray(e)?e.filter(function(e){return t<=e}):e}}).filter("lte",function(){return function(e,t){return t&&angular.isArray(e)?e.filter(function(e){return e<=t}):e}}).filter("trim",function(){return function(e){return angular.isString(e)?e.trim():e}}).filter("ellipses",function(){return function(e){var t=2==arguments.length?arguments[1]:55;return"string"==typeof e&&e.length>t?e.substring(0,t)+" ...":e}}).filter("doy",function(){return function(e,t){var n,r,a;if("string"!=typeof e||3===(a=e.split("-")).length&&(n=parseInt(a[0]),r=parseInt(a[1]),a=parseInt(a[2]),!isNaN(n)&&!isNaN(r)&&!isNaN(a)&&r<13&&a<32&&(e=new Date(n,r-1,a))),e instanceof Date){e=new Date(e.getTime()),t&&e.setFullYear(2010);for(var i=e.getDate();0<e.getMonth();)e.setDate(1),e.setTime(e.getTime()-864e5),i+=e.getDate();return i}return e}}),angular.module("npn-viz-tool.gridded",["npn-viz-tool.gridded-services"]).service("GriddedControlService",["$location",function(t){var r={getLegend:function(){return r.legend},getLayer:function(){return r.layer},addSharingUrlArgs:function(e){var t,n;r.layer&&(t=r.layer.name+"/"+r.layer.extent.current.value,(n=r.layer.getStyleRange())&&(t+="/"+n[0]+"/"+n[1]),e.gl=t)},getSharingUrlArgs:function(){var e=t.search().gl;if(e)return e.split(/\//)}};return r}]).directive("griddedLegendMain",["GriddedControlService",function(t){return{restrict:"E",template:'<div id="griddedLegendMain" ng-style="{display: shared.legend ? \'inherit\' : \'none\'}"><gridded-legend legend="shared.legend"></gridded-legend></div>',scope:{},link:function(e){e.shared=t}}}]).directive("griddedControl",["$log","$rootScope","uiGmapGoogleMapApi","uiGmapIsReady","WmsService","GriddedControlService","GriddedInfoWindowHandler",function(o,s,l,c,d,u,p){return{restrict:"E",templateUrl:"js/gridded/gridded-control.html",link:function(i){var t,n,e;function r(){console.log("gridded.js init called getting maps"),e||(e=!0,l.then(function(e){c.promise(1).then(function(e){n=e[0].map,t=new p(n),n.addListener("click",function(e){t.open(e.latLng,i.selection.activeLayer,i.legend)}),d.getLayers(n).then(function(e){o.debug("layers",e),i.layers=e;var n,r,a,t=u.getSharingUrlArgs();t&&(o.debug("arguments from shared url",t),n=t[0],r=t[1],(e=e.categories.reduce(function(e,t){return e||(e=t.layers.reduce(function(e,t){return e||(t.name===n?t:void 0)},void 0))&&(a=t),e},void 0))?(e.extent.current=e.extent.values.reduce(function(e,t){return e||(t.value===r?t:void 0)},void 0)||e.extent.current,i.selection.layerCategory=a,i.selection.layer=e,4===t.length&&e.setStyleRange([parseInt(t[2]),parseInt(t[3])])):o.warn("unable to find gridded layer named "+n))},function(){o.error("unable to get map layers?")})})}))}function a(){t&&t.close()}i.selection={},i.actions={reset:function(){delete i.selection.layerCategory,delete i.selection.layer}},i.$on("filter-reset",i.actions.reset),u.getSharingUrlArgs()?r():i.$on("tool-open",function(e,t){"gridded"===t.tool.id&&r()}),i.$watch("selection.layerCategory",function(e){o.debug("layer category change ",e),null!=i.selection.layerCategory&&s.$broadcast("reset-pest-layer"),i.selection.activeLayer&&(o.debug("turning off layer ",i.selection.activeLayer.name),e=i.selection.activeLayer,i.selection.activeLayer.off(),delete i.selection.activeLayer,delete i.legend,delete u.legend,delete u.layer,a(),s.$broadcast("gridded-layer-off",{layer:e}))}),i.$watch("selection.layer",function(e){e&&(a(),o.debug("selection.layer",e),i.selection.activeLayer&&(o.debug("turning off layer ",i.selection.activeLayer.name),i.selection.activeLayer.off()),o.debug("fitting new layer ",e.name),u.layer=i.selection.activeLayer=e.fit().on(),delete i.legend,i.selection.activeLayer.getLegend(e).then(function(e){u.legend=i.legend=e}),s.$broadcast("gridded-layer-on",{layer:i.selection.activeLayer}))}),i.$watch("selection.activeLayer.extent.current",function(e){var t;(t=i.selection.activeLayer)&&(o.debug("layer extent change ",t.name,e),a(),t.bounce())}),i.$on("reset-gridded-layer",function(){console.log("resetting the gridded layer"),delete i.selection.layerCategory,delete i.selection.layer,i.selection.activeLayer&&(o.debug("turning off layer ",i.selection.activeLayer.name),i.selection.activeLayer,i.selection.activeLayer.off(),delete i.selection.activeLayer,delete i.legend,delete u.legend,delete u.layer,a())})}}}]),angular.module("npn-viz-tool.gridded-services",[]).provider("$url",[function(){this.$get=["$log",function(e){var t=window.location.origin.replace("data","www");return e.debug("BASE_URL",t),function(e){return t+e}}]}]).service("DateExtentUtil",[function(){var r=/^(\d\d\d\d)-0?(\d+)-0?(\d+)/;return{parse:function(e){var t=r.exec(e.replace(/T.*$/,"")),n=parseInt(t[1]),e=parseInt(t[2])-1,t=parseInt(t[3]);return new Date(n,e,t)}}}]).directive("griddedPointInfoWindow",["$log","$timeSeriesVis","$q","$http",function(p,g,f,h){return{restrict:"E",template:'<div id="griddedPointInfoWindow" class="ng-cloak"><div ng-if="!gridded_point_legend">loading AGDD...</div><div ng-if="gridded_point_legend" class="gridded-legend-color" style="background-color: {{gridded_point_legend.color}};">&nbsp;</div><div ng-if="gridded_point_legend" class="gridded-point-data">{{legend.formatPointData(point)}}</div><ul class="list-unstyled" ng-if="timeSeries"><li><a href ng-click="timeSeries()">Show Accumulation</a></li></ul></div>',scope:{point:"=",layer:"=",legend:"=",latLng:"="},link:function(t){var e=t.latLng,n=t.point,r=t.layer,a=t.legend;p.debug("griddedPointInfoWindow:latLng",e),p.debug("griddedPointInfoWindow:point",n),p.debug("griddedPointInfoWindow:layer",r),p.debug("griddedPointInfoWindow:legend",a);var i,o,s,l,c,d=!1,u="https://data.usanpn.org/geoservices";(location.hostname.includes("local")||location.hostname.includes("dev"))&&(u="https://data-dev.usanpn.org/geoservices"),"Eastern Tent Caterpillar"!=r.pest&&"Pine Needle Scale"!=r.pest&&"Bagworm"!=r.pest||(d=!0,c=u+"/v1/agdd/simple/pointTimeSeries?climateProvider=NCEP&temperatureUnit=fahrenheit&startDate="+(i=r.extent.current.date.getFullYear()+"-03-01")+"&endDate="+(o=r.extent.current.date.toISOString().split("T")[0])+"&base="+(s=50)+"&latitude="+e.lat()+"&longitude="+e.lng()),"Asian Longhorned Beetle"!=r.pest&&"Gypsy Moth"!=r.pest||(d=!0,i=r.extent.current.date.getFullYear()+"-01-01",o=r.extent.current.date.toISOString().split("T")[0],s=50,l=86,"Gypsy Moth"==r.pest&&(s=37.4,l=104),c=u+"/v1/agdd/double-sine/pointTimeSeries?climateProvider=NCEP&temperatureUnit=fahrenheit&startDate="+i+"&endDate="+o+"&lowerThreshold="+s+"&upperThreshold="+l+"&latitude="+e.lat()+"&longitude="+e.lng()),"Bronze Birch Borer"!=r.pest&&"Emerald Ash Borer"!=r.pest&&"Lilac Borer"!=r.pest&&"Magnolia Scale"!=r.pest||(d=!0,c=u+"/v0/agdd/double-sine/pointTimeSeries?climateProvider=NCEP&temperatureUnit=fahrenheit&startDate="+(i=r.extent.current.date.getFullYear()+"-01-01")+"&endDate="+(o=r.extent.current.date.toISOString().split("T")[0])+"&lowerThreshold="+(s=50)+"&upperThreshold="+(l=150)+"&latitude="+e.lat()+"&longitude="+e.lng()),d?(d=f.defer(),t.point="",h.get(c,{params:{}}).then(function(e){console.log(e.data);e=e.data.timeSeries;e.length<1?t.point=0:t.point=e[e.length-1].agdd,t.gridded_point_legend=t.legend.getPointData(t.point)},d.reject)):t.gridded_point_legend=t.legend.getPointData(n),r.supports_time_series&&(t.timeSeries=function(){g(r,a,e)})}}}]).factory("GriddedInfoWindowHandler",["$log","$timeout","$compile","$rootScope",function(l,c,d,u){function e(e){this.map=e}return e.prototype.open=function(r,a,i){var o,s=this.map;r&&a&&i&&(this.infoWindow||(this.infoWindow=new google.maps.InfoWindow({maxWidth:200,content:"contents"})),o=this.infoWindow,a.getGriddedData(r).then(function(e){l.debug("tuples",e);var t,n=e&&e.length?e[0]:void 0,e=u.$new();-9999===n||isNaN(n)?l.debug("received -9999 or Nan ignoring"):void 0!==(e.point=n)?(e.layer=a,e.legend=i,e.latLng=r,t=d('<div><gridded-point-info-window point="point" layer="layer" legend="legend" lat-lng="latLng"></gridded-point-info-window></div>')(e),c(function(){o.setContent(t[0]),o.setPosition(r),o.open(s)})):l.debug("undefined point?")},function(){l.error("unable to get gridded data.")}))},e.prototype.close=function(){this.infoWindow&&this.infoWindow.close()},e}]).directive("griddedOpacitySlider",["$log","$timeout","WmsService",function(e,t,n){return{restrict:"E",template:'<div ng-if="layer" class="form-group"><label for="griddedOpacitySlider" style="margin-bottom: 15px;">Opacity</label><rzslider rz-slider-model="selection.opacity" rz-slider-options="options"></rzslider></div>',scope:{layer:"="},link:function(e){function t(){e.layer&&e.layer.googleLayer.setOpacity(e.selection.opacity/100)}e.selection={opacity:75},e.options={floor:0,ceil:100,step:1},e.$watch("layer.extent.current",t),e.$watch("selection.opacity",t),e.$watch("layer",t)}}}]).directive("griddedRangeSlider",["$log","$timeout","WmsService",function(a,n,e){return{restrict:"E",template:'<div ng-if="legend" class="form-group"><label for="griddedRangeSlider" style="margin-bottom: 15px;">Range</label><rzslider rz-slider-model="selection.min" rz-slider-high="selection.max" rz-slider-options="options"></rzslider></div>',scope:{layer:"="},link:function(r){var e;function t(){e&&n.cancel(e),e=n(function(){var e=r.layer,t=r.legend,n=r.data;if(t&&n){if(r.selection.min===r.options.floor&&r.selection.max===r.options.ceil)return e.setStyleRange(void 0);e.setStyleRange([r.selection.min,r.selection.max])}},500)}r.$watch("layer",function(n){delete r.legend,n&&n.getLegend().then(function(e){r.legend=e,a.debug("legend",e);var t=r.data=e.getData(),e=n.getStyleRange();r.selection={min:e?e[0]:0,max:e?e[1]:t.length-1},r.options={floor:0,ceil:t.length-1,step:1,showTicks:!0,showSelectionBar:!0,translate:function(e){return t[e].label},getTickColor:function(e){return t[e].color},getPointerColor:function(e){return t[e].color},getSelectionBarColor:function(e){return t[e].color}}})}),r.$watch("selection.min",t),r.$watch("selection.max",t)}}}]).directive("griddedDoyControl",["$log","thirtyYearAvgDayOfYearFilter",function(i,t){var n=t(1,!0).getFullYear(),o=d3.range(0,12).map(function(e){return new Date(n,e)});return{restrict:"E",templateUrl:"js/gridded/doy-control.html",scope:{layer:"="},link:function(r){var n;function a(e){r.selection.month.setDate(e);var n=t(r.selection.month);i.debug("doy-control:date "+n),r.layer.extent.current=r.layer.extent.values.reduce(function(e,t){return e||(t.label===n?t:void 0)},void 0)}r.months=o,r.$watch("layer",function(e){n=t(r.layer.extent.current.value,!0),r.selection={month:o[n.getMonth()],date:n.getDate()}}),r.$watch("selection.month",function(e){var t;i.debug("doy-control:month "+(e.getMonth()+1),e),r.dates=d3.range(1,(11===(e=(t=e).getMonth())?31:((t=new Date(t.getTime())).setDate(1),t.setMonth(t.getMonth()+1),t.setTime(t.getTime()-864e5),i.debug("last day of month "+(e+1)+" is "+t),t.getDate()))+1),n?n=void 0:1===r.selection.date?a(1):r.selection.date=1}),r.$watch("selection.date",a)}}}]).directive("griddedYearControl",["$log",function(e){return{restrict:"E",templateUrl:"js/gridded/year-control.html",scope:{layer:"="},link:function(e){}}}]).directive("griddedDateControl",["$log","dateFilter",function(a,i){return{restrict:"E",templateUrl:"js/gridded/date-control.html",scope:{layer:"="},link:function(t){t.$watch("layer",function(e){e&&e.extent.current&&(t.options={minDate:e.extent.values[0].date,maxDate:e.extent.values[e.extent.values.length-1].date},t.selection=e.extent.current.date)},!1),t.open=function(){t.isOpen=!0},t.$watch("selection",function(e){a.debug("selection",e);var n="longDate",r=i(e,n);t.layer.extent.current=t.layer.extent.values.reduce(function(e,t){return e||(r===i(t.date,n)?t:void 0)},void 0)})}}}]).directive("pestDateControl",["$log","dateFilter",function(a,i){return{restrict:"E",templateUrl:"js/pest/date-control.html",scope:{layer:"="},link:function(t){t.$watch("layer",function(e){e&&e.extent.current&&(t.options={minDate:new Date((new Date).getFullYear()-1,0,1),maxDate:new Date((new Date).getTime()+5184e5)},t.selection=e.extent.current.date)},!0),t.open=function(){t.isOpen=!0},t.$watch("selection",function(e){a.debug("selection",e);var n="longDate",r=i(e,n);t.layer.extent.current=t.layer.extent.values.reduce(function(e,t){return e||(r===i(t.date,n)?t:void 0)},void 0)})}}}]).directive("pestLayerControl",["$log",function(e){return{restrict:"E",templateUrl:"js/pest/pest-layer-control.html",link:function(e){e.categories=["Insect Pest Forecast","Tree Budburst Forecast","Pollen Forecast"],e.pests=["Apple Maggot","Asian Longhorned Beetle","Bagworm","Bronze Birch Borer","Eastern Tent Caterpillar","Emerald Ash Borer","Gypsy Moth","Hemlock Woolly Adelgid","Magnolia Scale","Lilac Borer","Pine Needle Scale","Winter Moth","Buffelgrass"]}}}]).directive("griddedLayerControl",["$log",function(e){return{restrict:"E",templateUrl:"js/gridded/layer-control.html",link:function(e){}}}]).directive("pestLegend",["$log","$window",function(h,n){return{restrict:"E",templateUrl:"js/gridded/pest-legend.html",scope:{legendId:"@",legend:"="},link:function(g,e){var f=e.find("svg")[0];function t(){var e=g.legend,t=d3.select(f);if(t.selectAll("g").remove(),e){h.debug("legend.title",e.getTitle()),h.debug("legend.length",e.length),h.debug("legend.colors",e.getColors()),h.debug("legend.quantities",e.getQuantities()),h.debug("legend.labels",e.getLabels()),h.debug("legend.original_labels",e.getOriginalLabels());for(var n=parseFloat(t.style("width").replace("px","")),r=parseFloat(t.style("height").replace("px","")),a=e.getData(),i=20,o=[],s=0;s<a.length;s++)-1==a[s].original_label.indexOf("ignore")&&o.push(a[s]);a=o,h.debug("svg dimensions",n,r),h.debug("legend cell width",i);n=t.append("g");n.selectAll("g.cell").data(a).enter().append("g").attr("class","cell").attr("transform",function(e,t){return"translate(0,"+t*i+")"}).append("rect").attr("height",20).attr("width",i).style("stroke","black").style("stroke-width","1px").style("fill",function(e,t){return e.color}).append("title").text(function(e){return e.label});for(var l,c,d,u=n.selectAll("g.cell")[0],p=(Math.floor(u.length/2),0);p<a.length;p++)l=d3.select(u[p]),c=a[p].original_label,d="start",l.append("text").attr("dx","2.4em").attr("dy",i/1.5).style("text-anchor",d).text(c);r=20*a.length,n=document.getElementsByClassName("pest-legend");n[0].style.height=48+r+10+"px","Hemlock Woolly Adelgid"==e.pest||"Asian Longhorned Beetle"==e.pest||"Eastern Tent Caterpillar"==e.pest||"Magnolia Scale"==e.pest||"Pine Needle Scale"==e.pest||"Winter Moth"==e.pest||"Bagworm"==e.pest||"Gypsy Moth"==e.pest?n[0].style.width="445px":n[0].style.width="350px";n=null;"Emerald Ash Borer"==e.pest||"Lilac Borer"==e.pest||"Apple Maggot"==e.pest||"Winter Moth"==e.pest||"Magnolia Scale"==e.pest||"Bronze Birch Borer"==e.pest?n="Base: 50F, Start: Jan 1":"Pine Needle Scale"==e.pest||"Eastern Tent Caterpillar"==e.pest||"Bagworm"==e.pest?n="Base: 50F, Start: Mar 1":"Gypsy Moth"==e.pest?n="Base: 37.4F, Upper: 104F, Start: Jan 1":"Asian Longhorned Beetle"==e.pest?n="Base: 50F, Upper: 86F, Start: Jan 1":"Hemlock Woolly Adelgid"==e.pest&&(n="Base: 32F, Start: Jan 1"),n?(t.append("g").append("text").attr("dx",5).attr("dy",20+r).attr("font-size","16px").attr("text-anchor","right").text(e.pest+" Forecast, "+e.ldef.extent.current.label),t.append("g").append("text").attr("dx",5).attr("dy",38+r).attr("font-size","14px").attr("text-anchor","right").text(n),t.append("g").append("text").attr("dx",5).attr("dy",54+r).attr("font-size","11px").attr("text-anchor","right").text("USA National Phenology Network, www.usanpn.org")):(t.append("g").append("text").attr("dx",5).attr("dy",30+r).attr("font-size","16px").attr("text-anchor","right").text(e.pest+" Forecast, "+e.ldef.extent.current.label),t.append("g").append("text").attr("dx",5).attr("dy",48+r).attr("font-size","11px").attr("text-anchor","right").text("USA National Phenology Network, www.usanpn.org"))}}g.$watch("legend",t),$(n).bind("resize",t),g.$watch("legend.layer.extent.current",t),g.$on("$destroy",function(){h.debug("legend removing resize handler"),$(n).unbind("resize",t)})}}}]).filter("thirtyYearAvgDayOfYear",["dateFilter",function(n){var r=new Date(2010,0);return function(e,t){"string"==typeof e&&(e=parseFloat(e));e=e instanceof Date?e:new Date(r.getTime()+864e5*(e-1));return t?e:n(e,"MMMM d")}}]).directive("griddedLegend",["$log","$window",function(v,n){return{restrict:"E",templateUrl:"js/gridded/legend.html",scope:{legendId:"@",legend:"="},link:function(h,e){var m=e.find("svg")[0];function t(){var e,n,a,i,r,o,s,l,c,d,t,u,p=h.legend,g=d3.select(m);function f(e,t,n){var r=2+i+3;e.append("line").attr("x1",a/2).attr("y1",r).attr("x2",a/2).attr("y2",r+5).attr("stroke","black").attr("stroke-width","1"),e.append("text").attr("dx",a/2).attr("dy","3.8em").style("text-anchor",n).text(t)}g.selectAll("g").remove(),p&&(v.debug("legend.title",p.getTitle()),v.debug("legend.length",p.length),v.debug("legend.colors",p.getColors()),v.debug("legend.quantities",p.getQuantities()),v.debug("legend.labels",p.getLabels()),v.debug("legend.original_labels",p.getOriginalLabels()),e=parseFloat(g.style("width").replace("px","")),t=parseFloat(g.style("height").replace("px","")),n=p.getData(),a=e/n.length,i=30,v.debug("svg dimensions",e,t),v.debug("legend cell width",a),t=(u=g.append("g")).selectAll("g.cell").data(n).enter().append("g").attr("class","cell").attr("transform",function(e,t){return"translate("+t*a+",2)"}).append("rect").attr("height",i).attr("width",a).style("stroke","black").style("stroke-width","1px").style("fill",function(e,t){return e.color}),p.ldef.legend_delimiter_every&&(r=p.ldef.legend_delimiter_every,o=0,s=n.map(function(e,t){return t+1===n.length||(o+=n[t+1].quantity-n[t].quantity,r<=o&&!(o=0))}),l=[1+a,i,1+a,i].join(","),c=[2*a+i,i].join(","),d=[1+a,i,a+i+1,0].join(","),v.debug("legend_delimiter_every",r),t.style("stroke-dasharray",function(e,t){return 0===t?s[t]?void 0:d:s[t]?c:l}).attr("width",function(e,t){var n=parseFloat(d3.select(this).attr("width"));return s[t]?n:n+1}),u.selectAll("g.cell").append("line").attr("stroke",function(e,t){return s[t]?"black":"none"}).attr("stroke-width",2).attr("x1",a-1).attr("x2",a-1).attr("y1",0).attr("y2",i)),t.append("title").text(function(e){return e.label}),t=u.selectAll("g.cell")[0],u=Math.floor(t.length/2),f(d3.select(t[0]),n[0].label,"start"),f(d3.select(t[u]),n[u].label,"middle"),f(d3.select(t[t.length-1]),n[n.length-1].label,"end"),p.ldef.legend_units&&g.append("g").append("text").attr("dx",e/2).attr("dy",77).attr("text-anchor","middle").text(p.ldef.legend_units),p.ldef.extent&&p.ldef.extent.current?g.append("g").append("text").attr("dx",5).attr("dy",102).attr("font-size","18px").attr("text-anchor","right").text(p.ldef.title+", "+p.ldef.extent.current.label):g.append("g").append("text").attr("dx",5).attr("dy",102).attr("font-size","18px").attr("text-anchor","right").text(p.ldef.title+" (2001-2017)"),g.append("g").append("text").attr("dx",5).attr("dy",120).attr("font-size","11px").attr("text-anchor","right").text("USA National Phenology Network, www.usanpn.org"))}h.$watch("legend",t),$(n).bind("resize",t),h.$watch("legend.layer.extent.current",t),h.$on("$destroy",function(){v.debug("legend removing resize handler"),$(n).unbind("resize",t)})}}}]).filter("thirtyYearAvgDayOfYear",["dateFilter",function(n){var r=new Date(2010,0);return function(e,t){"string"==typeof e&&(e=parseFloat(e));e=e instanceof Date?e:new Date(r.getTime()+864e5*(e-1));return t?e:n(e,"MMMM d")}}]).filter("legendDoy",["dateFilter",function(r){var a=new Date(2010,0),i=new Date((new Date).getFullYear(),0);return function(e,t,n){return 0===(e=Math.round(e))&&(e=1),t=t||"MMM d",r(new Date((n?i:a).getTime()+864e5*(e-1)),t)}}]).filter("legendGddUnits",["numberFilter",function(n){return function(e,t){return n(e,0)+(t?" AGDD":"")}}]).filter("legendInchesUnits",["numberFilter",function(e){return function(e,t){return e.toFixed(2)+(t?" inches":"")}}]).filter("legendDegrees",["numberFilter",function(n){return function(e,t){return n(e,0)+""+(t||"F")}}]).filter("legendAgddAnomaly",["numberFilter",function(r){return function(e,t){if(0===e)return"No Difference";var n=e<0;return r(Math.abs(e),0)+(t?" AGDD ":" ")+(n?"<":">")+" Avg"}}]).filter("agddDefaultTodayElevation",["dateFilter",function(e){var n=e(new Date,"MMMM d");return function(e){return e.reduce(function(e,t){return e||(t.label==n?t:void 0)},void 0)}}]).filter("agddDefaultTodayTime",["dateFilter",function(e){var n=e(new Date,"longDate");return function(e){return e.reduce(function(e,t){return e||(t.label==n?t:void 0)},void 0)}}]).filter("legendSixAnomaly",[function(){return function(e){if(0===e)return"No Difference";var t=e<0;return Math.abs(e)+" Days "+(t?"Early":"Late")}}]).filter("extentDates",["$log","dateFilter","DateExtentUtil",function(e,n,i){function o(e){var t=new Date;return"yesterday"===e||"today"===e||"tomorrow"===e?("yesterday"===e?t.setTime(t.getTime()-864e5):"tomorrow"===e&&t.setTime(t.getTime()+864e5),e=n(t,"yyyy-MM-dd 00:00:00")):-1===e.indexOf("T")&&(e=t.getFullYear()+"-"+e+" 00:00:00"),i.parse(e).getTime()}return function(e,t,n){var r=t?o(t):void 0,a=n?o(n):void 0;return(r||a)&&(e=e.filter(function(e){e=i.parse(e).getTime();return(!r||r&&r<e)&&(!a||a&&e<a)})),e}}]).service("WmsService",["$log","$q","$http","$sce","$httpParamSerializer","$filter","DateExtentUtil","WcsService","Analytics",function(p,g,f,h,m,v,r,y,b){var w,x,i,o,s,e=f.get("map-vis-layers.json"),k="1.1.1",_={},t={baseUrl:x,getLayers:function(r){function n(){var e=angular.copy(o),n=e.description;return e.categories.forEach(function(e){var t=angular.copy(e);delete t.name,delete t.layers,t.description=t.description||n,e.layers=e.layers.map(function(e){return new l(r,angular.extend(angular.copy(t),s[e.name],e))})}),e}var a=g.defer();return o&&s?a.resolve(n()):e.then(function(e){var t;o=e.data,t=o.geo_server.url,i=(x=(w=t)+"/wms")+"?service=wms&version="+k+"&request=GetCapabilities",p.debug("layer_config",e.data),f.get(i).then(function(e){e=$($.parseXML(e.data));s=function(e){if(!e||e.length<2)return;var n=[];return e.slice(1).each(function(e,t){n.push(t)}),n.map(c).reduce(function(e,t){return e[t.name]=t,e},{})}(e.find("Layer")),p.debug("wms_layer_defs",s),a.resolve(n())},a.reject)},a.reject),a.promise}};function S(e,t,n){function r(n){var r=v(n.name);return function(e,t){t=[t];return n.args&&(t=t.concat(n.args)),r.apply(void 0,t)}}var i=t.legend_label_filter?r(t.legend_label_filter):angular.identity,a=t.gridded_label_filter?r(t.gridded_label_filter):void 0,o=e.find("ColorMapEntry");0===o.length&&(o=e.find("sld\\:ColorMapEntry")),o=o.toArray().reduce(function(e,t,n){var r=$(t),a=parseFloat(r.attr("quantity")),t=r.attr("label");return e.push({color:r.attr("color"),quantity:a,original_label:t,label:0===n?t:i(t,a)}),e},[]),this.styleDefinition=n,this.ldef=t,this.lformat=i,this.gformat=a,this.title_data=o[0],this.data=o.slice(1),this.length=this.data.length}function l(a,l){var t,e,n;l.extent_values_filter&&(p.debug("layer "+l.name+" has an extent_values_filter, processing",l.extent_values_filter),e=v(l.extent_values_filter.name),n=[l.extent.values.map(function(e){return e.value})].concat(l.extent_values_filter.args||[]),t=e.apply(void 0,n),p.debug("filteredValues",1<t.length?t[0]+"..."+t[t.length-1]:t),l.extent.values=l.extent.values.filter(function(e){return-1!==t.indexOf(e.value)}),l.extent.current&&-1===t.indexOf(l.extent.current.value)&&(p.debug("current extent value has become invalid, replacing with last option"),l.extent.current=l.extent.values.length?l.extent.values[l.extent.values.length-1]:void 0)),l.extent_default_filter&&(p.debug("layer "+l.name+" has an extent_default_filter, processing",l.extent_default_filter),e=v(l.extent_default_filter.name),n=[l.extent.values].concat(l.extent_default_filter.values||[]),l.extent.current=e.apply(void 0,n)||l.extent.current,p.debug("resulting default value",l.extent.current)),l.description&&(l.$description=h.trustAsHtml(l.description));var i,r,o=256,s={service:"WMS",request:"GetMap",version:k,layers:l.name,styles:"",format:"image/png",transparent:!0,height:o,width:o,srs:"EPSG:3857"},c=new google.maps.ImageMapType({getTileUrl:function(e,t){var n=a.getProjection(),r=Math.pow(2,t),t=n.fromPointToLatLng(new google.maps.Point(e.x*o/r,e.y*o/r)),e=n.fromPointToLatLng(new google.maps.Point((e.x+1)*o/r,(e.y+1)*o/r)),r=u(t),t=u(e),e={};d.extent&&d.extent.current&&d.extent.current.addToWmsParams(e);r={bbox:[r.lng,t.lat,t.lng,r.lat].join(",")};return i&&(r.sld_body=i),x+"?"+m(angular.extend(e,s,r))},tileSize:new google.maps.Size(o,o),isPng:!0,name:l.title||l.name}),d=angular.extend({},l,{googleLayer:c,getMap:function(){return a},getStyleRange:function(){return d.styleRange},setStyleRange:function(o){var s=this;(s.styleRange=o)?s.getLegend().then(function(e){for(var t=e.getStyleDefinition(),n=e.getData(),r=n[o[0]].quantity,a=n[o[1]].quantity,i=$(t),e=i.find("ColorMapEntry"),n=i.find("ColorMap");2<t[0].firstElementChild.firstElementChild.children.length;)t[0].firstElementChild.firstElementChild.removeChild(t[0].firstElementChild.firstElementChild.lastChild);0===e.length&&(e=i.find("sld\\:ColorMapEntry")),0===n.length&&(n=i.find("sld\\:ColorMap")),n&&n.attr("type","intervals"),e.each(function(){var e=$(this),t=parseInt(e.attr("quantity"));e.attr("opacity",r<t&&t<=a?"1.0":"0.0")});e=t[0],e=e=window.ActiveXObject?e.xml:(new XMLSerializer).serializeToString(e);s.setStyle(e)}):s.setStyle(void 0)},setStyle:function(e){e!==i&&(e&&p.debug("style:",e),i=e,this.bounce())},getBounds:function(){if(l.bbox)return l.bbox.getBounds()},supportsData:function(){return"boolean"!=typeof l.supports_data||l.supports_data},currentYearOnly:function(){return"boolean"==typeof l.current_year_only&&l.current_year_only},getTitle:function(){return d.title?d.title.replace(/^(.*?)\s+-\s+(.*)$/,"$2"):void 0},getAbstract:function(){return d.abstract?d.abstract.replace(/\s*developer notes.*$/i,""):void 0},fit:function(){var e=d.getBounds();return e&&a.fitBounds(e),d},bounce:function(){return a.overlayMapTypes.length&&a.overlayMapTypes.pop(),a.overlayMapTypes.push(c),d},bouncePest:function(e){if(!e)return r&&r.setMap(null),d;var t=g.defer(),n="https://data.usanpn.org/geoservices";(location.hostname.includes("local")||location.hostname.includes("dev"))&&(n="https://data-dev.usanpn.org/geoservices");e=n+"/v1/phenoforecasts/pestMap?species="+e+"&date="+d.extent.current.value.substring(0,10);f.get(e,{params:{}}).then(function(e){var t={north:e.data.bbox[3],south:e.data.bbox[1],east:e.data.bbox[2],west:e.data.bbox[0]};return r&&r.setMap(null),(r=new google.maps.GroundOverlay(e.data.clippedImage,t,{clickable:!1})).setOpacity(.75),r.setMap(a),d},t.reject)},on:function(){return b.trackEvent("gridded-layer","on",this.getTitle()),a.overlayMapTypes.push(c),d},onPest:function(){return b.trackEvent("gridded-layer","on",this.getTitle()),d},off:function(){return a.overlayMapTypes.length&&(b.trackEvent("gridded-layer","off",this.getTitle()),a.overlayMapTypes.pop()),r&&r.setMap(null),d},offPest:function(){return a.overlayMapTypes.length&&(b.trackEvent("gridded-layer","off",this.getTitle()),a.overlayMapTypes.pop()),r&&r.setMap(null),d},getLegend:function(){var o=this,s=g.defer();return f.get(x,{params:{service:"wms",request:"GetStyles",version:k,layers:l.name}}).then(function(e){p.debug("legend response",e);var t=$($.parseXML(e.data)),n=t.find("ColorMap"),e=t.find("UserStyle");0===n.length&&(n=t.find("sld\\:ColorMap"),e=t.find("sld\\:UserStyle"));var r=e.toArray(),a=0,i=0;if("Emerald Ash Borer"===o.pest)for(i=0;i<r.length;i++)"emerald_ash_borer"===r[i].firstElementChild.textContent&&(a=i);else if("Eastern Tent Caterpillar"===o.pest)for(console.log("easter tent caterpillar"),i=0;i<r.length;i++)"eastern_tent_caterpillar"===r[i].firstElementChild.textContent&&(a=i);else if("Asian Longhorned Beetle"===o.pest)for(console.log("asian longhorned beetle"),i=0;i<r.length;i++)"asian_longhorned_beetle"===r[i].firstElementChild.textContent&&(a=i);else if("Gypsy Moth"===o.pest)for(console.log("gypsy moth"),i=0;i<r.length;i++)"gypsy_moth"===r[i].firstElementChild.textContent&&(a=i);else if("Apple Maggot"===o.pest)for(console.log("apple maggot"),i=0;i<r.length;i++)"apple_maggot"===r[i].firstElementChild.textContent&&(a=i);else if("Hemlock Woolly Adelgid"===o.pest)for(i=0;i<r.length;i++)"hemlock_woolly_adelgid"===r[i].firstElementChild.textContent&&(a=i);else if("Winter Moth"===o.pest)for(i=0;i<r.length;i++)"winter_moth"===r[i].firstElementChild.textContent&&(a=i);else if("Lilac Borer"===o.pest)for(i=0;i<r.length;i++)"lilac_borer"===r[i].firstElementChild.textContent&&(a=i);else if("Bagworm"===o.pest)for(i=0;i<r.length;i++)"bagworm"===r[i].firstElementChild.textContent&&(a=i);else if("Bronze Birch Borer"===o.pest)for(i=0;i<r.length;i++)"bronze_birch_borer"===r[i].firstElementChild.textContent&&(a=i);else if("Magnolia Scale"===o.pest)for(i=0;i<r.length;i++)"magnolia_scale"===r[i].firstElementChild.textContent&&(a=i);else if("Pine Needle Scale"===o.pest)for(i=0;i<r.length;i++)"pine_needle_scale"===r[i].firstElementChild.textContent&&(a=i);_[l.name]=0!==n.length?new S($(n.toArray()[a]),l,t):void 0,s.resolve(_[l.name]),s.resolve(_[l.name].setLayer(o))},s.reject),s.promise},getGriddedData:function(e){return y.getGriddedData(w,this,e,5)}});return d;function u(e){if(!(180<Math.abs(e.lng())||90<Math.abs(e.lat()))){var t=6378137*(.017453292519943295*e.lng()),e=.017453292519943295*e.lat();return{lng:t,lat:3189068.5*Math.log((1+Math.sin(e))/(1-Math.sin(e)))}}}}function c(e){var t=$(e),e={name:t.find("Name").first().text(),title:t.find("Title").first().text().replace(/\((.+?)\)/g,""),abstract:t.find("Abstract").first().text(),bbox:function(e){if(e.length){var t={westBoundLongitude:parseFloat(e.find("westBoundLongitude").text()),eastBoundLongitude:parseFloat(e.find("eastBoundLongitude").text()),southBoundLatitude:parseFloat(e.find("southBoundLatitude").text()),northBoundLatitude:parseFloat(e.find("northBoundLatitude").text()),getBounds:function(){return new google.maps.LatLngBounds(new google.maps.LatLng(t.southBoundLatitude,t.westBoundLongitude),new google.maps.LatLng(t.northBoundLatitude,t.eastBoundLongitude))}};return[t.westBoundLongitude,t.eastBoundLongitude,t.southBoundLatitude,t.northBoundLatitude].reduce(function(e,t){return e||0===t||-1===t},!1)?void 0:t}}(t.find("EX_GeographicBoundingBox").first()),style:function(e){e=$(e);return{name:e.find("Name").first().text(),title:e.find("Title").first().text().replace(/\((.+?)\)/g,""),legend:e.find("OnlineResource").attr("xlink:href")}}(t.find("Style").first()),extent:function(e){var t,n,r,a,i=$(e),e=i.text(),o=i.attr("default"),i=i.attr("name"),s="yyyy";if(!i||!e)return;function l(e,t){return e||(t.value==o?t:void 0)}if("time"===i){if(-1===e.indexOf("/"))return t=e.split(",").map(function(e){return new d(e)}),o=o.replace(/0Z/,"0.000Z"),{label:"Date",type:"date",current:t.reduce(l,void 0),values:t};if(t=/^([^\/]+)\/(.*)\/P1Y$/.exec(e),t&&3===t.length&&(n=new d(t[1],s),(r=new d(t[2],s)).date.getFullYear()>n.date.getFullYear())){for(t=[n],a=n.date.getFullYear()+1;a<r.date.getFullYear();a++)t.push(new d(a+"-01-01T00:00:00.000Z",s));return t.push(r),{label:"Year",type:"year",current:r,values:t}}}else if("elevation"===i)return t=e.split(",").map(function(e){return new u(e)}),{label:"Day of Year",type:"doy",current:t.reduce(l,void 0),values:t}}(t.find("Extent").first())};return e.bbox||(e.bbox=function(e){if(e.length){var t={westBoundLongitude:parseFloat(e.attr("minx")),eastBoundLongitude:parseFloat(e.attr("maxx")),southBoundLatitude:parseFloat(e.attr("miny")),northBoundLatitude:parseFloat(e.attr("maxy")),getBounds:function(){return new google.maps.LatLngBounds(new google.maps.LatLng(t.southBoundLatitude,t.westBoundLongitude),new google.maps.LatLng(t.northBoundLatitude,t.eastBoundLongitude))}};return t}}(t.find("LatLonBoundingBox").first())),e}function d(t,e){var n=r.parse(t);return{value:t,date:n,label:v("date")(n,e||"longDate"),addToWmsParams:function(e){e.time=t},addToWcsParams:function(e){e.subset||(e.subset=[]),e.subset.push('http://www.opengis.net/def/axis/OGC/0/time("'+t+'")')}}}function u(t){return{value:t,label:v("thirtyYearAvgDayOfYear")(t),addToWmsParams:function(e){e.elevation=t},addToWcsParams:function(e){e.subset||(e.subset=[]),e.subset.push("http://www.opengis.net/def/axis/OGC/0/elevation("+t+")")}}}return S.prototype.setLayer=function(e){return this.layer=e,this},S.prototype.getData=function(){return this.data},S.prototype.getStyleDefinition=function(){return this.styleDefinition},S.prototype.getTitle=function(){return this.title_data.label},S.prototype.getColors=function(){return this.data.map(function(e){return e.color})},S.prototype.getQuantities=function(){return this.data.map(function(e){return e.quantity})},S.prototype.getLabels=function(){return this.data.map(function(e){return e.label})},S.prototype.getOriginalLabels=function(){return this.data.map(function(e){return e.original_label})},S.prototype.formatPointData=function(e){return(this.gformat||this.lformat)(e,e)},S.prototype.getPointData=function(e){for(var t,n,r=0;r<this.data.length;r++){if(t=this.data[r],n=r+1<this.data.length?this.data[r+1]:void 0,e==t.quantity)return t;if(n&&e>=t.quantity&&e<n.quantity)return t}},t}]).service("WcsService",["$log","$q","$http","uiGmapGoogleMapApi",function(s,l,c,e){return e.then(function(e){s.debug("WcsService: adding functionality to Number/Google Maps prototypes."),Number.prototype.toRad=function(){return this*Math.PI/180},Number.prototype.toDeg=function(){return 180*this/Math.PI},e.LatLng.prototype.destinationPoint=function(e,t){t/=6371,e=e.toRad();var n=this.lat().toRad(),r=this.lng().toRad(),a=Math.asin(Math.sin(n)*Math.cos(t)+Math.cos(n)*Math.sin(t)*Math.cos(e)),n=r+Math.atan2(Math.sin(e)*Math.sin(t)*Math.cos(n),Math.cos(t)-Math.sin(n)*Math.sin(a));return isNaN(a)||isNaN(n)?null:new google.maps.LatLng(a.toDeg(),n.toDeg())}}),{getGriddedData:function(e,t,n,r){var a=e+"/wcs",i=l.defer(),o=[0,80,180,270].map(function(e){return n.destinationPoint(e,r/2)}),e={service:"WCS",request:"GetCoverage",version:"2.0.1",coverageId:t.name.replace(":","__"),format:"application/gml+xml",subset:[]};return e.subset.push("http://www.opengis.net/def/axis/OGC/0/Long("+[o[3].lng(),o[1].lng()].join(",")+")"),e.subset.push("http://www.opengis.net/def/axis/OGC/0/Lat("+[o[2].lat(),o[0].lat()].join(",")+")"),t.extent&&t.extent.current&&(null!=t.pest?e.subset.push('http://www.opengis.net/def/axis/OGC/0/time("'+t.extent.current.value+'")'):t.extent.current.addToWcsParams(e)),s.debug("wcsArgs",e),c.get(a,{params:e}).then(function(e){s.debug("wcs response",e);var t=$($.parseXML(e.data)),e=t.find("tupleList").text();s.debug("wcs_data",t),s.debug("tuples",e),e?i.resolve(e.trim().split(" ").map(function(e){return parseFloat(e)})):i.reject()},i.reject),i.promise}}}]),angular.module("npn-viz-tool.help",[]).factory("HelpService",["$timeout",function(n){var r,a="look-at-me",i={lookAtMe:function(e,t){r&&i.stopLookingAtMe(r),$(e).hasClass(a)||n(function(){$(e).addClass(a),r=e,n(function(){i.stopLookingAtMe(e)},65e3)},t||0)},stopLookingAtMe:function(e){$(e).removeClass(a),r=null}};return i}]).directive("helpVideoControl",["$http","$sce",function(e,n){return{restrict:"E",template:'<a ng-show="videos.length" title="Help" href id="help-video-control" class="btn btn-default btn-xs" ng-click="visible = !visible;"><i class="fa fa-question"></i></a><div ng-show="visible" id="help-video-content"><a class="close" href ng-click="visible = false"><i class="fa fa-times-circle-o" aria-hidden="true"></i></a><h4>{{title}}<span ng-if="selection.video"> <a href ng-click="selection.video = null"><i class="fa fa-window-close" aria-hidden="true"></i></a></span></h4><ul class="list-unstyled" ng-show="!selection.video"><li ng-repeat="video in videos"><a href ng-click="selection.video = video;">{{video.title}}</a></li></ul><span ng-if="selection.video" ng-bind-html="selection.video.$embed"></span>',scope:{},link:function(t){t.visible=!1,t.$watch("visible",function(){t.selection={}}),t.$watch("selection.video",function(e){t.title=e?e.title:"Help videos"}),e.get("help-videos.json").then(function(e){t.videos=e.data.map(function(e){return e.$embed=n.trustAsHtml(e.embed),e})})}}}]),angular.module("npn-viz-tool.layers",["npn-viz-tool.filter","ngResource"]).factory("LayerService",["$rootScope","$http","$q","$log","uiGmapIsReady","Analytics",function(o,s,l,c,e,d){var u=null,p=null,g=e.promise(1).then(function(e){return p=e[0].map,c.debug("LayerService - map is ready"),s.get("layers/layers.json").then(function(e){e=e.data;u={},e.forEach(function(e,t){e.index=t,u[e.id]=e}),c.debug("LayerService - layer list is loaded",u)})}),n={strokeColor:"#666",strokeOpacity:null,strokeWeight:1,fillColor:"#c0c5b8",fillOpacity:null,zIndex:0};function f(e){if(!e.properties.CENTER){for(var t,n,r,a,i,o=e.geometry,s="Polygon"===o.type?o.coordinates[0]:o.coordinates.reduce(function(e,t){return e.concat(t[0])},[]),l=0;l<s.length;l++)t=s[l],0===l?(a=i=t[0],n=r=t[1]):(a=Math.max(a,t[0]),i=Math.min(i,t[0]),n=Math.max(n,t[1]),r=Math.min(r,t[1]));e.properties.CENTER={latitude:r+(n-r)/2,longitude:i+(a-i)/2}}}function h(e,t){e.properties||(e.properties={}),e.properties.NAME||(e.properties.NAME=""+t)}function m(){p.data.setStyle(function(e){var t=e.getProperty("$style");return t&&"function"==typeof t?t(e):t?angular.extend(n,t):n})}function r(e){if(e.loaded){for(var t=[],n=0;n<e.loaded.length;n++)e.loaded[n].removeProperty("$style"),p.data.remove(e.loaded[n]),t.push(e.loaded[n]);return delete e.loaded,t}}return{getAvailableLayers:function(){var r=l.defer();return g.then(function(){var e,t,n=[];for(e in u)t=u[e],n.push({id:t.id,index:t.index,label:t.label,source:t.source,img:t.img,link:t.link});r.resolve(n.sort(function(e,t){return e.idx-t.idx}))}),r.promise},restyleLayers:function(){var e=l.defer();return g.then(function(){m(),e.resolve()}),e.promise},resetLayers:function(){var t=l.defer();return g.then(function(){for(var e in u)r(u[e]);t.resolve()}),t.promise},loadLayer:function(e,a){var i=l.defer();return g.then(function(){var t,r,n=u[e];if(!n)return c.debug("no such layer with id",e),i.reject(e);t=n,r=l.defer(),t.data?r.resolve(t):(o.$broadcast("layer-load-start",{}),s.get("layers/"+t.file).then(function(e){var n=e.data;"GeometryCollection"===n.type?(c.debug("Translating GeometryCollection to FeatureCollection"),n.features=[],angular.forEach(n.geometries,function(e,t){n.features.push({type:"Feature",properties:{NAME:""+t},geometry:e})}),n.type="FeatureCollection",delete n.geometries):"Topology"===n.type&&(c.debug("Translating Topojson to GeoJson"),n=topojson.feature(n,n.objects[Object.keys(n.objects)[0]])),n.features.forEach(h),n.features.forEach(f),t.data=n,r.resolve(t),o.$broadcast("layer-load-end",{})})),r.promise.then(function(e){n.style=a,n.loaded=p.data.addGeoJson(n.data),n.loaded.forEach(function(e){e.setProperty("$style",a)}),m(),d.trackEvent("filter-layer","on",n.label),i.resolve([p,n.loaded])})}),i.promise},unloadLayer:function(t){var n=l.defer();return g.then(function(){var e=u[t];if(!e)return c.debug("no such layer with id",t),n.reject(t);d.trackEvent("filter-layer","off",e.label);e=r(e);n.resolve(e)}),n.promise}}}]).directive("layerControl",["$rootScope","$q","$location","$log","LayerService","FilterService","GeoFilterArg",function(d,r,u,p,o,g,f){return{restrict:"E",templateUrl:"js/layers/layerControl.html",link:function(s){s.hasSufficientCriteria=g.hasSufficientCriteria;var a,n=[];function e(){s.layerOnMap={layer:"none"}}function i(){o.restyleLayers().then(function(){g.getFilter().hasSufficientCriteria()&&d.$broadcast("filter-rerun-phase2",{})})}function l(e,t){var n=e.getProperty("$FILTER");a=e,n||(n=new f(e,s.layerOnMap.layer.id),g.addToFilter(n),t.data.overrideStyle(e,{fillColor:"#800000"}),e.setProperty("$FILTER",n),i())}function c(e){var t=r.defer();return"none"===e?t.resolve(null):(o.loadLayer(e.id,function(e){var t={strokeOpacity:1,strokeColor:"#666",strokeWeight:1,fillOpacity:0};return e.getProperty("$FILTER")&&(t.fillColor="#800000",t.fillOpacity=.25),t}).then(function(e){var r;n.length||(r=e[0],s.$on("filter-phase2-end",function(e,t){var n;a&&(n=a.getProperty("CENTER"),r.panTo(new google.maps.LatLng(n.latitude,n.longitude)),a=null)}),n.push(r.data.addListener("mouseover",function(e){r.data.overrideStyle(e.feature,{strokeWeight:3})})),n.push(r.data.addListener("mouseout",function(e){r.data.revertStyle()})),n.push(r.data.addListener("click",function(e){s.$apply(function(){l(e.feature,r)})})),n.push(r.data.addListener("rightclick",function(n){s.$apply(function(){var e,t;e=n.feature,t=e.getProperty("$FILTER"),a=e,t&&(g.removeFromFilter(t),e.setProperty("$FILTER",null),i())})}))),t.resolve(e)}),t.promise)}e(),s.$on("filter-reset",e),o.getAvailableLayers().then(function(e){function n(){d.$broadcast("layers-ready",{})}p.debug("av.layers",e),s.layers=e;var t=u.search();if(t.g){p.debug("init layers from query arg",t.g);for(var r,t=t.g.split(";"),a=t.map(function(e){return e.substring(e.indexOf(":")+1)}),i=t[0].substring(0,t[0].indexOf(":")),o=0;o<e.length;o++)if(e[o].id===i){r=e[o];break}r&&c(r).then(function(e){var t=e[0],e=e[1];s.layerOnMap.skipLoad=!0,s.layerOnMap.layer=r,e.forEach(function(e){-1!=a.indexOf(e.getProperty("NAME"))&&l(e,t)}),n()})}else n()}),s.$watch("layerOnMap.layer",function(r,e){s.layerOnMap.skipLoad?s.layerOnMap.skipLoad=!1:e&&"none"!=e?o.unloadLayer(e.id).then(function(e){var t=g.getFilter().getGeoArgs(),n=0<t.length;t.forEach(function(e){g.removeFromFilter(e)}),e.forEach(function(e){e.setProperty("$FILTER",null)}),n&&!g.isFilterEmpty()&&d.$broadcast("filter-rerun-phase2",{}),c(r)}):r&&c(r)}),s.$on("$destroy",function(){o.resetLayers(),n.forEach(function(e){e.remove()})})}}}]),angular.module("npn-viz-tool",["templates-npnvis","npn-viz-tool.map","uiGmapgoogle-maps","ui.bootstrap","angular-google-analytics","ngAnimate"]).config(["uiGmapGoogleMapApiProvider","$logProvider","AnalyticsProvider","$locationProvider",function(e,t,n,r){r.hashPrefix(""),e.configure({key:"AIzaSyC3jyxxwpe16ahPurnsbQCrKCWEzqlxR_U",v:"3.27",libraries:["geometry","drawing"]});e=window.location.hash&&window.location.hash.match(/^#.*#debug/);t.debugEnabled(e),window.onbeforeunload=function(){return"You are about to navigate away from the USA-NPN Visualization Tool.  Are you sure you want to do this?"},n.setAccount("UA-30327499-1"),e&&n.enterDebugMode(!0)}]),angular.module("npn-viz-tool.map",["npn-viz-tool.layers","npn-viz-tool.stations","npn-viz-tool.toolbar","npn-viz-tool.filter","npn-viz-tool.bounds","npn-viz-tool.settings","npn-viz-tool.vis","npn-viz-tool.share","npn-viz-tool.export","npn-viz-tool.help","npn-viz-tool.gridded","npn-viz-tool.pest","uiGmapgoogle-maps"]).directive("npnVizMap",["$location","$timeout","uiGmapGoogleMapApi","uiGmapIsReady","RestrictedBoundsService","FilterService","GriddedControlService","HelpService",function(o,t,s,l,c,d,u,p){return{restrict:"E",templateUrl:"js/map/map.html",scope:{},controller:["$scope",function(n){var r,a={latitude:38.8402805,longitude:-97.61142369999999};function e(){n.stationView=!1}function i(){r&&(r.panTo(new google.maps.LatLng(a.latitude,a.longitude)),r.setZoom(4)),t(function(){n.stationView=!0},500),p.lookAtMe("#toolbar-icon-filter",5e3)}n.stationView=!1,s.then(function(e){var t=c.getRestrictor("base_map",new e.LatLngBounds(new google.maps.LatLng(0,-174),new google.maps.LatLng(75,-43)));n.map={center:a,zoom:4,options:{mapTypeId:e.MapTypeId.TERRAIN,mapTypeControl:!0,mapTypeControlOptions:{position:e.ControlPosition.LEFT_BOTTOM},streetViewControl:!1,panControl:!1,zoomControl:!0,zoomControlOptions:{style:e.ZoomControlStyle.SMALL,position:e.ControlPosition.RIGHT_CENTER},styles:[{featureType:"poi",elementType:"labels",stylers:[{visibility:"off"}]},{featureType:"transit.station",elementType:"labels",stylers:[{visibility:"off"}]},{featureType:"poi.park",stylers:[{visibility:"off"}]},{featureType:"landscape",stylers:[{visibility:"off"}]}]},events:{center_changed:t.center_changed}},l.promise(1).then(function(e){r=e[0].map;e=o.search();e.gl||e.d&&(e.s||e.n)||i()})}),n.$on("gridded-layer-on",e),n.$on("gridded-layer-off",function(){d.isFilterEmpty()&&!u.layer&&i()}),n.$on("filter-phase1-start",e),n.$on("filter-reset",i),n.reset=function(){d.resetFilter(),n.stationView&&(n.stationView=!1,t(i,500))},n.$on("filter-phase2-end",function(e,t){t&&t.observation&&p.lookAtMe("#toolbar-icon-visualizations",5e3)})}]}}]).directive("npnWorking",["uiGmapIsReady",function(r){return{restrict:"E",template:'<div id="npn-working" ng-show="working"><i class="fa fa-circle-o-notch fa-spin fa-5x"></i></div>',scope:{},link:function(e){function t(){e.working=!0}function n(){e.working=!1}t(),r.promise(1).then(n),e.$on("filter-phase1-start",t),e.$on("filter-phase2-start",t),e.$on("filter-rerun-phase2",t),e.$on("filter-phase2-end",n),e.$on("layer-load-start",t),e.$on("layer-load-end",n)}}}]),angular.module("npn-viz-tool.vis-map",["npn-viz-tool.vis","npn-viz-tool.filter","npn-viz-tool.filters","npn-viz-tool.settings","npn-viz-tool.gridded","ui.bootstrap","rzModule"]).directive("mapVisGeoLayer",["$log","$q","$timeout","uiGmapIsReady","FilterService",function(e,i,o,s,l){return{restrict:"E",template:"",scope:{},link:function(e,t,n){var r=l.getFilter().getGeoArgs(),a=t.parent().parent().find(".angular-google-map-container");r.length&&(o(function(){$(a.children().first().children().first().children().first().children()[1]).css("z-index","99")},1e3),s.promise(2).then(function(e){e[0].map;var t=e[1].map,e=r.map(function(e){var t=i.defer();return e.arg.toGeoJson(function(e){t.resolve(e)}),t.promise});i.all(e).then(function(e){t.data.addGeoJson({type:"FeatureCollection",features:e}),t.data.setStyle(function(e){return{clickable:!1,strokeColor:"#666",strokeOpacity:null,strokeWeight:1,fillColor:"#800000",fillOpacity:null,zIndex:0}})})}))}}}]).directive("mapVisBoundsLayer",["$log","$q","$timeout","uiGmapIsReady","FilterService","BoundsFilterArg",function(i,e,o,s,l,c){return{restrict:"E",template:"",scope:{},link:function(e,t,n){var r=l.getFilter().getBoundsArgs(),a=t.parent().parent().find(".angular-google-map-container");r.length&&(o(function(){$(a.children().first().children().first().children().first().children()[1]).css("z-index","99")},1e3),s.promise(2).then(function(e){e[0].map;var t=e[1].map,e=r.map(function(e){return new google.maps.Rectangle(angular.extend({clickable:!1,bounds:e.arg.getBounds(),map:t},c.RECTANGLE_OPTIONS))});i.debug("mapVisBoundsLayer.rectangles",e)}))}}}]).service("MapVisMarkerService",["$log",function(e){var r={PATHS:["M0 22 L22 22 L10 0 Z","M0 22 L22 22 L22 0 L0 0 Z","M4 22 L18 22 L22 10 L18 0 L4 0 L0 10 Z"],getBaseIcon:function(e){return{path:r.PATHS[e],anchor:{x:11,y:11},scale:1}},renderMarkerToSvg:function(e,t,n){t<0||t>=r.PATHS.length||(n=n||"steelblue",(e=d3.select(e)).selectAll("path").remove(),e.attr("viewBox","0 0 22 22").attr("width",16).attr("height",16),e.append("path").attr("d",r.PATHS[t]).attr("fill",n))}};return r}]).directive("mapVisFilterTags",["$log","$timeout","MapVisMarkerService",function(e,n,r){return{restrict:"E",templateUrl:"js/mapvis/filter-tags.html",scope:{mapVisFilter:"="},link:function(t){t.removeFromFilter=function(e){t.mapVisFilter.splice(e,1)},t.$watchCollection("mapVisFilter",function(){n(function(){t.mapVisFilter.forEach(function(e,t){r.renderMarkerToSvg("svg#map-vis-marker-"+t,t)})})})}}}]).directive("mapVisInSituControl",["$log","$q","$http","$url","CacheService","FilterService",function(o,s,l,c,d,u){var p=["20","1198","35","36"],g="map-vis-insitu-implicit-species";function f(e,t){var n=t.map(function(e){return e.species_id});return e.forEach(function(e){-1===n.indexOf(e.species_id)&&t.push(e)}),t}return{restrict:"E",templateUrl:"js/mapvis/in-situ-control.html",scope:{mapVisFilter:"=",layer:"=",mapVisPlot:"&"},link:function(a){var e=u.getFilter(),t=e.getDateArg(),i=0<e.getGeographicArgs().length;function n(){var e;a.layer&&(a.disableControl=!1,(a.currentYearOnly=a.layer.currentYearOnly())&&(e=a.layer.extent.current.date.getFullYear(),-1===a.years.indexOf(e)?a.disableControl=!0:a.selection.year=e))}function r(){var e=a.selection.species,t=a.selection.year;e&&t&&(a.phenophaseList=[],u.getFilter().getPhenophasesForSpecies(e.species_id,!0,[t]).then(function(e){o.debug("phenophaseList",e),a.phenophaseList=e,a.selection.phenophase=e.length?e[0]:void 0}))}a.years=d3.range(t.getStartYear(),t.getEndYear()+1),a.selection={year:a.years[0]},a.$watch("layer",n),a.$watch("layer.extent.current",n),e.getSpeciesList().then(function(e){var t,n,r;o.debug("speciesList",e),i?(o.debug("filter has geographic args, not adding implicit species."),a.speciesList=e,a.selection.species=e.length?e[0]:void 0):(o.debug("filter has no geographic args merging in implicit species."),t=e,n=s.defer(),(r=d.get(g))?n.resolve(f(r,t)):l.get(c("/npn_portal/species/getSpeciesFilter.json")).then(function(e){r=e.data.filter(function(e){return-1!==p.indexOf(e.species_id)}),o.debug("filtered implicit list of species",r),d.put(g,r,-1),n.resolve(f(r,t))}),n.promise.then(function(e){o.debug("merged",e),a.speciesList=e,a.selection.species=e.length?e[0]:void 0}))}),a.$watch("selection.species",r),a.$watch("selection.year",r),a.validSelection=function(){var n=a.selection;return!!(n.species&&n.phenophase&&n.year)&&(a.mapVisFilter.length<3&&(0===a.mapVisFilter.length||!a.mapVisFilter.reduce(function(e,t){return e||n.species===t.species&&n.phenophase===t.phenophase&&n.year===t.year},!1)))},a.addSelectionToFilter=function(){a.mapVisFilter.push(angular.extend({},a.selection))}}}}]).directive("mapVisMarkerInfoWindow",[function(){return{restrict:"E",templateUrl:"js/mapvis/marker-info-window.html"}}]).controller("MapVisCtrl",["$scope","$uibModalInstance","$filter","$log","$compile","$timeout","$q","$http","$url","uiGmapGoogleMapApi","uiGmapIsReady","RestrictedBoundsService","WmsService","ChartService","MapVisMarkerService","md5","GriddedInfoWindowHandler",function(i,e,t,o,a,s,l,c,d,n,r,u,p,g,f,h,m){var v,y,b,w,x=u.getRestrictor("map_vis");function k(){i.results.markerModels={},i.results.markers=[]}function _(){b&&b.close(),w&&w.close()}function S(){var n={data:i.speciesSelections.map(function(){return{record:null}}),getSiteId:function(){return n.site_id},restyle:function(){return n.markerOpts.icon.strokeColor=1<n.data.reduce(function(e,t){return e+(t.record?1:0)},0)?"#00ff00":"#204d74",n.markerOpts.title=n.data.reduce(function(e,t,n){return delete t.legend_data,t.record&&(t.legend_data=t.record.legend_data=i.legend.getPointData(t.record.mean_first_yes_doy)||{color:"#ffffff",label:"off scale"},""!==e&&(e+=", "),e+=i.speciesSelections[n].year,e+=": ",e+=i.legend.formatPointData(t.record.mean_first_yes_doy)),e},""),n.markerOpts.icon.fillColor=n.data[n.filter_index].legend_data.color,n.$markerKey=h.createHash(JSON.stringify(n)),n},marker:function(){return{$markerKey:n.$markerKey,site_id:n.site_id,latitude:n.latitude,longitude:n.longitude,markerOpts:n.markerOpts}},add:function(e,t){return n.data[t].record=e,n.markerOpts||(n.site_id=e.site_id,n.filter_index=t,n.latitude=e.latitude,n.longitude=e.longitude,n.markerOpts={zIndex:365-e.first_yes_doy,icon:angular.extend(f.getBaseIcon(t),{fillOpacity:1,strokeWeight:1})}),n.restyle()}};return n}i.modal=e,i.wms_map={center:{latitude:48.35674,longitude:-122.39658},zoom:3,options:{disableDoubleClickZoom:!0,scrollwheel:!0,streetViewControl:!1,panControl:!1,zoomControl:!0,zoomControlOptions:{style:google.maps.ZoomControlStyle.SMALL,position:google.maps.ControlPosition.RIGHT_TOP},styles:[{featureType:"poi",elementType:"labels",stylers:[{visibility:"off"}]},{featureType:"transit.station",elementType:"labels",stylers:[{visibility:"off"}]},{featureType:"poi.park",stylers:[{visibility:"off"}]},{featureType:"landscape",stylers:[{visibility:"off"}]}]},events:{click:function(e,t,n){n=n[0];o.debug("click",n),b&&b.open(n.latLng,i.selection.activeLayer,i.legend)},center_changed:x.center_changed}},n.then(function(e){v=e,r.promise(2).then(function(e){y=e[1].map,b=new m(y),p.getLayers(y).then(function(e){o.debug("layers",e),i.layers=e},function(){o.error("unable to get map layers?")})})}),i.selection={},i.results={},k(),i.$watch("selection.layerCategory",function(e){o.debug("layer category change ",e),i.selection.activeLayer&&(o.debug("turning off layer ",i.selection.activeLayer.name),i.selection.activeLayer.off(),delete i.selection.activeLayer,delete i.legend,_())}),i.$watch("selection.layer",function(e){e&&(_(),delete i.markerModel,o.debug("selection.layer",e),i.selection.activeLayer&&(o.debug("turning off layer ",i.selection.activeLayer.name),i.selection.activeLayer.off()),o.debug("fitting new layer ",e.name),i.selection.activeLayer=e.fit().on(),x.setBounds(e.getBounds()),delete i.legend,i.selection.activeLayer.getLegend(e).then(function(e){i.legend=e,i.selection.activeLayer.supportsData()?i.results.markers=Object.keys(i.results.markerModels).map(function(e){return i.results.markerModels[e].restyle().marker()}):k()}))}),i.$watch("selection.activeLayer.extent.current",function(e){var t,n;(t=i.selection.activeLayer)&&(o.debug("layer extent change ",t.name,e),_(),t.bounce(),t.currentYearOnly()&&(n=e.date.getFullYear(),(e=i.speciesSelections.filter(function(e){return e.year===n})).length!==i.speciesSelections.length&&(i.speciesSelections.splice(0,i.speciesSelections.length),e.forEach(function(e){i.speciesSelections.push(e)}),i.plotMarkers())))}),i.speciesSelections=[],i.$watchCollection("speciesSelections",function(e,t){o.debug("speciesSelections",e,t),t&&e&&t.length>e.length&&i.results.markers.length&&i.plotMarkers()}),i.markerEvents={click:function(t){o.debug("click",t),i.$apply(function(){var e=i.markerModel===i.results.markerModels[t.model.site_id];i.markerModel=i.results.markerModels[t.model.site_id],w=w||new v.InfoWindow({maxWidth:500,content:""}),e||w.setContent('<i class="fa fa-circle-o-notch fa-spin"></i>'),w.setPosition(t.position),w.open(t.map)})}},i.$watch("markerModel",function(n){var e,t,r;n&&(e=[],o.debug("mapVisMarkerInfoWindow.markerModel",n),n.station||(t=l.defer(),e.push(t.promise),c.get(d("/npn_portal/stations/getStationDetails.json"),{params:{ids:n.site_id}}).then(function(e){e=e.data;n.station=e&&e.length?e[0]:void 0,t.resolve()})),r=l.defer(),e.push(r.promise),delete n.gridded_legend_data,i.selection.activeLayer.getGriddedData(new google.maps.LatLng(n.latitude,n.longitude)).then(function(e){o.debug("tuples",e);var t=e&&e.length?e[0]:void 0;if(void 0===t||-9999===t||isNaN(t))return o.debug("received undefined, -9999 or Nan ignoring"),void r.resolve();e=(e=i.legend.getPointData(t))||{label:i.legend.formatPointData(t),color:"#ffffff"};n.gridded_legend_data=angular.extend({point:t},e),r.resolve()},function(){o.error("unable to get gridded data."),r.resolve()}),l.all(e).then(function(){var e=a("<div><map-vis-marker-info-window></map-vis-marker-info-window></div>")(i);s(function(){w.setContent(e.html()),s(function(){i.speciesSelections.forEach(function(e,t){n.data[t].record&&n.data[t].legend_data&&f.renderMarkerToSvg("svg#map-vis-iw-marker-"+t,t,n.data[t].legend_data.color)})},250)})}))}),i.plotMarkers=function(){_(),k(),i.working=!0;var a=i.results.markerModels,e=i.speciesSelections.map(function(t,n){var r=l.defer(),e={request_src:"npn-vis-map",start_date:t.year+"-01-01",end_date:t.year+"-12-31","species_id[0]":t.species.species_id,"phenophase_id[0]":t.phenophase.phenophase_id};return o.debug("gathering summary data for ",t,e),g.getSiteLevelData(e,function(e){o.debug("site level data has arrived for ",t,e);e=(e||[]).reduce(function(e,t){return-9999===t.mean_first_yes_doy||(a[t.site_id]?a[t.site_id].add(t,n):e.push(a[t.site_id]=(new S).add(t,n))),e},[]);o.debug("resulted in "+e.length+" added markers."),r.resolve()}),r.promise});l.all(e).then(function(){o.debug("all summary data has arrived..."),i.results.markers=Object.keys(a).reduce(function(e,t){return e.push(a[t].marker()),e},[]),i.working=!1})}}]),angular.module("templates-npnvis",["js/activity/activity.html","js/activity/curve-control.html","js/calendar/calendar.html","js/filter/choroplethInfo.html","js/filter/dateFilterTag.html","js/filter/filterControl.html","js/filter/filterTags.html","js/filter/networkFilterTag.html","js/filter/speciesFilterTag.html","js/gridded/date-control.html","js/gridded/doy-control.html","js/gridded/gridded-control.html","js/gridded/layer-control.html","js/gridded/legend.html","js/gridded/pest-legend.html","js/gridded/year-control.html","js/layers/layerControl.html","js/map/map.html","js/mapvis/filter-tags.html","js/mapvis/in-situ-control.html","js/mapvis/mapvis.html","js/mapvis/marker-info-window.html","js/pest/date-control.html","js/pest/legend.html","js/pest/pest-control.html","js/pest/pest-layer-control.html","js/scatter/scatter.html","js/settings/settingsControl.html","js/time/time.html","js/toolbar/tool.html","js/toolbar/toolbar.html","js/vis/visControl.html","js/vis/visDialog.html","js/vis/visDownload.html"]),angular.module("js/activity/activity.html",[]).run(["$templateCache",function(e){e.put("js/activity/activity.html",'<vis-dialog title="Activity Curves" modal="modal">\n<form class="form-inline plot-criteria-form">\n    <ul class="list-unstyled">\n        <li ng-repeat="input in selection.curves" class="control"><h4 ng-style="{color: input.color()}">Curve {{$index+1}}</h4><activity-curve-control input="input"></activity-curve-control></li>\n        <li  style="padding-top: 10px;">\n            <form class="form-inline">\n                <div class="form-group">\n                    <label for="frequency">Date Interval</label>\n                    <select class="form-control" id="frequency"\n                        ng-model="selection.frequency"\n                        ng-options="f as f.label for f in frequencies"></select>\n                </div>\n                <div class="form-group">\n                    <label for="interpolate">Line Interpolation</label>\n                    <select class="form-control" id="interpolate"\n                        ng-model="selection.interpolate"\n                        ng-options="i as i for i in [\'linear\',\'step-after\',\'monotone\']"></select>\n                </div>\n                \x3c!--div class="form-group">\n                    <label for="points">Data Points</label>\n                    <input type="checkbox" id="points" ng-model="selection.dataPoints" />\n                </div--\x3e\n            </form>\n        </li>\n    </ul>\n</form>\n\n<div class="panel panel-default main-vis-panel" >\n    <div class="panel-body">\n        <center>\n            <div id="vis-container">\n                <div id="vis-working" ng-show="working"><i class="fa fa-circle-o-notch fa-spin fa-5x"></i></div>\n                <activity-curves-chart selection="selection"></activity-curves-chart>\n            </div>\n        </center>\n    </div>\n</div>\n</vis-dialog>\n')}]),angular.module("js/activity/curve-control.html",[]).run(["$templateCache",function(e){e.put("js/activity/curve-control.html",'<div class="activity-curve-control">\n    <form class="form-inline">\n        <div class="form-group">\n            <label for="species-{{input.id}}">Species</label>\n            <select class="form-control" id="species-{{input.id}}"\n                ng-model="input.species"\n                ng-options="(o|speciesTitle) for o in speciesList">\n              <option ng-if="input.id > 0" value="">-- Select species --</option>\n            </select>\n        </div>\n        <div class="form-group" ng-show="input.species">\n            <label for="phenophase-{{input.id}}">Phenophase</label>\n            <select class="form-control" id="phenophase-{{input.id}}"\n                ng-model="input.phenophase"\n                ng-options="o.phenophase_name for o in input.validPhenophases"></select>\n        </div>\n        <div class="form-group" ng-show="input.species">\n            <label for="year-{{input.id}}">Year</label>\n            <select class="form-control" id="year-{{input.id}}"\n                ng-model="input.year"\n                ng-options="y for y in validYears"></select>\n        </div>\n        <div class="form-group" ng-show="input.species">\n            <label for="metric-{{input.id}}">Metric</label>\n            <select class="form-control" id="metric-{{input.id}}"\n                ng-model="input.metric"\n                ng-options="m as m.label for m in input.validMetrics"></select>\n            <label popover-placement="bottom" popover-title="Metric Description" uib-popover="{{ input.metric ? input.metric.description : \'\' }}" popover-trigger="mouseenter" popover-append-to-body="true"><i class="fa fa-info-circle" aria-hidden="true"></i></label>\n        </div>\n    </form>\n</div>\n')}]),angular.module("js/calendar/calendar.html",[]).run(["$templateCache",function(e){e.put("js/calendar/calendar.html",'<vis-dialog title="Calendar" modal="modal">\n<form class="form-inline plot-criteria-form">\n    <div class="form-group">\n        <label for="yearsOneInput">Select up to two years</label>\n        <input id="yearsOneInput" type="number" class="form-control"\n               ng-model="selection.year"\n               uib-typeahead="year for year in validYears | filter:$viewValue"\n               required placeholder="Year" />\n        <button class="btn btn-default" ng-click="addYear()" ng-disabled="!canAddYear()"><i class="fa fa-plus"></i></button>\n    </div>\n    <div class="form-group animated-show-hide">\n        <label for="speciesInput">Species phenophase combinations</label>\n        <select name="speciesInput" class="form-control" ng-model="selection.species" ng-options="(o|speciesTitle) for o in speciesList"></select>\n        <select name="phenophaseInput" class="form-control" ng-model="selection.phenophase" ng-options="o.phenophase_name for o in phenophaseList"></select>\n        <div class="btn-group" uib-dropdown is-open="selection.color_isopen">\n          <button type="button" class="btn btn-default dropdown-toggle" uib-dropdown-toggle style="background-color: {{colorRange[selection.color]}};">\n            &nbsp; <span class="caret"></span>\n          </button>\n          <ul class="dropdown-menu" role="menu">\n            <li ng-repeat="i in colors track by $index" style="background-color: {{colorRange[$index]}};"><a href ng-click="selection.color=$index;">&nbsp;</a></li>\n          </ul>\n        </div>\n        <button class="btn btn-default" ng-click="addToPlot()" ng-disabled="!canAddToPlot()"><i class="fa fa-plus"></i></button>\n    </div>\n</form>\n<div class="panel panel-default main-vis-panel" >\n    <div class="panel-body">\n        <center ng-if="error_message"><p class="text-danger">{{error_message}}</p></center>\n        <center>\n        <ul class="to-plot list-inline animated-show-hide" ng-if="toPlot.length || toPlotYears.length">\n            <li class="criteria" ng-repeat="y in toPlotYears">{{y}}\n                <a href ng-click="removeYear($index)"><i class="fa fa-times-circle-o"></i></a>\n            </li>\n            <li class="criteria" ng-repeat="tp in toPlot">{{tp|speciesTitle}}/{{tp.phenophase_name}} <i style="color: {{colorRange[tp.color]}};" class="fa fa-circle"></i>\n                <a href ng-click="removeFromPlot($index)"><i class="fa fa-times-circle-o"></i></a>\n            </li>\n            <li ng-if="data">\n                <label for="negativeInput">Absence Data</label>\n                <input type="checkbox" id="negativeInput" ng-model="selection.negative" />\n            </li>\n            <li ng-if="!data && toPlotYears.length && toPlot.length"><button class="btn btn-primary" ng-click="visualize()">Visualize</button></li>\n        </ul>\n        <div id="vis-container">\n            <div id="vis-working" ng-show="working"><i class="fa fa-circle-o-notch fa-spin fa-5x"></i></div>\n            <div class="chart-container">\n                <vis-download ng-if="data"\n                              selector=".chart"\n                              filename="npn-calendar.png"></vis-download>\n                <div><svg class="chart"></svg></div>\n            </div>\n        </div>\n        </center>\n\t\t\x3c!--\n\t\t<p class = \'citation-text\'>USA National Phenology Network, www.usanpn.org</p>\n\t\t--\x3e\n        <ul class="list-inline calendar-chart-controls" ng-if="data" style="float: right;">\n            <li>Label Size\n                <a href class="btn btn-default btn-xs" ng-click="decrFontSize()"><i class="fa fa-minus"></i></a>\n                <a href class="btn btn-default btn-xs" ng-click="incrFontSize()"><i class="fa fa-plus"></i></a>\n            </li>\n            <li>Label Position\n                <a href class="btn btn-default btn-xs" ng-click="yAxisConfig.labelOffset=(yAxisConfig.labelOffset-1)"><i class="fa fa-minus"></i></a>\n                <a href class="btn btn-default btn-xs" ng-click="yAxisConfig.labelOffset=(yAxisConfig.labelOffset+1)"><i class="fa fa-plus"></i></a>\n            </li>\n            <li>Band Size\n                <a href class="btn btn-default btn-xs" ng-click="incrBandPadding()" ng-disabled="yAxisConfig.bandPadding >= 0.95"><i class="fa fa-minus"></i></a>\n                <a href class="btn btn-default btn-xs" ng-click="decrBandPadding()" ng-disabled="yAxisConfig.bandPadding <= 0.05"><i class="fa fa-plus"></i></a>\n            </li>\n        </ul>\n    </div>\n</div>\n\n</vis-dialog>\n')}]),angular.module("js/filter/choroplethInfo.html",[]).run(["$templateCache",function(e){e.put("js/filter/choroplethInfo.html",'<div id="choroplethHelp" ng-show="show">\n    <h4>{{station_name}}</h4>\n    <h5>Record Densit{{data.length == 1 ? \'y\' : \'ies\'}}</h5>\n    <ul class="list-unstyled">\n        <li ng-repeat="scale in data">\n            <label>{{scale.title}} ({{scale.count}})</label>\n            <ul class="list-inline color-scale">\n                <li ng-repeat="color in scale.colors" style="background-color: {{color}};" class="{{scale.color === color ? \'selected\' :\'\'}}">\n                    <div ng-if="$first">{{scale.domain[0]}}</div>\n                    <div ng-if="$last">{{scale.domain[1]}}</div>\n                </li>\n            </ul>\n        </li>\n    </li>\n</div>')}]),angular.module("js/filter/dateFilterTag.html",[]).run(["$templateCache",function(e){e.put("js/filter/dateFilterTag.html",'<div class="btn-group filter-tag date">\n    <a class="btn btn-default">\n        <span popover-placement="bottom" popover-popup-delay="500" popover-append-to-body="true"\n              popover-trigger="\'mouseenter\'" uib-popover="Indicates the span of time represented on the map">{{arg.arg.start_date}} - {{arg.arg.end_date}} </span>\n        <span class="badge"\n              popover-placement="bottom" popover-popup-delay="500" popover-append-to-body="true"\n              popover-trigger="\'mouseenter\'" uib-popover="{{badgeTooltip}}">{{counts | speciesBadge:badgeFormat}}</span>\n    </a>\n    <a class="btn btn-default" ng-click="removeFromFilter(arg)">\n        <i class="fa fa-times-circle-o"></i>\n    </a>\n</div>\n')}]),angular.module("js/filter/filterControl.html",[]).run(["$templateCache",function(e){e.put("js/filter/filterControl.html",'<ul class="list-unstyled">\n    <li>\n        <label for="yearInputForm">Select up to ten (consecutive) years</label>\n        <form id="yearInputForm" name="yearInputForm">\n        <input id="start_date" type="number" class="form-control"\n               max="{{selected.date.end_date || thisYear}}"\n               ng-model="selected.date.start_date"\n               uib-typeahead="year for year in validYears | lte:selected.date.end_date | filter:$viewValue"\n               required placeholder="From" /> -\n        <input id="end_date" type="number" class="form-control"\n                min="{{selected.date.start_date || 1900}}"\n                ng-model="selected.date.end_date"\n                uib-typeahead="year for year in validYears | gte:selected.date.start_date | filter:$viewValue"\n                required placeholder="To" />\n        <button class="btn btn-default"\n                ng-disabled="yearInputForm.$invalid || ((selected.date.end_date - selected.date.start_date) > 10)"\n                ng-click="addDateRangeToFilter()"\n                popover-placement="right" popover-popup-delay="500" popover-append-to-body="true"\n                popover-trigger="\'mouseenter\'" uib-popover="Add this filter to the map"><i class="fa fa-plus"></i></button>\n        </form>\n        <p ng-if="selected.date.start_date < 2008" class="disclaimer">\n            You have selected a starting year prior to 2008 when the contemprary phenology data begins.  Prior to 2008 there is\n            a much more limited set of historical data and a limited number of species (E.g. lilac and honeysuckle).\n        </p>\n    </li>\n    <li class="divider" ng-if="filterHasDate()"></li>\n    <li ng-if="filterHasDate()">\n        <label>Animal Types</label>\n        <div isteven-multi-select\n            max-labels="3"\n            input-model="animalTypes"\n            output-model="speciesInput.animals"\n            button-label="species_type"\n            item-label="species_type"\n            tick-property="selected"\n            orientation="horizontal"\n            helper-elements="all none reset filter"\n            on-close="findSpecies()"></div>\n    </li>\n    <li ng-if="filterHasDate()">\n        <label>Plant Types</label>\n        <div isteven-multi-select\n            max-labels="3"\n            input-model="plantTypes"\n            output-model="speciesInput.plants"\n            button-label="species_type"\n            item-label="species_type"\n            tick-property="selected"\n            orientation="horizontal"\n            helper-elements="all none reset filter"\n            on-close="findSpecies()"></div>\n    </li>\n    <li ng-if="filterHasDate()">\n        <label>Partners</label>\n        <div class="row">\n            <div class="col-xs-9">\n                <div isteven-multi-select\n                    max-labels="3"\n                    input-model="partners"\n                    output-model="speciesInput.networks"\n                    button-label="network_name"\n                    item-label="network_name"\n                    tick-property="selected"\n                    orientation="horizontal"\n                    helper-elements="none reset filter"\n                    on-close="findSpecies()"></div>\n            </div>\n            <div class="col-xs-3">\n                <button id="add-networks-button" class="btn btn-default"\n                        ng-disabled="!speciesInput.networks.length || networksMaxedOut()"\n                        ng-click="addNetworksToFilter()"\n                        popover-placement="right" popover-popup-delay="500"\n                        popover-trigger="\'mouseenter\'" uib-popover="Add this filter to the map" popover-append-to-body="true">\n                    <i class="fa fa-plus"></i>\n                </button>\n            </div>\n        </div>\n\n    </li>\n    <li ng-if="filterHasDate()">\n        <label for="species">Species</label>\n        <div class="row">\n            <div class="col-xs-9">\n                <div isteven-multi-select\n                    max-labels="3"\n                    input-model="speciesList"\n                    output-model="selected.species"\n                    button-label="display"\n                    item-label="display"\n                    tick-property="selected"\n                    orientation="horizontal"\n                    helper-elements="none reset filter"></div>\n            </div>\n            <div class="col-xs-3">\n                <button id="add-species-button" class="btn btn-default"\n                        ng-disabled="!selected.species.length || speciesMaxedOut()"\n                        ng-click="addSpeciesToFilter()"\n                        popover-placement="right" popover-popup-delay="500"\n                        popover-trigger="\'mouseenter\'" uib-popover="Add this filter to the map" popover-append-to-body="true">\n                    <i class="fa" ng-class="{\'fa-refresh fa-spin\': findingSpecies, \'fa-plus\': !findingSpecies}"></i>\n                </button>\n            </div>\n        </div>\n    </li>\n    <li ng-if="filterHasDate()" style="text-align: right;">\n        <a class="btn btn-lg btn-primary" id="filter-placebo" href ng-click="$parent.$parent.close()" ng-disabled="!filterHasSufficientCriteria()">Execute Filter <i class="fa fa-search"></i></a>\n    </li>\n</ul>\n')}]),angular.module("js/filter/filterTags.html",[]).run(["$templateCache",function(e){e.put("js/filter/filterTags.html",'<ul class="list-inline filter-tags">\n    <li ng-repeat="s in getFilter().getSpeciesArgs()"><species-filter-tag arg="s"></species-filter-tag></li>\n    <li ng-repeat="n in getFilter().getNetworkArgs()"><network-filter-tag arg="n"></network-filter-tag></li>\n    <li ng-if="(date = getFilter().getDateArg())"><date-filter-tag arg="date"></date-filter-tag></li>\n</ul>')}]),angular.module("js/filter/networkFilterTag.html",[]).run(["$templateCache",function(e){e.put("js/filter/networkFilterTag.html",'<div class="btn-group filter-tag date" ng-class="{open: status.isopen}">\n    <a class="btn btn-default" ng-click="status.isopen = !status.isopen">\n        {{arg.arg.network_name}}\n        <span class="badge"\n              popover-placement="bottom" popover-popup-delay="500" popover-append-to-body="true"\n              popover-trigger="mouseenter" uib-popover="{{badgeTooltip}}">{{arg.counts | speciesBadge:badgeFormat}}</span>\n        <span class="caret"></span>\n    </a>\n    <ul class="dropdown-menu network-dd" role="menu">\n        <li class="inline">\n            <label for="ydo-{{arg.arg.network_id}}"><input id="ydo-{{arg.arg.network_id}}" type="checkbox" ng-model="arg.ydo"/> Yes Data Only</label>\n        </li>\n    </ul>\n    <a class="btn btn-default" ng-click="removeFromFilter(arg)">\n        <i class="fa fa-times-circle-o"></i>\n    </a>\n</div>\n')}]),angular.module("js/filter/speciesFilterTag.html",[]).run(["$templateCache",function(e){e.put("js/filter/speciesFilterTag.html",'<div class="btn-group filter-tag" ng-class="{open: status.isopen}">\n    <a class="btn btn-primary" style="background-color: {{arg.color}};" ng-disabled="!arg.phenophases" ng-click="status.isopen = !status.isopen">\n        {{arg.arg | speciesTitle:titleFormat}}\n        <span class="badge"\n              popover-placement="bottom" popover-popup-delay="500" popover-append-to-body="true"\n              popover-trigger="\'mouseenter\'" uib-popover="{{badgeTooltip}}">{{arg.counts | speciesBadge:badgeFormat}}</span>\n        <span class="caret"></span>\n    </a>\n    <ul class="dropdown-menu phenophase-list" role="menu">\n        <li class="inline">\n            <label for="ydo-{{arg.arg.species_id}}"><input id="ydo-{{arg.arg.species_id}}" type="checkbox" ng-model="arg.ydo"/> Yes Data Only</label>\n        </li>\n        <li class="divider"></li>\n        <li class="inline">Select <a href ng-click="selectAll(true)">all</a> <a href ng-click="selectAll(false)">none</a></li>\n        <li class="divider"></li>\n        <li ng-repeat="phenophase in arg.phenophases | filter:hasCount">\n            <label for="{{arg.arg.species_id}}-{{phenophase.phenophase_id}}"><input id="{{arg.arg.species_id}}-{{phenophase.phenophase_id}}" type="checkbox" ng-model="phenophase.selected"> <span class="badge">{{phenophase.count}}</span> {{phenophase.phenophase_name}}</label>\n        </li>\n    </ul>\n    <a class="btn btn-primary" style="background-color: {{arg.color}};" ng-click="removeFromFilter(arg)">\n        <i class="fa fa-times-circle-o"></i>\n    </a>\n</div>\n')}]),angular.module("js/gridded/date-control.html",[]).run(["$templateCache",function(e){e.put("js/gridded/date-control.html",'<label>Date</label>\n<p class="input-group">\n  <input type="text" class="form-control"\n        uib-datepicker-popup="longDate"\n        ng-model="selection"\n        is-open="isOpen"\n        datepicker-options="options"\n        close-text="Close"\n        ng-click="open()" />\n  <span class="input-group-btn">\n    <button type="button" class="btn btn-default" ng-click="open()"><i class="glyphicon glyphicon-calendar"></i></button>\n  </span>\n</p>')}]),angular.module("js/gridded/doy-control.html",[]).run(["$templateCache",function(e){e.put("js/gridded/doy-control.html",'<label>Day of Year</label>\n<div class="form-inline" style="margin-bottom: 15px;">\n    <div class="form-group">\n        <label for="selectedMonth" class="sr-only">Month</label>\n        <select id="selectedMonth" class="form-control" ng-model="selection.month"\n                ng-options="m as (m | date:\'MMMM\') for m in months"></select>\n    </div>\n    <div class="form-group" ng-if="selection.month">\n        <label for="selectedDate" class="sr-only">Day</label>\n        <select id="selectedDate" class="form-control" ng-model="selection.date"\n                ng-options="d for d in dates"></select>\n    </div>\n    <div class="form-group">\n        <input class="form-control" style="width: 50px; cursor: default;" type="text" value="{{layer.extent.current.value | number:0}}" disabled />\n    </div>\n</div>')}]),angular.module("js/gridded/gridded-control.html",[]).run(["$templateCache",function(e){e.put("js/gridded/gridded-control.html",'<p class="empty-filter-notes">Spring Index, Accumulated Growing Degree Day (AGDD), and Land Surface Phenology maps display spatial and temporal patterns in temperature, satellite observations, and predicted phenology across the United States. Use the controls below to select a gridded layer to view on the map.</p>\n<p><a href="https://www.usanpn.org/data/maps" target="_blank">More Info on Phenology Maps</a></p>\n<gridded-layer-control></gridded-layer-control>')}]),angular.module("js/gridded/layer-control.html",[]).run(["$templateCache",function(e){e.put("js/gridded/layer-control.html",'<div ng-if="layers" class="gridded-layer-control">\n    <div class="form-group">\n        <a ng-if="actions.reset && selection.layer" class="reset-layer pull-right" ng-click="actions.reset()"\n            uib-popover="Reset" popover-placement="right" popover-append-to-body="true" popover-trigger="mouseenter" popover-delay="500"><i class="fa fa-times-circle"></i></a>\n        <label for="selectedCategory">Category</label>\n        <select id="selectedCategory" class="form-control" ng-model="selection.layerCategory"\n                ng-options="cat as cat.name for cat in layers.categories | filter: \'!Precip Accumulations, Current Day\'"></select>\n\n    </div>\n    <div class="form-group" ng-if="selection.layerCategory">\n        <label for="selectedLayer">Layer</label>\n        <select id="selectedLayer" class="form-control" ng-model="selection.layer"\n                ng-options="l as l.getTitle() for l in selection.layerCategory.layers"></select>\n    </div>\n    <div class="extent-control" ng-if="selection.layer.extent" ng-switch="selection.layer.extent.type">\n        <gridded-doy-control ng-switch-when="doy" layer="selection.layer"></gridded-doy-control>\n        <gridded-date-control ng-switch-when="date" layer="selection.layer"></gridded-date-control>\n        <gridded-year-control ng-switch-when="year" layer="selection.layer"></gridded-year-control>\n    </div>\n    <gridded-opacity-slider layer="selection.layer"></gridded-opacity-slider>\n    <gridded-range-slider layer="selection.layer"></gridded-range-slider>\n    <p ng-if="selection.layer.abstract">{{selection.layer.getAbstract()}}</p>\n    <p ng-if="selection.layer.$description" ng-bind-html="selection.layer.$description"></p>\n</div>\n')}]),angular.module("js/gridded/legend.html",[]).run(["$templateCache",function(e){e.put("js/gridded/legend.html",'<svg class="gridded-legend"></svg>')}]),angular.module("js/gridded/pest-legend.html",[]).run(["$templateCache",function(e){e.put("js/gridded/pest-legend.html",'<svg class="pest-legend"></svg>')}]),angular.module("js/gridded/year-control.html",[]).run(["$templateCache",function(e){e.put("js/gridded/year-control.html",'<div class="form-group" ng-if="layer.extent">\n    <label for="selectedExtent">Year</label>\n    <select id="selectedExtent" class="form-control" ng-model="layer.extent.current" ng-options="v as v.label for v in layer.extent.values"></select>\n</div>')}]),angular.module("js/layers/layerControl.html",[]).run(["$templateCache",function(e){e.put("js/layers/layerControl.html",'<p class="empty-filter-notes" ng-if="!hasSufficientCriteria()">\n    Before adding a boundary layer to the map you must create and execute a filter.\n    A boundary layer will allow you to filter sites based on the geographic area it defines.\n</p>\n<ul class="list-unstyled" ng-if="hasSufficientCriteria()">\n    <li><label ng-class="{\'selected-layer\': layerOnMap.layer === \'none\'}"><a href ng-click="layerOnMap.layer=\'none\'">None</a></label>\n        \x3c!--input type="radio" id="layer-none" ng-model="layerOnMap.layer" value="none"/> <label for="layer-none">None</label--\x3e\n    </li>\n    <li ng-repeat="layer in layers">\n        <label  ng-class="{\'selected-layer\': layerOnMap.layer === layer}">{{layer.label}}</label>\n        <a href ng-click="layerOnMap.layer=layer"><img ng-src="{{layer.img}}" /></a>\n        <ul class="list-inline layer-links">\n            <li ng-if="layer.link"><a href="{{layer.link}}" target="_blank">More Info</a></li>\n            <li ng-if="layer.source"><a href="{{layer.source}}" target="_blank">Source</a></li>\n        </ul>\n    </li>\n</ul>')}]),angular.module("js/map/map.html",[]).run(["$templateCache",function(e){e.put("js/map/map.html",'<a title="Reset" href id="reset-control" class="btn btn-default btn-xs" ng-click="reset()"><i class="fa fa-refresh"></i></a>\n\n<div id="myModal" class="warning-modal modal">\n  \x3c!-- Modal content --\x3e\n  <div class="warning-modal-content">\n    <span class="close" onclick="getElementById(\'myModal\').style.display = \'none\'">&times;</span>\n    <p class="warning-modal-text">This version of the USA-NPN visualization tool is no longer supported! We invite you to use our new, improved tool. You can still use this version of the tool, but some features may not work correctly.</p>\n    <div class="warning-modal-buttons">\n        <a title="Continue Using this Version" href id="close-warning-btn" class="btn btn-default btn-xs warning-modal-btn" onclick="getElementById(\'myModal\').style.display = \'none\'">Continue Using this Version</a>\n        <a title="Go to New Version" href id="move-warning-btn" class="btn btn-default btn-xs warning-modal-btn" onclick="window.location=\'https://data.usanpn.org/vis-tool/\'">Go to New Version</a>\n    </div>\n  </div>\n</div>\n\n<npn-working></npn-working>\n\n<ui-gmap-google-map ng-if="map" center=\'map.center\' zoom=\'map.zoom\' options="map.options" events="map.events">\n    <npn-stations ng-if="stationView"></npn-stations>\n    <npn-filter-results></npn-filter-results>\n    <bounds-manager></bounds-manager>\n</ui-gmap-google-map>\n\n<share-control></share-control>\n<export-control></export-control>\n<help-video-control></help-video-control>\n<filter-tags></filter-tags>\n<choropleth-info></choropleth-info>\n<gridded-legend-main></gridded-legend-main>\n<pest-legend-main></pest-legend-main>\n\n<toolbar>\n    <tool id="filter" icon="fa-search" title="Filter">\n        <filter-control></filter-control>\n    </tool>\n    <tool id="layers" icon="fa-bars" title="Boundary Layers">\n        <layer-control></layer-control>\n    </tool>\n    <tool id="visualizations" icon="fa-bar-chart" title="Visualizations">\n        <vis-control></vis-control>\n    </tool>\n    <tool id="settings" icon="fa-cog" title="Settings">\n        <settings-control></settings-control>\n    </tool>\n\t<tool id="gridded" icon="fa-th" title="Gridded Layers">\n\t\t<gridded-control></gridded-control>\n\t</tool>\n    <tool id="pestmaps" icon="fa-bug" title="Pheno Forecasts">\n        <pest-control></pest-control>\n    </tool>\n</toolbar>\n\n'+"<img src = 'npn-logo.png' class='npn-logo' />\n<img src = 'University-of-Arizona-Logo.png' class='ua-logo' />\n<img src = 'usgs-logo.png' class='usgs-logo' /> \n")}]),angular.module("js/mapvis/filter-tags.html",[]).run(["$templateCache",function(e){e.put("js/mapvis/filter-tags.html",'<ul class="filter-tags map-vis list-inline pull-right">\n\t<li ng-if="mapVisFilter.length">\n        <div class="btn-group filter-tag">\n            <a class="btn btn-default">\n                <span>Multiple Observations Reported at this Location</span>\n                <img src=\'mult-species-legend.png\' />\n            </a>\n        </div>\t\t\n\t</li>\n    <li ng-repeat="tag in mapVisFilter">\n        <div class="btn-group filter-tag">\n            <a class="btn btn-default">\n                <span>{{tag.species | speciesTitle}}, {{tag.phenophase.phenophase_name}}, {{tag.year}} </span>\n                <svg id="map-vis-marker-{{$index}}"></svg>\n            </a>\n            <a class="btn btn-default" ng-click="removeFromFilter($index)">\n                <i class="fa fa-times-circle-o"></i>\n            </a>\n        </div>\n    </li>\n</ul>')}]),angular.module("js/mapvis/in-situ-control.html",[]).run(["$templateCache",function(e){e.put("js/mapvis/in-situ-control.html",'<div class="in-situ-control" ng-if="layer && layer.supportsData()">\n    <div class="disable-curtain" ng-if="disableControl"></div>\n    <hr />\n\t<h4>Plot Observed Onset</h4>\n    <div class="form-group" ng-if="speciesList">\n        <label for="selectedSpecies">Species</label>\n        <select id="selectedSpecies" class="form-control" ng-model="selection.species"\n                ng-options="s as (s | speciesTitle) for s in speciesList"></select>\n    </div>\n    <div class="form-group" ng-if="selection.species">\n        <label for="selectedPhenophse">Phenophase</label>\n        <select id="selectedPhenophse" class="form-control" ng-model="selection.phenophase"\n                ng-options="p as p.phenophase_name for p in phenophaseList"></select>\n    </div>\n    <div class="row">\n        <div class="col-xs-9">\n            <div class="form-group" ng-if="selection.species && selection.phenophase">\n                <label for="selectedYear">Year</label>\n                <select id="selectedYear" class="form-control" ng-model="selection.year" ng-disabled="currentYearOnly"\n                        ng-options="y as y for y in years"></select>\n            </div>\n        </div>\n        <div class="col-xs-3">\n            <div class="form-group text-right">\n                <label for="addToMapVis" style="visibility: hidden; display: block;">Add</label>\n                <button id="addToMapVis" class="btn btn-default"\n                        ng-click="addSelectionToFilter()"\n                        ng-disabled="!validSelection()"\n                        popover-placement="left" popover-popup-delay="500"\n                        popover-trigger="\'mouseenter\'"\n                        uib-popover="Add this species/phenophase/year to the map"\n                        popover-append-to-body="true">\n                    <i class="fa fa-plus"></i>\n                </button>\n            </div>\n        </div>\n    </div>\n    <div class="row">\n        <div class="col-xs-12">\n            <button id="mapVisPlot" class="btn btn-default pull-right"\n                    ng-click="mapVisPlot()"\n                    ng-disabled="!mapVisFilter.length"\n                    popover-placement="left" popover-popup-delay="500"\n                    popover-trigger="\'mouseenter\'"\n                    uib-popover="Add this species/phenophase/year to the map"\n                    popover-append-to-body="true">Plot data</button>\n        </div>\n    </div>\n</div>\n<div class="in-situ-control" ng-if="layer && !layer.supportsData()">\n\t<p style=\'font-style:italic;font-size:11px\'>Note: To plot Natures Notebook phenology observations against phenology maps, please select one of the following Gridded Layer categories: "Spring Indices, Historical Annual", "Spring Indices, Current Year" or "Spring Indices, Daily 30-year Average".</p>\n</div>\n')}]),angular.module("js/mapvis/mapvis.html",[]).run(["$templateCache",function(e){e.put("js/mapvis/mapvis.html",'<vis-dialog title="Phenology Maps" modal="modal">\n    <div class="container-fluid">\n        <div class="row">\n            <div class="col-xs-8">\n                <div id="vis-working" ng-show="working"><i class="fa fa-circle-o-notch fa-spin fa-5x"></i></div>\n                <map-vis-filter-tags map-vis-filter="speciesSelections"></map-vis-filter-tags>\n                <ui-gmap-google-map ng-if="wms_map" center=\'wms_map.center\' zoom=\'wms_map.zoom\' options="wms_map.options" events="wms_map.events">\n                    <ui-gmap-markers models="results.markers"\n                                    idKey="\'$markerKey\'"\n                                    coords="\'self\'"\n                                    icon="\'icon\'"\n                                    options="\'markerOpts\'"\n                                    doCluster="false"\n                                    events="markerEvents"></ui-gmap-markers>\n                    <map-vis-geo-layer></map-vis-geo-layer>\n                    <map-vis-bounds-layer></map-vis-bounds-layer>\n                </ui-gmap-google-map>\n\t\t\t\t<p class = \'citation-text\'>USA National Phenology Network, www.usanpn.org</p>\n                <gridded-legend legend="legend"></gridded-legend>\n                \x3c!--map-vis-marker-info-window></map-vis-marker-info-window--\x3e\n            </div>\n            <div class="col-xs-4">\n\t\t\t\t<h4>Select Gridded Layer</h4>\n\t\t\t\t<p><a href="https://www.usanpn.org/data/phenology_maps" target="_blank">More Info on Phenology Maps</a></p>\n                <gridded-layer-control></gridded-layer-control>\n                <map-vis-in-situ-control layer="selection.layer" map-vis-filter="speciesSelections" map-vis-plot="plotMarkers()"></map-vis-in-situ-control>\n            </div>\n        </div>\n    </div>\n</vis-dialog>')}]),angular.module("js/mapvis/marker-info-window.html",[]).run(["$templateCache",function(e){e.put("js/mapvis/marker-info-window.html",'<div class="map-vis-marker-info-window" ng-if="markerModel">\n    <div class="station-info" ng-if="markerModel.station">\n        <h3>{{markerModel.station.site_name}}</h3>\n        <ul class="list-unstyled">\n            <li ng-if="markerModel.station.group_name"><label>Group:</label> {{markerModel.station.group_name}}</li>\n            <li><label>Latitude:</label> {{markerModel.station.latitude}} <label>Longitude:</label> {{markerModel.station.longitude}}</li>\n            <li ng-if="markerModel.gridded_legend_data"><label>Gridded Layer Value:</label> <div class="legend-cell" style="background-color: {{markerModel.gridded_legend_data.color}};">&nbsp;</div> {{markerModel.gridded_legend_data.point | number:0}} ({{legend.formatPointData(markerModel.gridded_legend_data.point)}})</li>\n        </ul>\n    </div>\n    <div class="gridded-data" ng-if="markerModel.gridded_legend_data">\n    </div>\n    <div ng-repeat="md in markerModel.data" ng-init="tag = speciesSelections[$index];" ng-if="md.record">\n        <h4><span>{{tag.species | speciesTitle}}, {{tag.phenophase.phenophase_name}}, {{tag.year}} </span>\n                <svg id="map-vis-iw-marker-{{$index}}" uib-tooltip="{{md.legend_data.label}}" tooltip-append-to-body="true" tooltip-placement="top"></svg></h4>\n        <ul class="list-unstyled">\n            <li><label>Observed Day of Onset:</label> {{md.record.mean_first_yes_doy | number:0}} ({{legend.formatPointData(md.record.mean_first_yes_doy)}})<span ng-if="md.record && md.record.sd_first_yes_in_days > 0"> [Standard Deviation: {{md.record.sd_first_yes_in_days | number:1}}]</span></li>\n        </ul>\n    </div>\n</div>\n')}]),angular.module("js/pest/date-control.html",[]).run(["$templateCache",function(e){e.put("js/pest/date-control.html",'<label>Date</label>\n<p class="input-group">\n  <input type="text" class="form-control"\n        uib-datepicker-popup="longDate"\n        ng-model="selection"\n        is-open="isOpen"\n        datepicker-options="options"\n        close-text="Close"\n        ng-click="open()" />\n  <span class="input-group-btn">\n    <button type="button" class="btn btn-default" ng-click="open()"><i class="glyphicon glyphicon-calendar"></i></button>\n  </span>\n</p>')}]),angular.module("js/pest/legend.html",[]).run(["$templateCache",function(e){e.put("js/pest/legend.html",'<svg class="gridded-legend"></svg>')}]),angular.module("js/pest/pest-control.html",[]).run(["$templateCache",function(e){e.put("js/pest/pest-control.html",'<p class="empty-filter-notes">Pheno forecast maps show when management actions should be taken for key pest species. These maps are updated daily and are available 6 days in the future.  Pheno forecasts are based on published growing degree day (GDD) thresholds for points in pest life cycles when management actions are most effective.</p>\n<p><a href="https://www.usanpn.org/data/forecasts" target="_blank">More Info on Pheno Forecasts</a></p>\n<pest-layer-control></pest-layer-control>')}]),angular.module("js/pest/pest-layer-control.html",[]).run(["$templateCache",function(e){e.put("js/pest/pest-layer-control.html",'<div class="gridded-layer-control">\n\n    <div class="form-group">\n        <label for="selectedLayer">Layer</label>\n        <select id="selectedLayer" class="form-control" ng-model="selection.pest"\n                ng-options="l for l in pests"></select>\n    </div>\n   \n    <div class="extent-control" ></div>\n        <pest-date-control ng-if="selection.pest" layer="selection.layer"></pest-date-control>\n    </div>\n  \n    <p ng-if="selection.pest === \'Apple Maggot\'">Apple maggot larvae cause damage to ripening fruit. If left untreated, these pest insects can spread across the entire tree. These insects primarily affect apple trees, but can also impact plum, apricot, pear, cherry and hawthorn trees. <a href="https://www.usanpn.org/data/forecasts/Apple_maggot" target="_blank">Learn more</a></p>\n    <p ng-if="selection.pest === \'Emerald Ash Borer\'">Emerald ash borer is a beetle that causes significant harm to ash trees throughout the eastern United States. <a href="https://www.usanpn.org/data/forecasts/EAB" target="_blank">Learn more</a></p>\n    <p ng-if="selection.pest === \'Hemlock Woolly Adelgid\'">Hemlock woolly adelgid can be deadly to hemlock trees and, in the eastern United States, lacks enemies that keep their populations in check. Researchers wish to identify the optimal window to release insect predators; you can support this effort by observing hemlock woolly adelgid life cycle stages using Natures Notebook. <a href="https://www.usanpn.org/data/forecasts/HWA" target="_blank">Learn more</a></p>\n    <p ng-if="selection.pest === \'Lilac Borer\'">Lilac borer is a clear-wing moth that can damage lilac, ash, and privet trees and shrubs by burrowing into the heartwood. <a href="https://www.usanpn.org/data/forecasts/Lilac_borer" target="_blank">Learn more</a></p>\n    <p ng-if="selection.pest === \'Winter Moth\'">Winter moth is a non-native insect pest that causes damage to deciduous trees, particularly maples and oaks. <a href="https://www.usanpn.org/data/forecasts/Winter_moth" target="_blank">Learn more</a></p>\n    <p ng-if="selection.pest === \'Bronze Birch Borer\'">Bronze birch borer frequently kills birch trees by boring into the wood. <a href="https://www.usanpn.org/data/forecasts/Bronze_birch_borer" target="_blank">Learn more</a></p>\n    <p ng-if="selection.pest === \'Pine Needle Scale\'">Pine needle scale is a native pest that affects ornamental pines and Christmas tree plantations. <a href="https://www.usanpn.org/data/forecasts/Pine_needle_scale" target="_blank">Learn more</a></p>\n    <p ng-if="selection.pest === \'Eastern Tent Caterpillar\'">Eastern Tent Caterpillars are a native moth and while they can defoliate trees, the trees rarely die as a consequence. <a href="https://www.usanpn.org/data/forecasts/Eastern_tent_caterpillar" target="_blank">Learn more</a></p>\n    <p ng-if="selection.pest === \'Gypsy Moth\'">European gypsy moth caterpillars feed on deciduous trees, causing major defoliation and tree mortality. They are considered one of the worst forest pests in the United States. <a href="https://www.usanpn.org/data/forecasts/Gypsy_moth" target="_blank">Learn more</a></p>\n    <p ng-if="selection.pest === \'Asian Longhorned Beetle\'">As a generalist pest, Asian longhorned beetle poses a great potential threat to eastern forests. It is currently contained in three small quarantined areas (a fourth was recently eradicated). Burning firewood where you buy it is critical to stopping the spread of this pest. <a href="https://www.usanpn.org/data/forecasts/Asian_Longhorned_beetle" target="_blank">Learn more</a></p>\n    <p ng-if="selection.pest === \'Bagworm\'">Bagworm caterpillars defoliate over 50 families of evergreen and deciduous trees and shrubs, primarily arborvitae, juniper, pine, and spruce. Stripping of leaves and needles is most noticeable in uppermost parts of plants. If left untreated, these pests are capable of extensive defoliation which can cause branch dieback or death. <a href="https://www.usanpn.org/data/forecasts/Bagworm" target="_blank">Learn more</a></p>\n    <p ng-if="selection.pest === \'Magnolia Scale\'">Magnolia scale is a pest native to the Eastern United States that affects magnolia trees and tulip trees. They cause stress to their host trees by removing sap which can lead to yellowing leaves, twig dieback, and even death. <a href="https://www.usanpn.org/data/forecasts/Magnolia_scale" target="_blank">Learn more</a></p>\n    <p ng-if="selection.pest === \'Buffelgrass\'">Buffelgrass is an invasive plant that impacts native desert plant and animal communities in the Southwestern US. It creates substantial fire risk in ecosystems that are not adapted to large-scale intense burning. <a href="https://usanpn.org/data/forecasts/Buffelgrass" target="_blank">Learn more</a></p>\n</div>\n')}]),angular.module("js/scatter/scatter.html",[]).run(["$templateCache",function(e){e.put("js/scatter/scatter.html",'<vis-dialog title="Scatter Plot" modal="modal">\n<form class="form-inline plot-criteria-form">\n    <div class="form-group">\n        <label for="speciesInput">Select up to three species phenophase combinations</label>\n        <select name="speciesInput" class="form-control" ng-model="selection.species" ng-options="(o|speciesTitle) for o in speciesList"></select>\n        <select name="phenophaseInput" class="form-control" ng-model="selection.phenophase" ng-options="o.phenophase_name for o in phenophaseList"></select>\n        <div class="btn-group" uib-dropdown is-open="selection.color_isopen">\n          <button type="button" class="btn btn-default dropdown-toggle" uib-dropdown-toggle style="background-color: {{colorRange[selection.color]}};">\n            &nbsp; <span class="caret"></span>\n          </button>\n          <ul class="dropdown-menu" role="menu">\n            <li ng-repeat="i in colors track by $index" style="background-color: {{colorRange[$index]}};"><a href ng-click="selection.color=$index;">&nbsp;</a></li>\n          </ul>\n        </div>\n    </div>\n    <button class="btn btn-default" ng-click="addToPlot()" ng-disabled="!canAddToPlot()"><i class="fa fa-plus"></i></button>\n</form>\n\n<div class="panel panel-default main-vis-panel" >\n    <div class="panel-body">\n        <center>\n        <ul class="to-plot list-inline animated-show-hide" ng-if="toPlot.length">\n            <li class="criteria" ng-repeat="tp in toPlot">{{tp|speciesTitle}}/{{tp.phenophase_name}} <i style="color: {{colorRange[tp.color]}};" class="fa fa-circle"></i>\n                <a href ng-click="removeFromPlot($index)"><i class="fa fa-times-circle-o"></i></a>\n            </li>\n            <li>\n                <select class="form-control vis-axis" ng-model="selection.axis" ng-options="o as o.label for o in axis"></select>\n            </li>\n            <li>\n                <label for="fitLinesInput">Fit Line{{toPlot.length > 1 ? \'s\' : \'\'}}</label>\n                <input type="checkbox" id="fitLinesInput" ng-model="selection.regressionLines" />\n            </li>\n            <li>\n                <label for="individualPhenometrics">Use Individual Phenometrics</label>\n                <input type="checkbox" id="individualPhenometrics" ng-model="selection.useIndividualPhenometrics" />\n            </li>\n            <li ng-if="!data"><button class="btn btn-primary" ng-click="visualize()">Visualize</button></li>\n        </ul>\n        <div id="vis-container">\n            <div id="vis-working" ng-show="working"><i class="fa fa-circle-o-notch fa-spin fa-5x"></i></div>\n            <div class="chart-container">\n                <vis-download ng-if="data"\n                              selector=".chart"\n                              filename="npn-scatter-plot.png"></vis-download>\n                <div><svg class="chart"></svg></div>\n            </div>\n            <div ng-if="filteredDisclaimer" class="filter-disclaimer">For quality assurance purposes, only onset dates that are preceded by negative records are included in the visualization.</div>\n        </div>\n        </center>\n    </div>\n</div>\n\x3c!--pre ng-if="record">{{record | json}}</pre--\x3e\n\n</vis-dialog>\n')}]),angular.module("js/settings/settingsControl.html",[]).run(["$templateCache",function(e){e.put("js/settings/settingsControl.html",'<ul class="list-unstyled">\n    <li>\n        <Label for="clusterMarkersSetting">Cluster Markers</label>\n        <ul class="list-unstyled">\n            <li ng-repeat="option in [true,false]">\n                <input type="radio" id="clusterMarkers{{option}}" ng-model="settings.clusterMarkers.value"\n                       ng-value="{{option}}" /> <label for="clusterMarkers{{option}}">{{option | yesNo}}</label>\n            </li>\n        </ul>\n    </li>\n    <li class="divider"></li>\n    <li>\n        <label>Variable Displayed</label>\n        <ul class="list-unstyled">\n            <li ng-repeat="option in settings.tagBadgeFormat.options">\n                <input type="radio"\n                       id="{{option.value}}" ng-model="settings.tagBadgeFormat.value"\n                       value="{{option.value}}"> <label for="{{option.value}}">{{option.label}}</label>\n            </li>\n        </ul>\n    </li>\n    <li class="divider"></li>\n    <li>\n        <Label for="onlyYesData">Only Show Yes Data</label>\n        <ul class="list-unstyled">\n            <li ng-repeat="option in [true,false]">\n                <input type="radio" name="onlyYesData" id="onlyYesData{{option}}" ng-model="settings.onlyYesData.value"\n                       ng-value="{{option}}" /> <label for="onlyYesData{{option}}">{{option | yesNo}}</label>\n            </li>\n        </ul>\n    </li>\n    <li class="divider"></li>\n    <li>\n        <label>Species Tag Title</label>\n        <ul class="list-unstyled">\n            <li ng-repeat="option in settings.tagSpeciesTitle.options">\n                <input type="radio"\n                       id="{{option.value}}" ng-model="settings.tagSpeciesTitle.value"\n                       value="{{option.value}}"> <label for="{{option.value}}">{{option.label}}</label>\n            </li>\n        </ul>\n    </li>\n    <li class="divider"></li>\n    <li>\n        <label for="excludeLqd">Exclude less precise data from visualizations</label>\n        <ul class="list-unstyled">\n            <li ng-repeat="option in [true,false]">\n                <input type="radio" id="filterLqdSummary{{option}}" ng-model="settings.filterLqdSummary.value"\n                       ng-value="{{option}}" /> <label for="filterLqdSummary{{option}}">{{option | yesNo}}</label>\n            </li>\n        </ul>\n        <p>Selecting <strong>Yes</strong> will exclude data points which lack a "no" record preceding the first "yes" record from certain visualizations. </p>\n    </li>\n    <li class="divider"></li>\n    <li>\n        <label for="dataPrecisionFilter">Data Precision Filter</label>\n        <select class="form-control" ng-model="settings.dataPrecisionFilter.value"\n            ng-options="days as days+\' days\' for days in settings.dataPrecisionFilter.options" />\n        <p style="margin: 15px 0px;">Less precise data is removed from the scatter plot and map visualizations by only plotting data points preceded or followed by a no within 30 days. This filter can be adjusted here to  7, 14, or 30 days.</p>\n    </li>\n</ul>\n')}]),angular.module("js/time/time.html",[]).run(["$templateCache",function(e){e.put("js/time/time.html",'<vis-dialog title="Daily Accumulation" modal="modal">\n    <div class="controls">\n        <div class="threshold">\n            <label>Select AGDD Threshold</label>\n            <rzslider rz-slider-model="selection.threshold.value" rz-slider-options="selection.threshold.options"></rzslider>\n        </div>\n        <div class="days-of-the-year">\n            <label>Select Days of Year</label>\n            <rzslider rz-slider-model="selection.doys.value" rz-slider-options="selection.doys.options"></rzslider>\n        </div>\n        <div class="checkbox" ng-if="selection.lastYearValid">\n            <label ng-disabled="working">\n              <input type="checkbox" ng-model="selection.showLastYear"> Show data from previous year\n            </label>\n        </div>\n    </div>\n    <div class="panel panel-default main-vis-panel" >\n        <div class="panel-body">\n            <center>\n            <div id="vis-container">\n                <div id="vis-working" ng-show="working"><i class="fa fa-circle-o-notch fa-spin fa-5x"></i></div>\n                <div class="chart-container">\n                    <vis-download ng-if="!working"\n                                  selector=".chart"\n                                  filename="time-series.png"></vis-download>\n                    <div><svg class="chart"></svg></div>\n                </div>\n            </div>\n            </center>\n        </div>\n    </div>\n</vis-dialog>\n')}]),angular.module("js/toolbar/tool.html",[]).run(["$templateCache",function(e){e.put("js/toolbar/tool.html",'<div class="tool-content {{title.toLowerCase()}}" ng-show="selected">\n    <h2>{{title}}</h2>\n    <div ng-transclude>\n    </div>\n</div>')}]),angular.module("js/toolbar/toolbar.html",[]).run(["$templateCache",function(e){e.put("js/toolbar/toolbar.html",'<div class="toolbar">\n  <ul class="tools-list">\n    <li ng-repeat="t in tools" ng-class="{open: t.selected}"\n        popover-placement="right" uib-popover="{{(t.selected) ? \'Click to Collapse Menu\' : t.title}}" popover-trigger="\'mouseenter\'" popover-popup-delay="1000" popover-append-to-body="true"\n        ng-click="select(t)">\n      <i id="toolbar-icon-{{t.id}}" class="toolbar-icon fa {{t.icon}}"></i>\n    </li>\n  </ul>\n  <div class="toolbar-content" ng-class="{open: open}" ng-transclude></div>\n</div>\n')}]),angular.module("js/vis/visControl.html",[]).run(["$templateCache",function(e){e.put("js/vis/visControl.html",'<p class="empty-filter-notes" ng-if="isFilterEmpty()">\n    Before using a visualization you must create and execute a filter.\n    Visualizations use the species, and sometimes, date ranges you\'ve identified\n    in your filter as the basis for what you want to visualize.\n</p>\n<ul class="list-unstyled">\n    <li ng-repeat="vis in visualizations">\n        <a href ng-click="open(vis)" ng-class="{disabled: isFilterEmpty()}">{{vis.title}}</a>\n        <p>{{vis.description}}</p>\n    </li>\n</ul>')}]),angular.module("js/vis/visDialog.html",[]).run(["$templateCache",function(e){e.put("js/vis/visDialog.html",'<div class="modal-header">\n    <a href class="modal-dismiss" ng-click="modal.dismiss()"><i class="fa fa-times-circle-o fa-2x"></i></a>\n    <h3 class="modal-title">{{title}}</h3>\n</div>\n<div class="modal-body vis-dialog {{title | cssClassify}}" ng-transclude>\n</div>')}]),angular.module("js/vis/visDownload.html",[]).run(["$templateCache",function(e){e.put("js/vis/visDownload.html",'<div class="vis-download">\n    <a href ng-click="download()" title="Download"><i class="fa fa-download"></i></a>\n    <canvas id="visDownloadCanvas" style="display: none;"></canvas>\n    <a id="vis-download-link" style="display: none;">download</a>\n</div>')}]),angular.module("npn-viz-tool.pest",["npn-viz-tool.gridded-services"]).service("PestControlService",["$location",function(t){var r={getLegend:function(){return r.legend},getLayer:function(){return r.layer},addSharingUrlArgs:function(e){var t,n;r.layer&&(t=r.layer.name+"/"+r.layer.extent.current.value,(n=r.layer.getStyleRange())&&(t+="/"+n[0]+"/"+n[1]),e.gl=t)},getSharingUrlArgs:function(){var e=t.search().gl;if(e)return e.split(/\//)}};return r}]).directive("pestLegendMain",["PestControlService",function(t){return{restrict:"E",template:'<div id="pestLegendMain" ng-style="{display: shared.legend ? \'inherit\' : \'none\'}"><pest-legend legend="shared.legend"></pest-legend></div>',scope:{},link:function(e){e.shared=t}}}]).directive("pestControl",["$log","$rootScope","uiGmapGoogleMapApi","uiGmapIsReady","WmsService","PestControlService","GriddedInfoWindowHandler",function(s,l,e,a,c,d,u){return{restrict:"E",templateUrl:"js/pest/pest-control.html",link:function(i){var t,n;function r(){null==i.layers&&e.then(function(e){a.promise(1).then(function(e){n=e[0].map,t=new u(n),n.addListener("click",function(e){t.open(e.latLng,i.selection.activeLayer,i.legend)}),c.getLayers(n).then(function(e){s.debug("layers",e),i.layers=e,console.log("setting active layer to agdd base 50");for(var t=0;t<e.categories.length;t++)if("Temperature Accumulations, Current Day"===e.categories[t].name)for(var n=0;n<e.categories[t].layers.length;n++)"gdd:agdd_50f"===e.categories[t].layers[n].name&&(console.log(e.categories[t].layers[n].name),i.selection.layer=e.categories[t].layers[n])},function(){s.error("unable to get map layers?")})})})}function o(){t&&t.close()}i.selection={},i.actions={reset:function(){delete i.selection.layerCategory,delete i.selection.layer}},i.$on("filter-reset",i.actions.reset),d.getSharingUrlArgs()?r():i.$on("tool-open",function(e,t){"pestmaps"===t.tool.id&&r()}),i.$watch("selection.layerCategory",function(e){s.debug("layer category change ",e),l.$broadcast("reset-gridded-layer"),i.selection.activeLayer&&(s.debug("turning off layer ",i.selection.activeLayer.name),e=i.selection.activeLayer,i.selection.activeLayer.offPest(),delete i.selection.activeLayer,delete i.legend,delete d.legend,delete d.layer,o(),l.$broadcast("gridded-layer-off",{layer:e}))}),i.$on("reset-pest-layer",function(){delete i.selection.pest,delete i.layers,i.selection.activeLayer&&(s.debug("turning off layer ",i.selection.activeLayer.name),i.selection.activeLayer,i.selection.activeLayer.offPest(),delete i.selection.activeLayer,delete i.legend,delete d.legend,delete d.layer,o())}),i.$watch("selection.pest",function(e){if(null!=i.selection.pest&&l.$broadcast("reset-gridded-layer"),o(),i.selection.timeSeriesDate=60,i.selection.activeLayer&&(s.debug("turning off layer ",i.selection.activeLayer.name),i.selection.activeLayer.offPest()),i.layers&&i.layers.categories)for(var t=0;t<i.layers.categories.length;t++){if("Precip Accumulations, Current Day"===i.layers.categories[t].name)for(var n=0;n<i.layers.categories[t].layers.length;n++)"Buffelgrass"===e&&"precipitation:buffelgrass_prism"===i.layers.categories[t].layers[n].name&&(i.selection.layer=i.layers.categories[t].layers[n],i.selection.activeLayer=i.layers.categories[t].layers[n]);if("Temperature Accumulations, Current Day"===i.layers.categories[t].name)for(var r=0;r<i.layers.categories[t].layers.length;r++)"Hemlock Woolly Adelgid"===e?"gdd:agdd"===i.layers.categories[t].layers[r].name&&(i.selection.layer=i.layers.categories[t].layers[r],i.selection.activeLayer=i.layers.categories[t].layers[r]):"gdd:agdd_50f"===i.layers.categories[t].layers[r].name&&(i.selection.layer=i.layers.categories[t].layers[r],i.selection.activeLayer=i.layers.categories[t].layers[r])}var a;i.selection.activeLayer&&(i.selection.activeLayer.pest=e,(a=new Date).setHours(0,0,0,0),i.selection.activeLayer.extent.current.date=a,i.selection.activeLayer.extent.current.value=a.toISOString(),i.selection.activeLayer.extent.current.label=a.toLocaleString("en-us",{month:"long"})+" "+a.getDate()+", "+a.getFullYear(),delete i.legend,i.selection.activeLayer.getLegend().then(function(e){e.pest=i.selection.pest,d.legend=i.legend=e}))}),i.$watch("selection.layer",function(e){e&&(o(),s.debug("selection.layer",e),i.selection.activeLayer&&(s.debug("turning off layer ",i.selection.activeLayer.name),i.selection.activeLayer.offPest()),e.pest=i.selection.pest,s.debug("fitting new layer ",e.name),d.layer=i.selection.activeLayer=e.fit().onPest(),l.$broadcast("gridded-layer-on",{layer:i.selection.activeLayer}))}),i.$watch("selection.activeLayer.extent.current.date",function(e){o(),i.selection&&i.selection.activeLayer&&i.selection.activeLayer.extent.current&&i.selection.activeLayer.bouncePest(i.selection.pest)})}}}]),angular.module("npn-viz-tool.vis-scatter",["npn-viz-tool.vis","npn-viz-tool.filter","npn-viz-tool.filters","npn-viz-tool.settings","ui.bootstrap"]).controller("ScatterVisCtrl",["$scope","$uibModalInstance","$timeout","$filter","$log","FilterService","ChartService",function(u,e,t,p,s,l,g){u.modal=e;e=l.getColorScale();u.colors=e.domain(),u.colorRange=e.range(),u.axis=[{key:"latitude",label:"Latitude",axisFmt:d3.format(".2f")},{key:"longitude",label:"Longitude",axisFmt:d3.format(".2f")},{key:"elevation_in_meters",label:"Elevation (m)"},{key:"fyy",label:"Year"},{key:"prcp_fall",label:"Precip Fall (mm)"},{key:"prcp_spring",label:"Precip Spring (mm)"},{key:"prcp_summer",label:"Precip Summer (mm)"},{key:"prcp_winter",label:"Precip Winter (mm)"},{key:"tmax_fall",label:"Tmax Fall (C)"},{key:"tmax_spring",label:"Tmax Spring (C)"},{key:"tmax_summer",label:"Tmax Summer (C)"},{key:"tmax_winter",label:"Tmax Winter (C)"},{key:"tmin_fall",label:"Tmin Fall (C)"},{key:"tmin_spring",label:"Tmin Spring (C)"},{key:"tmin_summer",label:"Tmin Summer (C)"},{key:"tmin_winter",label:"Tmin Winter (C)"},{key:"daylength",label:"Day Length (s)"},{key:"acc_prcp",label:"Accumulated Precip (mm)"},{key:"gdd",label:"AGDD"}];var n=d3.format("d");function r(e){return(u.selection.axis.axisFmt||n)(e)}function a(){return angular.extend({},u.selection.species,u.selection.phenophase,{color:u.selection.color})}function i(){u.data=f=void 0,angular.forEach(m,function(e){delete e.data})}u.selection={color:0,axis:u.axis[0],regressionLines:!1,useIndividualPhenometrics:!1},u.$watch("selection.regressionLines",function(e,t){e!==t&&$()}),u.$watch("selection.axis",function(e,t){e!==t&&$()}),u.toPlot=[],l.getFilter().getSpeciesList().then(function(e){s.debug("speciesList",e),(u.speciesList=e).length&&(u.selection.species=e[0])}),u.$watch("selection.species",function(){if(u.phenophaseList=[],u.selection.species){for(var e=l.getFilter().getDateArg().arg.start_date,t=l.getFilter().getDateArg().arg.end_date,n=[t];e<t;)--t,n.push(t);l.getFilter().getPhenophasesForSpecies(u.selection.species.species_id,!0,n).then(function(e){s.debug("phenophaseList",e),(u.phenophaseList=e).length&&(u.selection.phenophase=e[0])})}}),u.canAddToPlot=function(){if(3===u.toPlot.length||!u.selection.species||!u.selection.phenophase)return!1;if(0===u.toPlot.length)return!0;for(var e=a(),t=0;t<u.toPlot.length;t++)if(angular.equals(u.toPlot[t],e))return!1;for(t=0;t<u.toPlot.length;t++)if(e.color===u.toPlot[t].color)return!1;return!0},u.addToPlot=function(){u.canAddToPlot()&&(u.toPlot.push(a()),u.selection.color<u.colors.length?u.selection.color++:u.selection.color=0,i())},u.removeFromPlot=function(e){u.toPlot.splice(e,1),i()};var f,o,h="getSiteLevelData",m={getSiteLevelData:{dataFunc:function(e){return e.mean_first_yes_doy},firstYesYearFunc:function(e){return e.mean_first_yes_year}},getSummarizedData:{dataFunc:function(e){return e.first_yes_doy},firstYesYearFunc:function(e){return e.first_yes_year}}},e=l.getFilter().getDateArg(),c=e.arg.start_date,d=new Date(c,0),v=(e.arg.end_date,g.getSizeInfo({top:80,left:60})),y=d3.scale.linear().range([0,v.width]).domain([0,100]),b=d3.svg.axis().scale(y).orient("bottom").tickFormat(r),w=d3.scale.linear().range([v.height,0]).domain([1,365]),x=d3.time.format("%x"),k=function(e){e=(e-1)*g.ONE_DAY_MILLIS+d.getTime(),e=new Date(e);return x(e)},_=d3.svg.axis().scale(w).orient("left");function S(){var e=d3.select(".chart");e.selectAll(".axis path").style("fill","none").style("stroke","#000").style("shape-rendering","crispEdges"),e.selectAll(".axis line").style("fill","none").style("stroke","#000").style("shape-rendering","crispEdges"),e.selectAll("text").style("font-family","Arial"),e.selectAll(".legend rect").style("fill","white").style("stroke","black").style("opacity","0.8");var t="14px";e.selectAll(".legend text").style("font-size",t).attr("y",function(e,t){return 12*t+t}),e.selectAll("g .x.axis text").style("font-size",t),e.selectAll("g .y.axis text").style("font-size",t);e.selectAll(".legend circle").attr("r","5").attr("cx","5").attr("cy",function(e,t){return 14*t-5})}function $(){var s,l,c,d,e;function t(e){return e[u.selection.axis.key]}f&&(u.working=!0,s=f.filter(function(e){return-9999!=e[u.selection.axis.key]}),y.domain([d3.min(s,t)-1,d3.max(s,t)+1]),b.scale(y).tickFormat(d3.format(".2f")),(e=o.selectAll("g .x.axis")).call(b.tickFormat(r)),e.selectAll(".axis-label").remove(),e.append("text").attr("class","axis-label").attr("x",v.width/2).attr("dy","3em").style("text-anchor","middle").style("font-size","12px").text(u.selection.axis.label),(e=o.selectAll(".circle").data(s,function(e){return e.id})).exit().remove(),e.enter().append("circle").attr("class","circle").style("stroke","#333").style("stroke-width","1"),l=m[h].dataFunc,e.attr("cx",function(e){return y(e[u.selection.axis.key])}).attr("cy",function(e){return w(l(e))}).attr("r","5").attr("fill",function(e){return e.color}).on("click",function(e){d3.event.defaultPrevented||u.$apply(function(){u.record=e})}).append("title").text(function(e){return k(e.day_in_range)+" ["+e.latitude+","+e.longitude+"]"}),c=[],d=d3.format(".2f"),angular.forEach(u.toPlot,function(e){var t,n,r,a,i=u.colorRange[e.color],o=s.filter(function(e){return e.color===i});0<o.length&&(a=(n=o.sort(function(e,t){return e[u.selection.axis.key]-t[u.selection.axis.key]})).map(function(e){return e[u.selection.axis.key]}).filter(angular.isNumber),r=n.map(l).filter(angular.isNumber),t=g.leastSquares(a,r),o=a[0],n=g.approxY(t,o),r=a[a.length-1],a=g.approxY(t,r),c.push({id:e.species_id+"."+e.phenophase_id,legend:p("speciesTitle")(e)+"/"+e.phenophase_name+(u.selection.regressionLines&&!isNaN(t[2])?" (R^2 = "+d(t[2])+")":""),color:i,p1:[o,n],p2:[r,a]}))}),(e=o.selectAll(".regression").data(c,function(e){return e.id})).exit().remove(),e.enter().append("line").attr("class","regression"),e.attr("data-legend",function(e){return e.legend}).attr("x1",function(e){return y(e.p1[0])}).attr("y1",function(e){return w(e.p1[1])}).attr("x2",function(e){return y(e.p2[0])}).attr("y2",function(e){return w(e.p2[1])}).attr("fill",function(e){return e.color}).attr("stroke",function(e){return e.color}).attr("stroke-width",u.selection.regressionLines?2:0),o.select(".legend").remove(),o.append("g").attr("class","legend").attr("transform","translate(30,-45)").style("font-size","1em").call(d3.legend),u.selection.regressionLines&&o.selectAll(".legend text").html(function(e){return e.key.replace("R^2",'R<tspan style="baseline-shift: super; font-size: 8px;">2</tspan>')}),S(),u.working=!1)}function C(o){return function(){if(f=m[h=o].data)return $();var r=m[h].dataFunc,a=m[h].firstYesYearFunc;u.working=!0,s.debug("visualize",u.selection.axis,u.toPlot);var e=l.getFilter().getDateArg(),t={climate_data:1,request_src:"npn-vis-scatter-plot",start_date:e.getStartDate(),end_date:e.getEndDate()},n=0,i={};angular.forEach(u.toPlot,function(e){i[e.species_id+"."+e.phenophase_id]=e.color,t["species_id["+n+"]"]=e.species_id,t["phenophase_id["+n+++"]"]=e.phenophase_id}),g[o](t,function(e,t){s.log("y tho"),s.log(e),u.data=f=e.filter(function(n,e){var t=!0;return n.color=u.colorRange[i[n.species_id+"."+n.phenophase_id]],n.color?(n.id=e,n.fyy=a(n),angular.forEach({daylength:"mean_daylength",acc_prcp:"mean_accum_prcp",gdd:"mean_gdd"},function(e,t){void 0===n[t]&&(n[t]=n[e])}),n.day_in_range=365*(n.fyy-c)+r(n)):t=!1,t}),u.data=m[h].data=f,u.filteredDisclaimer=t,s.debug("scatterPlot data",f),$()})}}t(function(){var e=d3.select(".chart").attr("width",v.width+v.margin.left+v.margin.right).attr("height",v.height+v.margin.top+v.margin.bottom);e.append("g").append("rect").attr("width","100%").attr("height","100%").attr("fill","#fff"),o=e.append("g").attr("transform","translate("+v.margin.left+","+v.margin.top+")");var t=l.getFilter().getDateArg();o.append("g").attr("class","chart-title").append("text").attr("y","0").attr("dy","-3em").attr("x",v.width/2).style("text-anchor","middle").style("font-size","18px").text(t.getStartYear()+" - "+t.getEndYear()),o.append("g").attr("class","x axis").attr("transform","translate(0,"+v.height+")").call(b),o.append("g").attr("class","y axis").call(_).append("text").attr("transform","rotate(-90)").attr("y","0").attr("dy","-3em").attr("x",v.height/2*-1).style("text-anchor","middle").text("Onset Day of Year"),e.append("g").append("text").attr("dx",5).attr("dy",v.height+136).attr("font-size","11px").attr("font-style","italic").attr("text-anchor","right").text("USA National Phenology Network, www.usanpn.org"),S()},500);var F=C("getSiteLevelData"),L=C("getSummarizedData");u.$watch("selection.useIndividualPhenometrics",function(e){delete u.data,u.visualize=e?L:F})}]),angular.module("npn-viz-tool.settings",["npn-viz-tool.filters"]).factory("SettingsService",[function(){var i={clusterMarkers:{name:"cluster-markers",q:"cm",value:!0},tagSpeciesTitle:{name:"tag-species-title",q:"tst",value:"common-name",options:[{value:"common-name",q:"cn",label:"Common Name"},{value:"scientific-name",q:"sn",label:"Scientific Name"}]},tagBadgeFormat:{name:"tag-badge-format",q:"tbf",value:"observation-count",options:[{value:"observation-count",q:"oc",label:"Record Count"},{value:"station-count",q:"sc",label:"Site Count"}]},filterLqdSummary:{name:"filter-lqd-summary",q:"flqdf",value:!0},onlyYesData:{name:"only-yes-data",q:"oyd",value:!1},dataPrecisionFilter:{name:"filter-data-precision",q:"fdp",value:30,options:[7,14,30]}};return{getSettings:function(){return i},getSetting:function(e){return i[e]},getSettingValue:function(e){return i[e].value},getSettingValueLabel:function(e){for(var t=i[e],n=t.value,r=0;t.options&&r<t.options.length;r++)if(t.options[r].value===n)return t.options[r].label},getSharingUrlArgs:function(){var e,t,n,r="";for(e in i)if(r+=(""!==r?";":"")+(t=i[e]).q+"=",t.options){for(n=0;n<t.options.length;n++)if(t.value===t.options[n].value){r+=t.options[n].q;break}}else r+=t.value;return"ss="+encodeURIComponent(r)},populateFromSharingUrlArgs:function(e){e&&e.split(";").forEach(function(e){var t,n,e=e.split("="),r=e[0],a=e[1];for(t in i)if(i[t].q===r){if(i[t].options){for(n=0;n<i[t].options.length;n++)if(i[t].options[n].q===a){i[t].value=i[t].options[n].value;break}}else i[t].value="true"===a||"false"===a?"true"===a:a;break}})}}}]).directive("settingsControl",["$rootScope","$location","$log","SettingsService",function(i,n,o,r){return{restrict:"E",templateUrl:"js/settings/settingsControl.html",link:function(a){function e(r){a.$watch("settings."+r+".value",function(e,t){var n;n=r,o.debug("broadcastSettingChange",a.settings[n]),i.$broadcast("setting-update-"+n,a.settings[n])})}for(var t in r.populateFromSharingUrlArgs(n.search().ss),a.settings=r.getSettings(),a.settings)e(t)}}}]),angular.module("npn-viz-tool.share",["npn-viz-tool.filter","npn-viz-tool.layers","npn-viz-tool.gridded","npn-viz-tool.settings","uiGmapgoogle-maps"]).directive("shareControl",["uiGmapIsReady","FilterService","LayerService","DateFilterArg","SpeciesFilterArg","NetworkFilterArg","GeoFilterArg","BoundsFilterArg","$location","$log","SettingsService","GriddedControlService",function(e,g,t,f,h,m,n,v,y,b,a,i){return{restrict:"E",template:'<a title="Share" href id="share-control" class="btn btn-default btn-xs" ng-disabled="!getFilter().hasSufficientCriteria() && !gridSelected()" ng-click="share()"><i class="fa fa-share"></i></a><div ng-show="url" id="share-content"><input type="text" class="form-control" ng-model="url" ng-blur="url = null" onClick="this.setSelectionRange(0, this.value.length)"/></div>',scope:{},link:function(p){g.pause(),e.promise(1).then(function(e){var t,n,r,a=e[0],i=y.search(),o=0,s=0,l=0,c=0,d=!1;function u(){d&&s===o&&l===c&&(b.debug("ready.."),t(),n(),r(),g.resume())}t=p.$on("layers-ready",function(e,t){b.debug("layers ready..."),d=!0,u()}),n=p.$on("species-filter-ready",function(e,t){b.debug("species filter ready...",t),s++,u()}),r=p.$on("network-filter-ready",function(e,t){b.debug("network filter ready...",t),c++,u()}),b.debug("qargs",i),i.d&&(i.s||i.n)?(g.addToFilter(f.fromString(i.d)),i.b&&i.b.split(";").forEach(function(e){g.addToFilter(v.fromString(e,a.map))}),i.s&&(e=i.s.split(";"),o=e.length,e.forEach(function(e){h.fromString(e).then(g.addToFilter)})),i.n&&(i=i.n.split(";"),l=i.length,i.forEach(function(e){m.fromString(e).then(g.addToFilter)}))):g.resume()}),p.gridSelected=function(){return i.layer},p.getFilter=g.getFilter,p.share=function(){var n,r,e,t;p.url?p.url=null:(n={},e=(r=y.absUrl()).indexOf("?"),g.isFilterEmpty()||(t=g.getFilter(),n.d=t.getDateArg().toString(),t.getSpeciesArgs().forEach(function(e){n.s?n.s+=";"+e.toString():n.s=e.toString()}),t.getNetworkArgs().forEach(function(e){n.n?n.n+=";"+e.toString():n.n=e.toString()}),t.getGeoArgs().forEach(function(e){n.g?n.g+=";"+e.toString():n.g=e.toString()}),t.getBoundsArgs().forEach(function(e){n.b?n.b+=";"+e.toString():n.b=e.toString()})),i.addSharingUrlArgs(n),-1!=e&&(r=r.substring(0,e)),r+=-1===r.indexOf("#")?"#?":"?",Object.keys(n).forEach(function(e,t){r+=(0<t?"&":"")+e+"="+encodeURIComponent(n[e])}),r+="&"+a.getSharingUrlArgs(),b.debug("absUrl",r),p.url=r)}}}}]),angular.module("npn-viz-tool.stations",["npn-viz-tool.filter","npn-viz-tool.vis-cache","npn-viz-tool.cluster","npn-viz-tool.settings","npn-viz-tool.layers","npn-viz-tool.vis"]).factory("StationService",["$rootScope","$http","$log","$url","FilterService","ChartService",function(i,e,o,t,s,l){var c,n={click:function(a){o.debug("click",a),c&&(c.close(),c=void 0),o.debug("Fetching info for station "+a.model.station_id),e.get(t("/npn_portal/stations/getStationDetails.json"),{params:{ids:a.model.station_id}}).then(function(e){var t,r,e=e.data;function n(e,t){return t&&""!==t?"<li><label>"+e+":</label> "+t+"</li>":""}e&&1===e.length&&(e=e[0],r='<div class="station-details">',o.debug(e),r+='<ul class="list-unstyled">',r+=n("Site Name",e.site_name),r+=n("Group",e.group_name),a.model.observationCount?r+=n("Records",a.model.observationCount):(r+=n("Individuals",e.num_individuals),r+=n("Records",e.num_records)),r+="</ul>",a.model.speciesInfo&&(r+="<label>Species Observed</label>",r+='<ul class="list-unstyled">',Object.keys(a.model.speciesInfo.titles).forEach(function(e){var t=s.getChoroplethScale(e),n=a.model.speciesInfo.counts[e];r+='<li><div class="choropleth-swatch" style="background-color: '+t(n)+';"></div>'+a.model.speciesInfo.titles[e]+" ("+n+")</li>"}),r+="</ul>"),r+="</div>",t=$.parseHTML(r)[0],s.isFilterEmpty()||(l.getVisualizations(),r="<div>",r+="<label>Visualize Site Data</label>",r+='<ul class="list-unstyled">',l.getVisualizations().forEach(function(e){void 0!==e.singleStation&&!e.singleStation||(r+="<li>",r+='<a id="'+e.controller+'" href="#">'+e.title+"</a>",r+="</li>")}),r+="</ul></div>",e=$.parseHTML(r)[0],$(t).append(e),l.getVisualizations().forEach(function(e){$(t).find("#"+e.controller).click(function(){i.$apply(function(){l.openSingleStationVisualization(a.model.station_id,e)})})})),(c=new google.maps.InfoWindow({maxWidth:500,content:t})).open(a.map,a))})}};return{getMarkerEvents:function(){return n}}}]).directive("npnStations",["$http","$log","$timeout","$url","LayerService","SettingsService","StationService","ClusterService","CacheService",function(i,c,d,u,r,o,s,p,g){return{restrict:"E",template:'<ui-gmap-markers models="regions.markers" idKey="\'name\'" coords="\'self\'" icon="\'icon\'" options="\'markerOpts\'" isLabel="true"></ui-gmap-markers><ui-gmap-markers models="stations.markers" idKey="\'station_id\'" coords="\'self\'" icon="\'icon\'" options="\'markerOpts\'" doCluster="doCluster" events="markerEvents" clusterOptions="clusterOptions"></ui-gmap-markers>',scope:{},controller:["$scope",function(l){l.doCluster=o.getSettingValue("clusterMarkers"),l.$on("setting-update-clusterMarkers",function(e,t){l.doCluster=t.value});var a=p.getDefaultClusterOptions();l.clusterOptions=angular.extend(a,{calculator:function(e,t){for(var n={text:e.length,index:1},r=0;r<a.styles.length;r++)e.length>=a.styles[r].n&&(n.index=r+1);return n}}),l.regions={markers:[]},l.stations={states:[],markers:[]},l.markerEvents=s.getMarkerEvents();var t=[],e=g.get("stations-counts-by-state");function n(e){var o=e.reduce(function(e,t){return(e[t.state]=t).number_stations=parseInt(t.number_stations),e.$min=Math.min(e.$min,t.number_stations),e.$max=Math.max(e.$max,t.number_stations),e},{$max:0,$min:0}),s=d3.scale.linear().domain([o.$min,o.$max]).range(["#F7FBFF","#08306B"]);r.resetLayers().then(function(){r.loadLayer("primary",function(e){var t,n=e.getProperty("NAME"),r=-1!=l.stations.states.indexOf(n),a=o[n],i={strokeOpacity:1,strokeColor:"#ffffff",strokeWeight:1,fillOpacity:0};return a&&!r?(a.visited=!0,i.fillOpacity=.8,i.fillColor=s(a.number_stations),i.clickable=!0,e=e.getProperty("CENTER"),t=angular.extend({name:n,icon:{path:google.maps.SymbolPath.CIRCLE,fillColor:"#000",fillOpacity:.5,scale:16,strokeColor:"#ccc",strokeWeight:1},markerOpts:{title:n+" ("+a.number_stations+" Sites)",labelClass:"station-count",labelContent:""+a.number_stations}},e),a.number_stations<10?(t.icon.scale=8,t.markerOpts.labelAnchor="4 8"):a.number_stations<100?(t.icon.scale=12,t.markerOpts.labelAnchor="8 8"):a.number_stations<1e3?(t.icon.scale=14,t.markerOpts.labelAnchor="10 8"):t.markerOpts.labelAnchor="13 8",l.$apply(function(){l.regions.markers.push(t)})):r||c.warn("no station count for "+n),i}).then(function(e){var r=e[0];t.push(r.data.addListener("mouseover",function(e){r.data.overrideStyle(e.feature,{strokeWeight:3})})),t.push(r.data.addListener("mouseout",function(e){r.data.revertStyle()})),t.push(r.data.addListener("click",function(t){var n=t.feature.getProperty("NAME");-1===l.stations.states.indexOf(n)&&(l.regions.markers=l.regions.markers.filter(function(e){return e.name!==n}),l.stations.states.push(n),d(function(){r.data.remove(t.feature),r.panTo(t.latLng);var e=0;6!=r.getZoom()&&(r.setZoom(6),e=500),d(function(){i.get(u("/npn_portal/stations/getAllStations.json"),{params:{state_code:n}}).then(function(e){e=e.data;e.forEach(function(e){e.markerOpts={title:e.station_name,icon:{path:google.maps.SymbolPath.CIRCLE,fillColor:"#e6550d",fillOpacity:1,scale:8,strokeColor:"#204d74",strokeWeight:1}}});for(var e=l.stations.markers.concat(e),t=512<e.length?Math.round(e.length/2):512,n=a.styles.length-1;0<=n;n--)a.styles[n].n=t,t=Math.round(t/2);l.stations.markers=e})},e)},500))}))})})}e?n(e):i.get(u("/npn_portal/stations/getStationCountByState.json")).then(function(e){e=e.data;g.put("stations-counts-by-state",e),n(e)}),l.$on("$destroy",function(){r.resetLayers(),t.forEach(function(e){e.remove()})})}]}}]),angular.module("npn-viz-tool.vis-time",["npn-viz-tool.vis","npn-viz-tool.filter","npn-viz-tool.filters","npn-viz-tool.settings","ui.bootstrap"]).controller("TimeSeriesVisCtrl",["$scope","$uibModalInstance","$log","$filter","$http","$url","$q","$timeout","layer","legend","latLng","ChartService",function(o,e,g,t,s,l,f,n,r,a,h,i){o.layer=r,o.legend=a,o.modal=e,o.latLng=h;var c=0,d=0,m=l("/npn_portal/stations/getTimeSeries.json"),u=new Date(r.extent.current.date),p=Math.ceil((u.getTime()-(new Date).getTime())/864e5),a=0;0<p&&(a=p);e=6-a;u.setDate(u.getDate()+e);p=u.getFullYear()+"-01-01",a=u.toISOString().split("T")[0],e="https://data.usanpn.org/geoservices";(location.hostname.includes("local")||location.hostname.includes("dev"))&&(e="https://data-dev.usanpn.org/geoservices"),"Asian Longhorned Beetle"!==r.pest&&"Gypsy Moth"!==r.pest&&"Bronze Birch Borer"!==r.pest&&"Emerald Ash Borer"!==r.pest&&"Lilac Borer"!==r.pest&&"Magnolia Scale"!==r.pest||(c=50,d=86,"Gypsy Moth"===r.pest&&(c=37.4,d=104),"Bronze Birch Borer"!==r.pest&&"Emerald Ash Borer"!==r.pest&&"Lilac Borer"!==r.pest&&"Magnolia Scale"!==r.pest||(c=50,d=150),m=e+"/v1/agdd/double-sine/pointTimeSeries"),"Eastern Tent Caterpillar"!=r.pest&&"Pine Needle Scale"!=r.pest&&"Bagworm"!=r.pest||(p=u.getFullYear()+"-03-01",c=50,m=e+"/v1/agdd/simple/pointTimeSeries");var v="yyyy-MM-dd",y=t("date"),b=t("number"),u=(new Date).getFullYear(),e=r.extent.current&&r.extent.current.date?r.extent.current.date.getFullYear():u,w=((t=new Date).setFullYear(e),t.setMonth(0),t.setDate(1),t),x=e===u,u=(u=x?new Date(r.extent.values[r.extent.values.length-1].date.getTime()):new Date,x||(u.setFullYear(e),u.setMonth(11),u.setDate(31)),u),k={latitude:h.lat(),longitude:h.lng()},_={layer:r.name,start_date:y(w,v),end_date:y(u,v),latitude:h.lat(),longitude:h.lng(),climateProvider:"NCEP",temperatureUnit:"fahrenheit",base:c,lowerThreshold:c,upperThreshold:d,timeSeriesUrl:m,startDate:p,endDate:a};k.layer="gdd:agdd"===_.layer?"gdd:30yr_avg_agdd":"gdd:30yr_avg_agdd_50f";var S="gdd:agdd"===_.layer?32:50;"Gypsy Moth"===r.pest&&(S=37.4);var $=!0;"Gypsy Moth"!==r.pest&&"Asian Longhorned Beetle"!==r.pest&&"Pine Needle Scale"!==r.pest&&"Bagworm"!==r.pest&&"Eastern Tent Caterpillar"!==r.pest&&"Emerald Ash Borer"!==r.pest&&"Bronze Birch Borer"!==r.pest&&"Lilac Borer"!==r.pest&&"Magnolia Scale"!==r.pest||($=!1),g.debug("TimeSeries.avg_params",k),g.debug("TimeSeries.params",_);function C(e){return e=(e-1)*i.ONE_DAY_MILLIS+w.getTime(),e=new Date(e),T(e)}var F,L,A,M=i.getSizeInfo({top:80,left:80}),T=d3.time.format("%m/%d"),E=d3.time.format("%b %-d"),D=d3.scale.linear().range([0,M.width]).domain([1,365]),P=d3.svg.axis().scale(D).orient("bottom").tickFormat(C),z=2e4,I=d3.scale.linear().range([M.height,0]).domain([0,z]),O=d3.svg.axis().scale(I).orient("left"),j=function(e){return null!=e.agdd?e.agdd:e.point_value},B=function(e){return e.doy},N=d3.svg.line().x(function(e,t){return D(e.doy)}).y(function(e,t){return null!=e.agdd?I(e.agdd):I(e.point_value)}).interpolate("basis"),Y={};function G(e,t){Y[e]=t,Y[e].doyMap=Y[e].data.reduce(function(e,t){return e[B(t)]=j(t),e},{})}function R(){F.selectAll(".axis path").style("fill","none").style("stroke","#000").style("shape-rendering","crispEdges"),F.selectAll(".axis line").style("fill","none").style("stroke","#000").style("shape-rendering","crispEdges"),F.selectAll("text").style("font-family","Arial");F.selectAll("g .x.axis text").style("font-size","16px"),F.selectAll("g .y.axis text").style("font-size","16px")}function V(){F.select(".legend").remove();var a=F.append("g").attr("class","legend").attr("transform","translate(30,-45)").style("font-size","1em"),e=a.append("rect").style("fill","white").style("stroke","black").style("opacity","0.8").attr("width",130).attr("height",60),t=["average","selected","forecast","previous"].reduce(function(e,t,n){var r;return Y[t]&&Y[t].plotted&&(Y[t].filtered||Y[t].data).length&&((r=a.append("g").attr("class","legend-item "+t).attr("transform","translate(10,"+(14*(e+1)+4*e)+")")).append("circle").attr("r",5).attr("fill",Y[t].color),r.append("text").style("font-size","14px").attr("x",10).attr("y",2.5).text(Y[t].year||"30-year Average"),e++),e},0);t<3?e.attr("height",45):3<t&&e.attr("height",80)}function U(e){Y[e]&&(F.selectAll("path.gdd."+e).remove(),delete Y[e].plotted,V())}function q(e){Y[e]&&(F.append("path").attr("class","gdd "+e).attr("fill","none").attr("stroke",Y[e].color).attr("stroke-linejoin","round").attr("stroke-linecap","round").attr("stroke-width",1.5).attr("d",N(Y[e].filtered||Y[e].data)),Y[e].plotted=!0,V())}function W(){var e=I(o.selection.threshold.value);L.attr("y1",e).attr("y2",e)}function H(){var e,t=Object.keys(Y);t.length&&(e=t.reduce(function(e,t){return e.push(d3.max(Y[t].filtered||Y[t].data,j)),e},[]),o.selection.threshold.options.ceil=Math.round(z=d3.max(e)),o.selection.threshold.value>o.selection.threshold.options.ceil&&(o.selection.threshold.value=o.selection.threshold.options.ceil),z*=1.05,O.scale(I.domain([0,z])),W(),P.scale(D.domain([1,o.selection.doys.value])),t.forEach(function(e){Y[e].plotted&&(U(e),q(e))})),F.selectAll("g .axis").remove(),F.append("g").attr("class","y axis").call(O).append("text").attr("transform","rotate(-90)").attr("y","0").attr("dy","-3.75em").attr("x",M.height/2*-1).style("text-anchor","middle").text("Accumulated Growing Degree Days"),F.append("g").attr("class","x axis").attr("transform","translate(0,"+M.height+")").call(P).append("text").attr("y","0").attr("dy","2.5em").attr("x",M.width/2).style("text-anchor","middle").text("Date"),R()}function J(){var t=o.selection.doys.value;365===t?Object.keys(Y).forEach(function(e){delete Y[e].filtered}):Object.keys(Y).forEach(function(e){Y[e].filtered=Y[e].data.filter(function(e){return B(e)<=t})}),H()}o.selection={lastYearValid:2016<e,showLastYear:!1,threshold:{value:"Hemlock Woolly Adelgid"===r.pest?1e3:"Emerald Ash Borer"===r.pest?450:"Winter Moth"===r.pest?20:"Lilac Borer"===r.pest?500:"Apple Maggot"===r.pest?900:"Bronze Birch Borer"===r.pest?450:"Pine Needle Scale"===r.pest?298:"Eastern Tent Caterpillar"===r.pest?90:"Gypsy Moth"===r.pest?571:"Asian Longhorned Beetle"===r.pest?690:"Bagworm"===r.pest?600:"Magnolia Scale"===r.pest?1938:1e3,options:{floor:0,ceil:z,step:10,translate:function(e){return b(e,0)+"F"}}},doys:{value:function(){var e=new Date(r.extent.current.date.getTime());if(10<e.getMonth()||!r.pest)return 365;e.setMonth(e.getMonth()+1);var t=new Date(e.getFullYear(),0,0),e=e-t+60*(t.getTimezoneOffset()-e.getTimezoneOffset())*1e3;return Math.floor(e/864e5)}(),options:{floor:1,ceil:365,step:1,translate:function(e){return function(e){e=(e-1)*i.ONE_DAY_MILLIS+w.getTime(),e=new Date(e);return E(e)}(e)+" ("+e+")"}}}},n(function(){o.$broadcast("rzSliderForceRender");var e=d3.select(".chart").attr("width",M.width+M.margin.left+M.margin.right).attr("height",M.height+M.margin.top+M.margin.bottom);e.append("g").append("rect").attr("width","100%").attr("height","100%").attr("fill","#fff");var t=(F=e.append("g").attr("transform","translate("+M.margin.left+","+M.margin.top+")")).append("g").attr("class","chart-title");t.append("text").attr("y","0").attr("dy","-3em").attr("x",M.width/2).style("text-anchor","middle").style("font-size","18px").text("Accumulated Growing Degree Days"),t.append("text").attr("y","0").attr("dy","-1.8em").attr("x",M.width/2).style("text-anchor","middle").style("font-size","18px").text("(Lat: "+b(h.lat())+", Lon: "+b(h.lng())+") "+S+"F Base Temp"),H(),e.append("g").append("text").attr("dx",5).attr("dy",M.height+136).attr("font-size","11px").attr("font-style","italic").attr("text-anchor","right").text("USA National Phenology Network, www.usanpn.org"),L=F.append("line").attr("class","threshold").attr("fill","none").attr("stroke","green").attr("stroke-width",1).attr("x1",D(1)).attr("y1",I(z)).attr("x2",D(365)).attr("y2",I(z));var a=e.append("g").attr("transform","translate("+M.margin.left+","+M.margin.top+")").style("display","none"),n=a.append("line").attr("class","focus").attr("fill","none").attr("stroke","green").attr("stroke-width",1).attr("x1",D(1)).attr("y1",I(0)).attr("x2",D(1)).attr("y2",I(z)),r=a.append("text").attr("class","gdd-info").attr("font-size",16).attr("y",40),t=r.append("tspan").attr("dy","1em").attr("x",15),i=(t.append("tspan").attr("class","gdd-label").text("DOY: "),t.append("tspan").attr("class","gdd-value")),t=["average","previous","selected","forecast"],c=t.reduce(function(e,t){return e[t]=r.append("tspan").attr("dy","1.2em").attr("x",15),e},{}),d=t.reduce(function(e,t){return e[t]=c[t].append("tspan").attr("class","gdd-label "+t),e},{}),u=t.reduce(function(e,t){return e[t]=c[t].append("tspan").attr("class","gdd-value"),e},{}),p=["previous","forecast","selected"].reduce(function(e,t){return e[t]=c[t].append("tspan").attr("class","gdd-diff"),e},{});e.append("rect").attr("class","overlay").attr("transform","translate("+M.margin.left+","+M.margin.top+")").style("fill","none").style("pointer-events","all").attr("x",0).attr("y",0).attr("width",D(365)).attr("height",I(0)).on("mouseover",function(){a.style("display",null)}).on("mouseout",function(){a.style("display","none")}).on("mousemove",function(){var s,r=(e=d3.mouse(this))[0],l=(e[1],Math.round(D.invert(r))),e=Object.keys(Y);n.attr("transform","translate("+r+")"),s=e.reduce(function(e,t){var n;return Y[t].plotted&&(void 0!==(n=Y[t].doyMap[l])?(e[t]={year:Y[t].year,gdd:n},Y[t].focus||(Y[t].focus=a.append("circle").attr("r",4.5).attr("fill","none").attr("stroke","steelblue")),Y[t].focus.style("display",null).attr("transform","translate("+r+","+I(n)+")")):Y[t].focus&&Y[t].focus.style("display","none")),e},{}),g.debug("temps for doy "+l,s),i.text(l+" ("+C(l)+")"),Object.keys(c).forEach(function(e){var t,n,r,a,i,o;if(s[e]){if(c[e].style("display",null),d[e].text((s[e].year||"30-year Average")+": "),t=s[e].gdd,u[e].text(b(t,0)+" GDD"),p[e]&&null!=s.average){for(i=" ("+(0<(n=t-s.average.gdd)?"+":"")+b(n,0)+" GDD",o=0;o<Y.average.data.length;o++)if(j(Y.average.data[o])>t){r=B(Y.average.data[o]);break}0<r&&r<366&&(i+="/"+(0<(a=r-l)?"+":"")+a+" days"),i+=")",p[e].attr("class","gdd-diff "+(0<n?"above":"below")).text(i)}}else c[e].style("display","none")})}),R(),o.$watch("selection.threshold.value",W),o.working=!0,f.all({average:s.get(l("/npn_portal/stations/getTimeSeries.json"),{params:k}),selected:s.get(m,{params:_})}).then(function(e){var n,t;null!=e.selected.data.timeSeries&&(e.selected.data=e.selected.data.timeSeries),x?(n=y(new Date,"yyyy-MM-dd"),(t=e.selected.data.reduce(function(e,t){return e.forecast?e.forecast.push(t):(e.selected.push(t),t.date===n&&(e.forecast=[t])),e},{selected:[]})).forecast||(t.forecast=[]),G("selected",{year:w.getFullYear(),color:"blue",data:t.selected}),G("forecast",{year:w.getFullYear()+" forecast",color:"red",data:t.forecast})):G("selected",{year:w.getFullYear(),color:"blue",data:e.selected.data}),$&&G("average",{color:"black",data:e.average.data}),g.debug("draw",Y),J(),H(),$&&q("average"),q("selected"),x&&q("forecast"),R(),delete o.working})}),o.$watch("selection.doys.value",function(e,t){e!==t&&(A&&n.cancel(A),A=n(J,500))}),o.selection.lastYearValid&&o.$watch("selection.showLastYear",function(e){var t,n,r,a;e&&!Y.previous?(o.working=!0,t=new Date(w.getTime()),n=new Date(w.getTime()),t.setFullYear(t.getFullYear()-1),n.setFullYear(t.getFullYear()),n.setMonth(11),n.setDate(31),r=_.startDate.split("-"),a=_.endDate.split("-"),r=r[0]-1+"-"+r[1]+"-"+r[2],a=a[0]-1+"-12-31",a=angular.extend({},_,{start_date:y(t,v),end_date:y(n,v),startDate:r,endDate:a}),console.log(JSON.stringify(a)),g.debug("previous_params",a),s.get(m,{params:a}).then(function(e){null!=e.data.timeSeries&&(e.data=e.data.timeSeries),G("previous",{year:t.getFullYear(),color:"orange",data:e.data}),J(),H(),R(),q("previous"),delete o.working})):Y.previous&&(e?q:U)("previous")})}]).provider("$timeSeriesVis",[function(){this.$get=["ChartService",function(r){return function(e,t,n){r.openVisualization({title:"Daily Accumulation",noFilterRequired:!0,template:"js/time/time.html",controller:"TimeSeriesVisCtrl"},{layer:function(){return e},legend:function(){return t},latLng:function(){return n}})}}]}]),angular.module("npn-viz-tool.toolbar",["npn-viz-tool.help"]).directive("toolbar",["$rootScope","$timeout","HelpService",function(a,i,o){return{restrict:"E",templateUrl:"js/toolbar/toolbar.html",transclude:!0,scope:{},controller:["$scope",function(t){var n=t.tools=[];function r(e){a.$broadcast("tool-"+(e.selected?"open":"close"),{tool:e}),e.selected&&i(function(){a.$broadcast("rzSliderForceRender")},500)}t.select=function(e){e.selected=!e.selected,t.open=e.selected,o.stopLookingAtMe("#toolbar-icon-"+e.id),r(e)},this.addTool=function(e){n.push(e)},this.closeTool=function(e){t.open=e.selected=!1,r(e)}}]}}]).directive("tool",[function(){return{restrict:"E",require:"^toolbar",templateUrl:"js/toolbar/tool.html",transclude:!0,scope:{id:"@",title:"@",icon:"@"},link:function(e,t,n,r){r.addTool(e),e.close=function(){r.closeTool(e)}}}}]),angular.module("npn-viz-tool.vis",["npn-viz-tool.filter","npn-viz-tool.filters","npn-viz-tool.vis-scatter","npn-viz-tool.vis-calendar","npn-viz-tool.vis-map","npn-viz-tool.vis-time","npn-viz-tool.vis-activity","ui.bootstrap"]).factory("ChartService",["$window","$http","$log","$uibModal","$url","FilterService","SettingsService","Analytics",function(r,n,o,a,s,i,l,c){var t,d={top:20,right:30,bottom:60,left:40},e=[{title:"Scatter Plots",controller:"ScatterVisCtrl",template:"js/scatter/scatter.html",description:"This visualization plots selected geographic or seasonal climatic variables against estimated onset dates at a site to region for individuals or sites for up to three species, phenophases or years."},{title:"Calendars",controller:"CalendarVisCtrl",template:"js/calendar/calendar.html",description:"This visualization illustrates the daily timing of phenological activity for selected species and phenophases. Horizontal bars represent the annual patterns at a site to region for up to two years."},{title:"Activity Curves",controller:"ActivityCurvesVisCtrl",template:"js/activity/activity.html",description:"This visualization plots annual patterns of the timing and magnitude of phenological activity, based on proportion of yes records, animal abundances per hour and other metrics. Data are summarized at a weekly, biweekly or monthly scale for one or more sites,  for up to two species, phenophases, or years."},{title:"Maps",controller:"MapVisCtrl",template:"js/mapvis/mapvis.html",description:"This visualization maps ground-based observations overlaid with USA-NPN phenology maps, including Accumulated Growing Degree Days and Spring Index models.",singleStation:!1}];function u(e){var t=0===e.latitude||0===e.longitude||e.elevation_in_meters<0;return t&&o.warn("suspect station data",e),!t}function p(e){var t=0<=e.numdays_since_prior_no;return t||o.debug("filtering less precise data from summary output",e),t}function g(e){var t=0<=e.mean_numdays_since_prior_no;return t||o.debug("filtering less precise data from site level output",e),t}function f(n){var e;return t?n["station_id[0]"]=t:((e=i.getFilter()).getGeographicArgs().length&&i.getFilteredMarkers().forEach(function(e,t){n["station_id["+t+"]"]=e.station_id}),e.getNetworkArgs().forEach(function(e,t){n["network["+t+"]"]=e.getName(),n["network_id["+t+"]"]=e.getId()})),n}function h(e){var t,n=[];for(t in e)n.push(encodeURIComponent(t)+"="+encodeURIComponent(e[t]));return n.join("&")}function m(e){t=e}var v={ONE_DAY_MILLIS:864e5,getSizeInfo:function(e){var t=angular.extend({},d,e),n=Math.round(.9*r.innerWidth),e=Math.round(.5376*n),t={width:n-t.left-t.right,height:e-t.top-t.bottom,margin:t};return o.debug("sizing",t),t},leastSquares:function(e,n){if(0===e.length||0===n.length)return[Number.NaN,Number.NaN,Number.NaN];var t=function(e,t){return e+t},r=+e.reduce(t)/e.length,a=+n.reduce(t)/n.length,i=e.map(function(e){return Math.pow(e-r,2)}).reduce(t),o=n.map(function(e){return Math.pow(e-a,2)}).reduce(t),e=e.map(function(e,t){return(e-r)*(n[t]-a)}).reduce(t),t=e/i;return[t,a-r*t,Math.pow(e,2)/(i*o)]},approxY:function(e,t){return e[1]+e[0]*t},getMagnitudeData:function(e,t){n({method:"POST",url:s("/npn_portal/observations/getMagnitudeData.json"),headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:h,data:f(e)}).then(function(e){t(e.data)})},getSiteLevelData:function(e,r){e.num_days_quality_filter=l.getSettingValue("dataPrecisionFilter"),n({method:"POST",url:s("/npn_portal/observations/getSiteLevelData.json"),headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:h,data:f(e)}).then(function(e){var t=e.data,n=t.filter(u),e=n.filter(l.getSettingValue("filterLqdSummary")?g:angular.identity);o.debug("filtered out "+(t.length-n.length)+"/"+t.length+" suspect records"),o.debug("filtered out "+(n.length-e.length)+"/"+n.length+" LQD records."),r(e,n.length!==e.length)})},getSummarizedData:function(e,i){n({method:"POST",url:s("/npn_portal/observations/getSummarizedData.json"),headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:h,data:f(e)}).then(function(e){var t=e.data,n=t.filter(u),r=n.filter(l.getSettingValue("filterLqdSummary")?p:angular.identity),e=r.reduce(function(e,t){var n=t.individual_id+"/"+t.phenophase_id+"/"+t.first_yes_year;return e[n]=e[n]||[],e[n].push(t),e},{}),a=[];o.debug("filtered out "+(t.length-n.length)+"/"+t.length+" suspect records"),o.debug("filtered out "+(n.length-r.length)+"/"+n.length+" LQD records."),angular.forEach(e,function(e,t){1<e.length&&e.sort(function(e,t){return e.first_yes_doy-t.first_yes_doy}),a.push(e[0])}),o.debug("filtered out "+(r.length-a.length)+"/"+r.length+" individual records (preferring lowest first_yes_doy)"),i(a,n.length!==r.length)})},getObservationDates:function(e,t){n({method:"POST",url:s("/npn_portal/observations/getObservationDates.json"),headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:h,data:f(e)}).then(function(e){t(e.data)})},isFilterEmpty:i.isFilterEmpty,getVisualizations:function(){return e},openSingleStationVisualization:function(e,t){m(e);t=v.openVisualization(t);t?t.result.then(m,m):m()},openVisualization:function(e,t){if(e.noFilterRequired||!i.isFilterEmpty()){var n={templateUrl:e.template,controller:e.controller,windowClass:"vis-dialog-window",backdrop:"static",keyboard:!1,size:"lg"};return t&&(n.resolve=t),c.trackEvent("visualization","open",e.title),a.open(n)}}};return v}]).directive("visDialog",[function(){return{restrict:"E",templateUrl:"js/vis/visDialog.html",transclude:!0,scope:{title:"@",modal:"="},controller:["$scope",function(e){}]}}]).directive("visControl",["ChartService",function(t){return{restrict:"E",templateUrl:"js/vis/visControl.html",scope:{},link:function(e){e.isFilterEmpty=t.isFilterEmpty,e.open=t.openVisualization,e.visualizations=t.getVisualizations()}}}]).directive("visDownload",[function(){return{restrict:"E",templateUrl:"js/vis/visDownload.html",scope:{selector:"@",filename:"@"},controller:["$scope",function(i){i.download=function(){var e=d3.select(i.selector),t=e.attr("version",1.1).attr("xmlns","http://www.w3.org/2000/svg").node().parentNode.innerHTML,n=document.querySelector("#visDownloadCanvas");n.width=e.attr("width"),n.height=e.attr("height");var t=encodeURIComponent(t).replace(/%([0-9A-F]{2})/g,function(e,t){return String.fromCharCode("0x"+t)}),t="data:image/svg+xml;base64,"+window.btoa(t),r=n.getContext("2d"),a=new Image;a.onload=function(){r.drawImage(a,0,0);var e=n.toDataURL("image/png"),t=$("#vis-download-link")[0];t.download=i.filename||"visualization.png",t.href=e,t.click()},a.src=t}}]}}]);